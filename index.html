<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"4c4e88e0"}),daovoice("update")</script><script src="https://cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="keywords" content="Hexo, NexT"><link rel="alternate" href="/atom.xml" title="大鹏的博客" type="application/atom+xml"><meta name="description" content="人生不止眼前的苟且，还有诗和远方的田野"><meta property="og:type" content="website"><meta property="og:title" content="大鹏的博客"><meta property="og:url" content="https://zhangyapeng0222.github.io/person_blogs/index.html"><meta property="og:site_name" content="大鹏的博客"><meta property="og:description" content="人生不止眼前的苟且，还有诗和远方的田野"><meta property="og:locale" content="zh-Hans"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="大鹏的博客"><meta name="twitter:description" content="人生不止眼前的苟且，还有诗和远方的田野"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://zhangyapeng0222.github.io/person_blogs/"><title>大鹏的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?5bad22218259d1cb764a37744176e1bb";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>function loadCss(t){var s=document,i=s.head,o=s.createElement("link");o.rel="stylesheet",o.href=t,function t(i){if(s.body)return i();setTimeout(function(){t(i)})}(function(){i.appendChild(o)})}loadCss("/style.css"),loadCss("https://cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"),loadCss("//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"),loadCss("https://cdn.jsdelivr.net/npm/font-awesome@4.6.3/css/font-awesome.min.css")</script><style>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}::selection{background:#262a30;color:#fff}body{position:relative;font-family:Monda,"PingFang SC","Microsoft YaHei",sans-serif;font-size:14px;line-height:2;color:#555;background:#f5f7f9}@media (max-width:767px){body{padding-right:0!important}}@media (min-width:768px) and (max-width:991px){body{padding-right:0!important}}@media (min-width:1600px){body{font-size:16px}}h1,h2,h3,h4,h5,h6{margin:0;padding:0;font-weight:700;line-height:1.5;font-family:'Roboto Slab',Monda,"PingFang SC","Microsoft YaHei",sans-serif}h2,h3,h4,h5,h6{margin:20px 0 15px}h1{font-size:22px}@media (max-width:767px){h1{font-size:18px}}h2{font-size:20px}@media (max-width:767px){h2{font-size:16px}}h3{font-size:18px}@media (max-width:767px){h3{font-size:14px}}h4{font-size:16px}@media (max-width:767px){h4{font-size:12px}}h5{font-size:14px}@media (max-width:767px){h5{font-size:10px}}h6{font-size:12px}@media (max-width:767px){h6{font-size:8px}}p{margin:0 0 20px 0}a{color:#555;text-decoration:none;outline:0;border-bottom:1px solid #999;word-wrap:break-word}a:hover{color:#222;border-bottom-color:#222}blockquote{margin:0;padding:0}img{display:block;margin:auto;max-width:100%;height:auto}hr{margin:40px 0;height:3px;border:none;background-color:#ddd;background-image:repeating-linear-gradient(-45deg,#fff,#fff 4px,transparent 4px,transparent 8px)}blockquote{padding:0 15px;color:#666;border-left:4px solid #ddd}blockquote cite::before{content:"-";padding:0 5px}dt{font-weight:700}dd{margin:0;padding:0}kbd{border:1px solid #ccc;border-radius:.2em;box-shadow:.1em .1em .2em rgba(0,0,0,.1);background-color:#f9f9f9;font-family:inherit;background-image:-webkit-linear-gradient(top,#eee,#fff,#eee);padding:.1em .3em;white-space:nowrap}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-justify{text-align:justify}.text-nowrap{white-space:nowrap}.text-lowercase{text-transform:lowercase}.text-uppercase{text-transform:uppercase}.text-capitalize{text-transform:capitalize}.center-block{display:block;margin-left:auto;margin-right:auto}.clearfix:after,.clearfix:before{content:" ";display:table}.clearfix:after{clear:both}.pullquote{width:45%}.pullquote.left{float:left;margin-left:5px;margin-right:10px}.pullquote.right{float:right;margin-left:10px;margin-right:5px}.affix.affix.affix{position:fixed}.translation{margin-top:-20px;font-size:14px;color:#999}.scrollbar-measure{width:100px;height:100px;overflow:scroll;position:absolute;top:-9999px}.use-motion .motion-element{opacity:0}table{margin:20px 0;width:100%;border-collapse:collapse;border-spacing:0;border:1px solid #ddd;font-size:14px;table-layout:fixed;word-wrap:break-all}table>tbody>tr:nth-of-type(odd){background-color:#f9f9f9}table>tbody>tr:hover{background-color:#f5f5f5}caption,td,th{padding:8px;text-align:left;vertical-align:middle;font-weight:400}td,th{border-bottom:3px solid #ddd;border-right:1px solid #eee}th{padding-bottom:10px;font-weight:700}td{border-bottom-width:1px}body,html{height:100%}.container{position:relative;min-height:100%}.header-inner{margin:0 auto;padding:100px 0 70px;width:700px}@media (min-width:1600px){.container .header-inner{width:900px}}.main{padding-bottom:150px}.main-inner{margin:0 auto;width:700px}@media (min-width:1600px){.container .main-inner{width:900px}}.footer{position:absolute;left:0;bottom:0;width:100%;min-height:50px}.footer-inner{box-sizing:border-box;margin:20px auto;width:700px}@media (min-width:1600px){.container .footer-inner{width:900px}}.highlight,pre{overflow:auto;margin:20px 0;padding:0;font-size:13px;color:#ccc;background:#2d2d2d;line-height:1.6}code,pre{font-family:'PT Mono',consolas,Menlo,"PingFang SC","Microsoft YaHei",monospace}code{padding:2px 4px;word-wrap:break-word;color:#555;background:#eee;border-radius:3px;font-size:13px}pre{padding:10px}pre code{padding:0;color:#ccc;background:0 0;text-shadow:none}.highlight{border-radius:1px}.highlight pre{border:none;margin:0;padding:10px 0}.highlight table{margin:0;width:auto;border:none}.highlight td{border:none;padding:0}.highlight figcaption{font-size:1em;color:#ccc;line-height:1em;margin-bottom:1em}.highlight figcaption:after,.highlight figcaption:before{content:" ";display:table}.highlight figcaption:after{clear:both}.highlight figcaption a{float:right;color:#ccc}.highlight figcaption a:hover{border-bottom-color:#ccc}.highlight .gutter pre{padding-left:10px;padding-right:10px;color:#999;text-align:right;background-color:#1b1b1b}.highlight .code pre{width:100%;padding-left:10px;padding-right:10px;background-color:#2d2d2d}.highlight .line{height:20px}.gutter{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.gist table{width:auto}.gist table td{border:none}pre .deletion{background:green}pre .addition{background:maroon}pre .meta{color:#c9c}pre .comment{color:#999}pre .attribute,pre .css .class,pre .css .id,pre .css .pseudo,pre .html .doctype,pre .regexp,pre .ruby .constant,pre .tag,pre .variable,pre .xml .doctype,pre .xml .pi,pre .xml .tag .title{color:#f2777a}pre .built_in,pre .command,pre .constant,pre .literal,pre .number,pre .params,pre .preprocessor{color:#f99157}pre .css .rules .attribute,pre .formula,pre .header,pre .inheritance,pre .number,pre .ruby .class .title,pre .ruby .symbol,pre .special,pre .string,pre .value,pre .xml .cdata{color:#9c9}pre .css .hexcolor,pre .title{color:#6cc}pre .coffeescript .title,pre .function,pre .javascript .title,pre .perl .sub,pre .python .decorator,pre .python .title,pre .ruby .function .title,pre .ruby .title .keyword{color:#69c}pre .javascript .function,pre .keyword{color:#c9c}.full-image.full-image.full-image.full-image{border:none;max-width:100%;width:auto;margin:20px auto 25px}@media (min-width:992px){.full-image.full-image.full-image.full-image{max-width:none;width:118%;margin:0 -9%}}.blockquote-center,.page-home .post-type-quote blockquote,.page-post-detail .post-type-quote blockquote{position:relative;margin:40px 0;padding:0;border-left:none;text-align:center}.blockquote-center::after,.blockquote-center::before,.page-home .post-type-quote blockquote::after,.page-home .post-type-quote blockquote::before,.page-post-detail .post-type-quote blockquote::after,.page-post-detail .post-type-quote blockquote::before{position:absolute;content:' ';display:block;width:100%;height:24px;opacity:.2;background-repeat:no-repeat;background-position:0 -6px;background-size:22px 22px}.blockquote-center::before,.page-home .post-type-quote blockquote::before,.page-post-detail .post-type-quote blockquote::before{top:-20px;background-image:url(../images/quote-l.svg);border-top:1px solid #ccc}.blockquote-center::after,.page-home .post-type-quote blockquote::after,.page-post-detail .post-type-quote blockquote::after{bottom:-20px;background-image:url(../images/quote-r.svg);border-bottom:1px solid #ccc;background-position:100% 8px}.blockquote-center div,.blockquote-center p,.page-home .post-type-quote blockquote div,.page-home .post-type-quote blockquote p,.page-post-detail .post-type-quote blockquote div,.page-post-detail .post-type-quote blockquote p{text-align:center}.post .post-body .group-picture img{box-sizing:border-box;padding:0 3px;border:none}.post .group-picture-row{overflow:hidden;margin-top:6px}.post .group-picture-row:first-child{margin-top:0}.post .group-picture-column{float:left}.page-post-detail .post-body .group-picture-column{float:none;margin-top:10px;width:auto!important}.page-post-detail .post-body .group-picture-column img{margin:0 auto}.page-archive .group-picture-container{overflow:hidden}.page-archive .group-picture-row{float:left}.page-archive .group-picture-row:first-child{margin-top:6px}.page-archive .group-picture-column{max-width:150px;max-height:150px}.post-body .note{position:relative;padding:15px;margin-bottom:20px;border:1px solid #eee;border-left-width:5px;border-radius:3px}.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6{margin-top:0;margin-bottom:0;border-bottom:initial;padding-top:0!important}.post-body .note blockquote:first-child,.post-body .note ol:first-child,.post-body .note p:first-child,.post-body .note pre:first-child,.post-body .note table:first-child,.post-body .note ul:first-child{margin-top:0}.post-body .note blockquote:last-child,.post-body .note ol:last-child,.post-body .note p:last-child,.post-body .note pre:last-child,.post-body .note table:last-child,.post-body .note ul:last-child{margin-bottom:0}.post-body .note.default{border-left-color:#777}.post-body .note.default h2,.post-body .note.default h3,.post-body .note.default h4,.post-body .note.default h5,.post-body .note.default h6{color:#777}.post-body .note.primary{border-left-color:#6f42c1}.post-body .note.primary h2,.post-body .note.primary h3,.post-body .note.primary h4,.post-body .note.primary h5,.post-body .note.primary h6{color:#6f42c1}.post-body .note.info{border-left-color:#428bca}.post-body .note.info h2,.post-body .note.info h3,.post-body .note.info h4,.post-body .note.info h5,.post-body .note.info h6{color:#428bca}.post-body .note.success{border-left-color:#5cb85c}.post-body .note.success h2,.post-body .note.success h3,.post-body .note.success h4,.post-body .note.success h5,.post-body .note.success h6{color:#5cb85c}.post-body .note.warning{border-left-color:#f0ad4e}.post-body .note.warning h2,.post-body .note.warning h3,.post-body .note.warning h4,.post-body .note.warning h5,.post-body .note.warning h6{color:#f0ad4e}.post-body .note.danger{border-left-color:#d9534f}.post-body .note.danger h2,.post-body .note.danger h3,.post-body .note.danger h4,.post-body .note.danger h5,.post-body .note.danger h6{color:#d9534f}.post-body .label{display:inline;padding:0 2px;white-space:nowrap}.post-body .label.default{background-color:#f0f0f0}.post-body .label.primary{background-color:#efe6f7}.post-body .label.info{background-color:#e5f2f8}.post-body .label.success{background-color:#e7f4e9}.post-body .label.warning{background-color:#fcf6e1}.post-body .label.danger{background-color:#fae8eb}.post-body .tabs{position:relative;display:block;margin-bottom:20px;padding-top:10px}.post-body .tabs ul.nav-tabs{margin:0;padding:0;display:flex;margin-bottom:-1px}@media (max-width:413px){.post-body .tabs ul.nav-tabs{display:block;margin-bottom:5px}}.post-body .tabs ul.nav-tabs li.tab{list-style-type:none!important;margin:0 .25em 0 0;border-top:3px solid transparent;border-left:1px solid transparent;border-right:1px solid transparent}@media (max-width:413px){.post-body .tabs ul.nav-tabs li.tab{margin:initial;border-top:1px solid transparent;border-left:3px solid transparent;border-right:1px solid transparent;border-bottom:1px solid transparent}}.post-body .tabs ul.nav-tabs li.tab a{outline:0;border-bottom:initial;display:block;line-height:1.8em;padding:.25em .75em;transition-duration:.2s;transition-timing-function:ease-out;transition-delay:0s}.post-body .tabs ul.nav-tabs li.tab a i{width:1.285714285714286em}.post-body .tabs ul.nav-tabs li.tab.active{border-top:3px solid #fc6423;border-left:1px solid #ddd;border-right:1px solid #ddd;background-color:#fff}@media (max-width:413px){.post-body .tabs ul.nav-tabs li.tab.active{border-top:1px solid #ddd;border-left:3px solid #fc6423;border-right:1px solid #ddd;border-bottom:1px solid #ddd}}.post-body .tabs ul.nav-tabs li.tab.active a{cursor:default;color:#555}.post-body .tabs .tab-content{background-color:#fff}.post-body .tabs .tab-content .tab-pane{border:1px solid #ddd;padding:20px 20px 0 20px}.post-body .tabs .tab-content .tab-pane:not(.active){display:none!important}.post-body .tabs .tab-content .tab-pane.active{display:block!important}.btn{display:inline-block;padding:0 20px;font-size:14px;color:#555;background:#fff;border:2px solid #555;text-decoration:none;border-radius:2px;transition-property:background-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;line-height:2}.btn:hover{border-color:#222;color:#fff;background:#222}.btn+.btn{margin:0 0 8px 8px}.btn .fa-fw{width:1.285714285714286em;text-align:left}.btn-bar{display:block;width:22px;height:2px;background:#555;border-radius:1px}.btn-bar+.btn-bar{margin-top:4px}.pagination{margin:120px 0 40px;text-align:center;border-top:1px solid #eee}.page-number-basic,.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{display:inline-block;position:relative;top:-1px;margin:0 10px;padding:0 11px}@media (max-width:767px){.page-number-basic,.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{margin:0 5px}}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:0;border-top:1px solid #eee;transition-property:border-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-top-color:#222}.pagination .space{padding:0;margin:0}.pagination .prev{margin-left:0}.pagination .next{margin-right:0}.pagination .page-number.current{color:#fff;background:#ccc;border-top-color:#ccc}@media (max-width:767px){.pagination{border-top:none}.pagination .next,.pagination .page-number,.pagination .prev{margin-bottom:10px;border-top:0;border-bottom:1px solid #eee;padding:0 10px}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-bottom-color:#222}}.comments{margin:60px 20px 0}.tag-cloud{text-align:center}.tag-cloud a{display:inline-block;margin:10px}.back-to-top{box-sizing:border-box;position:fixed;bottom:-100px;right:30px;z-index:1050;padding:0 6px;width:24px;background:#222;font-size:12px;opacity:.6;color:#fff;cursor:pointer;text-align:center;-webkit-transform:translateZ(0);transition-property:bottom;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}@media (min-width:768px) and (max-width:991px){.back-to-top{display:none!important}}@media (max-width:767px){.back-to-top{display:none!important}}.back-to-top.back-to-top-on{bottom:30px}.header{background:0 0}.header-inner{position:relative}.headband{height:3px;background:#222}.site-meta{margin:0;text-align:center}@media (max-width:767px){.site-meta{text-align:center}}.brand{position:relative;display:inline-block;padding:0 40px;color:#fff;background:#222;border-bottom:none}.brand:hover{color:#fff}.logo{display:inline-block;margin-right:5px;line-height:36px;vertical-align:top}.site-title{display:inline-block;vertical-align:top;line-height:36px;font-size:24px;font-weight:400;font-family:'Lobster Two',Monda,"PingFang SC","Microsoft YaHei",sans-serif}.site-subtitle{margin-top:10px;font-size:13px;color:#ddd}.use-motion .brand{opacity:0}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:0;position:relative;top:-10px}.site-nav-toggle{display:none;position:absolute;top:10px;left:10px}@media (max-width:767px){.site-nav-toggle{display:block}}.site-nav-toggle button{margin-top:2px;padding:9px 10px;background:0 0;border:none}@media (max-width:767px){.site-nav{display:none;margin:0 -10px;padding:0 10px;clear:both;border-top:1px solid #ddd}}@media (min-width:768px) and (max-width:991px){.site-nav{display:block!important}}@media (min-width:992px){.site-nav{display:block!important}}.menu{margin-top:20px;padding-left:0;text-align:center}.menu .menu-item{display:inline-block;margin:0 10px;list-style:none}@media screen and (max-width:767px){.menu .menu-item{margin-top:10px}}.menu .menu-item a{display:block;font-size:13px;line-height:inherit;border-bottom:1px solid transparent;transition-property:border-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.menu .menu-item a:hover,.menu-item-active a{border-bottom-color:#222}.menu .menu-item .fa{margin-right:5px}.use-motion .menu-item{opacity:0}.post-body{font-family:Monda,"PingFang SC","Microsoft YaHei",sans-serif}@media (max-width:767px){.post-body{word-break:break-word}}.post-body .fancybox img{display:block!important;margin:0 auto;cursor:pointer;cursor:zoom-in;cursor:-webkit-zoom-in}.post-body .figure .caption,.post-body .image-caption{margin:-20px auto 15px;text-align:center;font-size:14px;color:#999;font-weight:700;line-height:1}.post-sticky-flag{display:inline-block;font-size:16px;-ms-transform:rotate(30deg);-webkit-transform:rotate(30deg);-moz-transform:rotate(30deg);-ms-transform:rotate(30deg);-o-transform:rotate(30deg);transform:rotate(30deg)}.use-motion .comments,.use-motion .pagination,.use-motion .post-block{opacity:0}.use-motion .post-header{opacity:0}.use-motion .post-body{opacity:0}.use-motion .collection-title{opacity:0}.posts-expand{padding-top:40px}@media (max-width:767px){.posts-expand{margin:0 20px}.post-body pre .gutter pre{padding-right:10px}.post-body .highlight{margin-left:0;margin-right:0;padding:0}.post-body .highlight .gutter pre{padding-right:10px}}@media (min-width:992px){.posts-expand .post-body{text-align:justify}}.posts-expand .post-body h2,.posts-expand .post-body h3,.posts-expand .post-body h4,.posts-expand .post-body h5,.posts-expand .post-body h6{padding-top:10px}.posts-expand .post-body h2 .header-anchor,.posts-expand .post-body h3 .header-anchor,.posts-expand .post-body h4 .header-anchor,.posts-expand .post-body h5 .header-anchor,.posts-expand .post-body h6 .header-anchor{float:right;margin-left:10px;color:#ccc;border-bottom-style:none;visibility:hidden}.posts-expand .post-body h2 .header-anchor:hover,.posts-expand .post-body h3 .header-anchor:hover,.posts-expand .post-body h4 .header-anchor:hover,.posts-expand .post-body h5 .header-anchor:hover,.posts-expand .post-body h6 .header-anchor:hover{color:inherit}.posts-expand .post-body h2:hover .header-anchor,.posts-expand .post-body h3:hover .header-anchor,.posts-expand .post-body h4:hover .header-anchor,.posts-expand .post-body h5:hover .header-anchor,.posts-expand .post-body h6:hover .header-anchor{visibility:visible}.posts-expand .post-body ul li{list-style:circle}.posts-expand .post-body img{box-sizing:border-box;margin:auto;padding:3px;border:1px solid #ddd}.posts-expand .post-body .fancybox img{margin:0 auto 25px}@media (max-width:767px){.posts-collapse{margin:0 20px}.posts-collapse .post-meta,.posts-collapse .post-title{display:block;width:auto;text-align:left}}.posts-collapse{position:relative;z-index:1010;margin-left:55px}.posts-collapse::after{content:" ";position:absolute;top:20px;left:0;margin-left:-2px;width:4px;height:100%;background:#f5f5f5;z-index:-1}@media (max-width:767px){.posts-collapse{margin:0 20px}}.posts-collapse .collection-title{position:relative;margin:60px 0}.posts-collapse .collection-title h1,.posts-collapse .collection-title h2{margin-left:20px}.posts-collapse .collection-title small{color:#bbb;margin-left:5px}.posts-collapse .collection-title::before{content:" ";position:absolute;left:0;top:50%;margin-left:-4px;margin-top:-4px;width:8px;height:8px;background:#bbb;border-radius:50%}.posts-collapse .post{margin:30px 0}.posts-collapse .post-header{position:relative;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;transition-property:border;border-bottom:1px dashed #ccc}.posts-collapse .post-header::before{content:" ";position:absolute;left:0;top:12px;width:6px;height:6px;margin-left:-4px;background:#bbb;border-radius:50%;border:1px solid #fff;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;transition-property:background}.posts-collapse .post-header:hover{border-bottom-color:#666}.posts-collapse .post-header:hover::before{background:#222}.posts-collapse .post-meta{position:absolute;font-size:12px;left:20px;top:5px}.posts-collapse .post-comments-count{display:none}.posts-collapse .post-title{margin-left:60px;font-size:16px;font-weight:400;line-height:inherit}.posts-collapse .post-title::after{margin-left:3px;opacity:.6}.posts-collapse .post-title a{color:#666;border-bottom:none}.page-home .post-type-quote .post-header,.page-home .post-type-quote .post-tags,.page-post-detail .post-type-quote .post-header,.page-post-detail .post-type-quote .post-tags{display:none}.posts-expand .post-title{text-align:center;word-break:break-word;font-weight:400}.posts-expand .post-title-link{display:inline-block;position:relative;color:#555;border-bottom:none;line-height:1.2;vertical-align:top}.posts-expand .post-title-link::before{content:"";position:absolute;width:100%;height:2px;bottom:0;left:0;background-color:#000;visibility:hidden;-webkit-transform:scaleX(0);-moz-transform:scaleX(0);-ms-transform:scaleX(0);-o-transform:scaleX(0);transform:scaleX(0);transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.posts-expand .post-title-link:hover::before{visibility:visible;-webkit-transform:scaleX(1);-moz-transform:scaleX(1);-ms-transform:scaleX(1);-o-transform:scaleX(1);transform:scaleX(1)}.posts-expand .post-title-link .fa{font-size:16px}.posts-expand .post-meta{margin:3px 0 60px 0;color:#999;font-family:Monda,"PingFang SC","Microsoft YaHei",sans-serif;font-size:12px;text-align:center}.posts-expand .post-meta .post-category-list{display:inline-block;margin:0;padding:3px}.posts-expand .post-meta .post-category-list-link{color:#999}.posts-expand .post-meta .post-description{font-size:14px;margin-top:2px}.post-meta-divider{margin:0 .5em}.post-meta-item-icon{margin-right:3px}@media (min-width:768px) and (max-width:991px){.post-meta-item-icon{display:inline-block}}@media (max-width:767px){.post-meta-item-icon{display:inline-block}}@media (min-width:768px) and (max-width:991px){.post-meta-item-text{display:none}}@media (max-width:767px){.post-meta-item-text{display:none}}@media (max-width:767px){.posts-expand .post-comments-count{display:none}}.post-button{margin-top:40px}.posts-expand .post-tags{margin-top:40px;text-align:center}.posts-expand .post-tags a{display:inline-block;margin-right:10px;font-size:13px}.post-nav{display:table;margin-top:15px;width:100%;border-top:1px solid #eee}.post-nav-divider{display:table-cell;width:10%}.post-nav-item{display:table-cell;padding:10px 0 0 0;width:45%;vertical-align:top}.post-nav-item a{position:relative;display:block;line-height:25px;font-size:14px;color:#555;border-bottom:none}.post-nav-item a:hover{color:#222;border-bottom:none}.post-nav-item a:active{top:2px}.post-nav-item .fa{position:absolute;top:8px;left:0;font-size:12px}.post-nav-next a{padding-left:15px}.post-nav-prev{text-align:right}.post-nav-prev a{padding-right:15px}.post-nav-prev .fa{right:0;left:auto}.posts-expand .post-eof{display:block;margin:80px auto 60px;width:8%;height:1px;background:#ccc;text-align:center}.post:last-child .post-eof.post-eof.post-eof{display:none}.post-gallery{display:table;table-layout:fixed;width:100%;border-collapse:separate}.post-gallery-row{display:table-row}.post-gallery .post-gallery-img{display:table-cell;text-align:center;vertical-align:middle;border:none}.post-gallery .post-gallery-img img{max-width:100%;max-height:100%;border:none}.fancybox-close,.fancybox-close:hover{border:none}#rewardButton{cursor:pointer;border:0;outline:0;border-radius:5px;padding:0;margin:0;letter-spacing:normal;text-transform:none;text-indent:0;text-shadow:none}#rewardButton span{display:inline-block;width:80px;height:35px;border-radius:5px;color:#fff;font-weight:400;font-style:normal;font-variant:normal;font-stretch:normal;font-size:18px;font-family:"Microsoft Yahei";background:#f44336}#rewardButton span:hover{background:#f7877f}#QR{padding-top:20px}#QR a{border:0}#QR img{width:180px;max-width:100%;display:inline-block;margin:.8em 2em 0 2em}#wechat:hover p{animation:roll .1s infinite linear;-webkit-animation:roll .1s infinite linear;-moz-animation:roll .1s infinite linear}#alipay:hover p{animation:roll .1s infinite linear;-webkit-animation:roll .1s infinite linear;-moz-animation:roll .1s infinite linear}#bitcoin:hover p{animation:roll .1s infinite linear;-webkit-animation:roll .1s infinite linear;-moz-animation:roll .1s infinite linear}@-moz-keyframes roll{from{-webkit-transform:rotateZ(30deg);-moz-transform:rotateZ(30deg);-ms-transform:rotateZ(30deg);-o-transform:rotateZ(30deg);transform:rotateZ(30deg)}to{-webkit-transform:rotateZ(-30deg);-moz-transform:rotateZ(-30deg);-ms-transform:rotateZ(-30deg);-o-transform:rotateZ(-30deg);transform:rotateZ(-30deg)}}@-webkit-keyframes roll{from{-webkit-transform:rotateZ(30deg);-moz-transform:rotateZ(30deg);-ms-transform:rotateZ(30deg);-o-transform:rotateZ(30deg);transform:rotateZ(30deg)}to{-webkit-transform:rotateZ(-30deg);-moz-transform:rotateZ(-30deg);-ms-transform:rotateZ(-30deg);-o-transform:rotateZ(-30deg);transform:rotateZ(-30deg)}}@-o-keyframes roll{from{-webkit-transform:rotateZ(30deg);-moz-transform:rotateZ(30deg);-ms-transform:rotateZ(30deg);-o-transform:rotateZ(30deg);transform:rotateZ(30deg)}to{-webkit-transform:rotateZ(-30deg);-moz-transform:rotateZ(-30deg);-ms-transform:rotateZ(-30deg);-o-transform:rotateZ(-30deg);transform:rotateZ(-30deg)}}@keyframes roll{from{-webkit-transform:rotateZ(30deg);-moz-transform:rotateZ(30deg);-ms-transform:rotateZ(30deg);-o-transform:rotateZ(30deg);transform:rotateZ(30deg)}to{-webkit-transform:rotateZ(-30deg);-moz-transform:rotateZ(-30deg);-ms-transform:rotateZ(-30deg);-o-transform:rotateZ(-30deg);transform:rotateZ(-30deg)}}.rtl.post-body a,.rtl.post-body h1,.rtl.post-body h2,.rtl.post-body h3,.rtl.post-body h4,.rtl.post-body h5,.rtl.post-body h6,.rtl.post-body li,.rtl.post-body ol,.rtl.post-body p,.rtl.post-body ul{direction:rtl;font-family:UKIJ Ekran}.rtl.post-title{font-family:UKIJ Ekran}.sidebar{position:fixed;right:0;top:0;bottom:0;width:0;z-index:1040;box-shadow:inset 0 2px 6px #000;background:#222;-webkit-transform:translateZ(0)}.sidebar a{color:#999;border-bottom-color:#555}.sidebar a:hover{color:#eee}@media (min-width:768px) and (max-width:991px){.sidebar{display:none!important}}@media (max-width:767px){.sidebar{display:none!important}}.sidebar-inner{position:relative;padding:20px 10px;color:#999;text-align:center}.site-overview-wrap{overflow:hidden}.site-overview{overflow-y:auto;overflow-x:hidden}.sidebar-toggle{position:fixed;right:30px;bottom:45px;width:14px;height:14px;padding:5px;background:#222;line-height:0;z-index:1050;cursor:pointer;-webkit-transform:translateZ(0)}@media (min-width:768px) and (max-width:991px){.sidebar-toggle{display:none!important}}@media (max-width:767px){.sidebar-toggle{display:none!important}}.sidebar-toggle-line{position:relative;display:inline-block;vertical-align:top;height:2px;width:100%;background:#fff;margin-top:3px}.sidebar-toggle-line:first-child{margin-top:0}.site-author-image{display:block;margin:0 auto;padding:2px;max-width:120px;height:auto;border:1px solid #eee}.site-author-name{margin:0;text-align:center;color:#222;font-weight:600}.site-description{margin-top:0;text-align:center;font-size:13px;color:#999}.site-state{overflow:hidden;line-height:1.4;white-space:nowrap;text-align:center}.site-state-item{display:inline-block;padding:0 15px;border-left:1px solid #eee}.site-state-item:first-child{border-left:none}.site-state-item a{border-bottom:none}.site-state-item-count{display:block;text-align:center;color:inherit;font-weight:600;font-size:16px}.site-state-item-name{font-size:13px;color:#999}.feed-link{margin-top:20px}.feed-link a{display:inline-block;padding:0 15px;color:#fc6423;border:1px solid #fc6423;border-radius:4px}.feed-link a i{color:#fc6423;font-size:14px}.feed-link a:hover{color:#fff;background:#fc6423}.feed-link a:hover i{color:#fff}.links-of-author{margin-top:20px}.links-of-author a{display:inline-block;vertical-align:middle;margin-right:10px;margin-bottom:10px;border-bottom-color:#555;font-size:13px}.links-of-author a:before{display:inline-block;vertical-align:middle;margin-right:3px;content:" ";width:4px;height:4px;border-radius:50%;background:#feb17f}.links-of-blogroll{font-size:13px}.links-of-blogroll-title{margin-top:20px;font-size:14px;font-weight:600}.links-of-blogroll-list{margin:0;padding:0;list-style:none}.links-of-blogroll-item{padding:2px 10px}.links-of-blogroll-item a{max-width:280px;box-sizing:border-box;display:inline-block;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.sidebar-nav{margin:0 0 20px;padding-left:0}.sidebar-nav li{display:inline-block;cursor:pointer;border-bottom:1px solid transparent;font-size:14px;color:#555}.sidebar-nav li:hover{color:#fc6423}.page-post-detail .sidebar-nav-toc{padding:0 5px}.page-post-detail .sidebar-nav-overview{margin-left:10px}.sidebar-nav .sidebar-nav-active{color:#fc6423;border-bottom-color:#fc6423}.sidebar-nav .sidebar-nav-active:hover{color:#fc6423}.sidebar-panel{display:none}.sidebar-panel-active{display:block}.post-toc-empty{font-size:14px;color:#666}.post-toc-wrap{overflow:hidden}.post-toc{overflow:auto}.post-toc ol{margin:0;padding:0 2px 5px 10px;text-align:left;list-style:none;font-size:14px}.post-toc ol>ol{padding-left:0}.post-toc ol a{transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;transition-property:all;color:#666;border-bottom-color:#ccc}.post-toc ol a:hover{color:#000;border-bottom-color:#000}.post-toc .nav-item{overflow:hidden;text-overflow:ellipsis;text-align:justify;white-space:nowrap;line-height:1.8}.post-toc .nav .nav-child{display:none}.post-toc .nav .active>.nav-child{display:block}.post-toc .nav .active-current>.nav-child{display:block}.post-toc .nav .active-current>.nav-child>.nav-item{display:block}.post-toc .nav .active>a{color:#fc6423;border-bottom-color:#fc6423}.post-toc .nav .active-current>a{color:#fc6423}.post-toc .nav .active-current>a:hover{color:#fc6423}.footer{font-size:14px;color:#999}.footer img{border:none}.footer-inner{text-align:center}.with-love{display:inline-block;margin:0 5px}.powered-by,.theme-info{display:inline-block}.cc-license{margin-top:10px;text-align:center}.cc-license .cc-opacity{opacity:.7;border-bottom:none}.cc-license .cc-opacity:hover{opacity:.9}.cc-license img{display:inline-block}.theme-next #ds-thread #ds-reset{color:#555}.theme-next #ds-thread #ds-reset .ds-replybox{margin-bottom:30px}.theme-next #ds-reset .ds-avatar img,.theme-next #ds-thread #ds-reset .ds-replybox .ds-avatar{box-shadow:none}.theme-next #ds-thread #ds-reset .ds-textarea-wrapper{border-color:#c7d4e1;background:0 0;border-top-right-radius:3px;border-top-left-radius:3px}.theme-next #ds-thread #ds-reset .ds-textarea-wrapper textarea{height:60px}.theme-next #ds-reset .ds-rounded-top{border-radius:0}.theme-next #ds-thread #ds-reset .ds-post-toolbar{box-sizing:border-box;border:1px solid #c7d4e1;background:#f6f8fa}.theme-next #ds-thread #ds-reset .ds-post-options{height:40px;border:none;background:0 0}.theme-next #ds-thread #ds-reset .ds-toolbar-buttons{top:11px}.theme-next #ds-thread #ds-reset .ds-sync{top:5px}.theme-next #ds-thread #ds-reset .ds-post-button{top:4px;right:5px;width:90px;height:30px;border:1px solid #c5ced7;border-radius:3px;background-image:linear-gradient(#fbfbfc,#f5f7f9);color:#60676d}.theme-next #ds-thread #ds-reset .ds-post-button:hover{background-position:0 -30px;color:#60676d}.theme-next #ds-thread #ds-reset .ds-comments-info{padding:10px 0}.theme-next #ds-thread #ds-reset .ds-sort{display:none}.theme-next #ds-thread #ds-reset li.ds-tab a.ds-current{border:none;background:#f6f8fa;color:#60676d}.theme-next #ds-thread #ds-reset li.ds-tab a.ds-current:hover{background-color:#e9f0f7;color:#60676d}.theme-next #ds-thread #ds-reset li.ds-tab a{border-radius:2px;padding:5px}.theme-next #ds-thread #ds-reset .ds-login-buttons p{color:#999;line-height:36px}.theme-next #ds-thread #ds-reset .ds-login-buttons .ds-service-list li{height:28px}.theme-next #ds-thread #ds-reset .ds-service-list a{background:0 0;padding:5px;border:1px solid;border-radius:3px;text-align:center}.theme-next #ds-thread #ds-reset .ds-service-list a:hover{color:#fff;background:#666}.theme-next #ds-thread #ds-reset .ds-service-list .ds-weibo{color:#fc9b00;border-color:#fc9b00}.theme-next #ds-thread #ds-reset .ds-service-list .ds-weibo:hover{background:#fc9b00}.theme-next #ds-thread #ds-reset .ds-service-list .ds-qq{color:#60a3ec;border-color:#60a3ec}.theme-next #ds-thread #ds-reset .ds-service-list .ds-qq:hover{background:#60a3ec}.theme-next #ds-thread #ds-reset .ds-service-list .ds-renren{color:#2e7ac4;border-color:#2e7ac4}.theme-next #ds-thread #ds-reset .ds-service-list .ds-renren:hover{background:#2e7ac4}.theme-next #ds-thread #ds-reset .ds-service-list .ds-douban{color:#37994c;border-color:#37994c}.theme-next #ds-thread #ds-reset .ds-service-list .ds-douban:hover{background:#37994c}.theme-next #ds-thread #ds-reset .ds-service-list .ds-kaixin{color:#fef20d;border-color:#fef20d}.theme-next #ds-thread #ds-reset .ds-service-list .ds-kaixin:hover{background:#fef20d}.theme-next #ds-thread #ds-reset .ds-service-list .ds-netease{color:red;border-color:red}.theme-next #ds-thread #ds-reset .ds-service-list .ds-netease:hover{background:red}.theme-next #ds-thread #ds-reset .ds-service-list .ds-sohu{color:#ffcb05;border-color:#ffcb05}.theme-next #ds-thread #ds-reset .ds-service-list .ds-sohu:hover{background:#ffcb05}.theme-next #ds-thread #ds-reset .ds-service-list .ds-baidu{color:#2831e0;border-color:#2831e0}.theme-next #ds-thread #ds-reset .ds-service-list .ds-baidu:hover{background:#2831e0}.theme-next #ds-thread #ds-reset .ds-service-list .ds-google{color:#166bec;border-color:#166bec}.theme-next #ds-thread #ds-reset .ds-service-list .ds-google:hover{background:#166bec}.theme-next #ds-thread #ds-reset .ds-service-list .ds-weixin{color:#00ce0d;border-color:#00ce0d}.theme-next #ds-thread #ds-reset .ds-service-list .ds-weixin:hover{background:#00ce0d}.theme-next #ds-thread #ds-reset .ds-service-list .ds-more-services{border:none}.theme-next #ds-thread #ds-reset .ds-service-list .ds-more-services:hover{background:0 0}.theme-next #ds-reset .duoshuo-ua-admin{display:inline-block;color:red}.theme-next #ds-reset .duoshuo-ua-browser,.theme-next #ds-reset .duoshuo-ua-platform{color:#ccc}.theme-next #ds-reset .duoshuo-ua-browser .fa,.theme-next #ds-reset .duoshuo-ua-platform .fa{display:inline-block;margin-right:3px}.theme-next #ds-reset .duoshuo-ua-separator{display:inline-block;margin-left:5px}.theme-next .this_ua{background-color:#ccc!important;border-radius:4px;padding:0 5px!important;margin:1px 1px!important;border:1px solid #bbb!important;color:#fff;display:inline-block!important}.theme-next .this_ua.admin{background-color:#d9534f!important;border-color:#d9534f!important}.theme-next .this_ua.platform.Mac,.theme-next .this_ua.platform.Windows,.theme-next .this_ua.platform.iOS{background-color:#39b3d7!important;border-color:#46b8da!important}.theme-next .this_ua.platform.Linux{background-color:#3a3a3a!important;border-color:#1f1f1f!important}.theme-next .this_ua.platform.Android{background-color:#00c47d!important;border-color:#01b171!important}.theme-next .this_ua.browser.Chrome,.theme-next .this_ua.browser.Mobile{background-color:#5cb85c!important;border-color:#4cae4c!important}.theme-next .this_ua.browser.Firefox{background-color:#f0ad4e!important;border-color:#eea236!important}.theme-next .this_ua.browser.IE,.theme-next .this_ua.browser.Maxthon{background-color:#428bca!important;border-color:#357ebd!important}.theme-next .this_ua.browser.Opera,.theme-next .this_ua.browser.UCBrowser,.theme-next .this_ua.browser.baidu{background-color:#d9534f!important;border-color:#d43f3a!important}.theme-next .this_ua.browser.Android,.theme-next .this_ua.browser.QQBrowser{background-color:#78ace9!important;border-color:#4cae4c!important}.post-spread{margin-top:20px;text-align:center}.jiathis_style{display:inline-block}.jiathis_style a{border:none}.fa{font-family:FontAwesome!important}.post-spread{margin-top:20px;text-align:center}.bdshare-slide-button-box a{border:none}.bdsharebuttonbox{display:inline-block}.bdsharebuttonbox a{border:none}.local-search-pop-overlay{position:fixed;width:100%;height:100%;top:0;left:0;z-index:2080;background-color:rgba(0,0,0,.3)}.local-search-popup{display:none;position:fixed;top:10%;left:50%;margin-left:-350px;width:700px;height:80%;padding:0;background:#fff;color:#333;z-index:9999;border-radius:5px}@media (max-width:767px){.local-search-popup{padding:0;top:0;left:0;margin:0;width:100%;height:100%;border-radius:0}}.local-search-popup ul.search-result-list{padding:0;margin:0 5px}.local-search-popup p.search-result{border-bottom:1px dashed #ccc;padding:5px 0}.local-search-popup a.search-result-title{font-weight:700;font-size:16px}.local-search-popup .search-keyword{border-bottom:1px dashed red;font-weight:700;color:red}.local-search-popup .local-search-header{padding:5px;height:36px;background:#f5f5f5;border-top-left-radius:5px;border-top-right-radius:5px}.local-search-popup #local-search-result{overflow:auto;position:relative;padding:5px 25px;height:calc(100% - 55px)}.local-search-popup .local-search-input-wrapper{display:inline-block;width:calc(100% - 90px);height:36px;line-height:36px;padding:0 5px}.local-search-popup .local-search-input-wrapper input{padding:8px 0;height:20px;display:block;width:100%;outline:0;border:none;background:0 0;vertical-align:middle}.local-search-popup .popup-btn-close,.local-search-popup .search-icon{display:inline-block;font-size:18px;color:#999;height:36px;width:18px;padding-left:10px;padding-right:10px}.local-search-popup .search-icon{float:left}.local-search-popup .popup-btn-close{border-left:1px solid #eee;float:right;cursor:pointer}.local-search-popup #no-result{position:absolute;left:50%;top:50%;-webkit-transform:translate(-50%,-50%);-webkit-transform:translate(-50%,-50%);-moz-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);-o-transform:translate(-50%,-50%);transform:translate(-50%,-50%);color:#ccc}@media (min-width:768px) and (max-width:991px){.busuanzi-count{width:auto}}@media (max-width:767px){.busuanzi-count{width:auto}}.page-pv,.site-pv,.site-uv{display:inline-block}.page-pv .busuanzi-value,.site-pv .busuanzi-value,.site-uv .busuanzi-value{margin:0 5px}.site-uv{margin-right:10px}.site-uv::after{content:"|";padding-left:10px}#needsharebutton-postbottom{position:relative;cursor:pointer;height:26px}#needsharebutton-postbottom .btn{display:initial;padding:1px 4px;border:1px solid #555;border-radius:3px}#needsharebutton-float{position:fixed;bottom:38px;left:-8px;z-index:9999;cursor:pointer}#needsharebutton-float .btn{padding:0 10px 0 14px;border:1px solid #555;border-radius:4px}.page-archive .archive-page-counter{position:relative;top:3px;left:20px}@media (max-width:767px){.page-archive .archive-page-counter{top:5px}}.page-archive .posts-collapse .archive-move-on{position:absolute;top:11px;left:0;margin-left:-6px;width:10px;height:10px;opacity:.5;background:#555;border:1px solid #fff;border-radius:50%}.category-all-page .category-all-title{text-align:center}.category-all-page .category-all{margin-top:20px}.category-all-page .category-list{margin:0;padding:0;list-style:none}.category-all-page .category-list-item{margin:5px 10px}.category-all-page .category-list-count{color:#bbb}.category-all-page .category-list-count:before{display:inline;content:" ("}.category-all-page .category-list-count:after{display:inline;content:") "}.category-all-page .category-list-child{padding-left:10px}#schedule ul#event-list{padding-left:30px}#schedule ul#event-list hr{margin:20px 0 45px 0!important;background:#222}#schedule ul#event-list hr:after{display:inline-block;content:'NOW';background:#222;color:#fff;font-weight:700;text-align:right;padding:0 5px}#schedule ul#event-list li.event{margin:20px 0;background:#f9f9f9;padding-left:10px;min-height:40px}#schedule ul#event-list li.event h2.event-summary{margin:0;padding-bottom:3px}#schedule ul#event-list li.event h2.event-summary:before{display:inline-block;font-family:FontAwesome;font-size:8px;content:'\f111';vertical-align:middle;margin-right:25px;color:#bbb}#schedule ul#event-list li.event span.event-relative-time{display:inline-block;font-size:12px;font-weight:400;padding-left:12px;color:#bbb}#schedule ul#event-list li.event span.event-details{display:block;color:#bbb;margin-left:56px;padding-top:3px;padding-bottom:6px;text-indent:-24px;line-height:18px}#schedule ul#event-list li.event span.event-details:before{text-indent:0;display:inline-block;width:14px;font-family:FontAwesome;text-align:center;margin-right:9px;color:#bbb}#schedule ul#event-list li.event span.event-details.event-location:before{content:'\f041'}#schedule ul#event-list li.event span.event-details.event-duration:before{content:'\f017'}#schedule ul#event-list li.event-past{background:#fcfcfc}#schedule ul#event-list li.event-past>*{opacity:.6}#schedule ul#event-list li.event-past h2.event-summary{color:#bbb}#schedule ul#event-list li.event-past h2.event-summary:before{color:#dfdfdf}#schedule ul#event-list li.event-now{background:#222;color:#fff;padding:15px 0 15px 10px}#schedule ul#event-list li.event-now h2.event-summary:before{-webkit-transform:scale(1.2);-moz-transform:scale(1.2);-ms-transform:scale(1.2);-o-transform:scale(1.2);transform:scale(1.2);color:#fff;animation:dot-flash 1s alternate infinite ease-in-out}#schedule ul#event-list li.event-now *{color:#fff!important}@-moz-keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@-webkit-keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@-o-keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}.page-post-detail .sidebar-toggle-line{background:#fc6423}.page-post-detail .comments{overflow:hidden}.header{position:relative;margin:0 auto;width:960px}@media (min-width:768px) and (max-width:991px){.header{width:auto}}@media (max-width:767px){.header{width:auto}}.header-inner{position:absolute;top:0;overflow:hidden;padding:0;width:240px;background:#fff;box-shadow:initial;border-radius:initial}@media (min-width:1600px){.container .header-inner{width:240px}}@media (min-width:768px) and (max-width:991px){.header-inner{position:relative;width:auto;border-radius:initial}}@media (max-width:767px){.header-inner{position:relative;width:auto;border-radius:initial}}.main:after,.main:before{content:" ";display:table}.main:after{clear:both}@media (min-width:768px) and (max-width:991px){.main{padding-bottom:100px}}@media (max-width:767px){.main{padding-bottom:100px}}.container .main-inner{width:960px}@media (min-width:768px) and (max-width:991px){.container .main-inner{width:auto}}@media (max-width:767px){.container .main-inner{width:auto}}.content-wrap{float:right;box-sizing:border-box;padding:40px;width:700px;background:#fff;min-height:700px;box-shadow:initial;border-radius:initial}@media (min-width:768px) and (max-width:991px){.content-wrap{width:100%;padding:20px;border-radius:initial}}@media (max-width:767px){.content-wrap{width:100%;padding:20px;min-height:auto;border-radius:initial}}.sidebar{position:static;float:left;margin-top:300px;width:240px;background:#f5f7f9;box-shadow:none}@media (min-width:768px) and (max-width:991px){.sidebar{display:none}}@media (max-width:767px){.sidebar{display:none}}.sidebar-toggle{display:none}.footer-inner{width:960px;padding-left:260px}@media (min-width:768px) and (max-width:991px){.footer-inner{width:auto;padding-left:0!important;padding-right:0!important}}@media (max-width:767px){.footer-inner{width:auto;padding-left:0!important;padding-right:0!important}}.sidebar-position-right .header-inner{right:0}.sidebar-position-right .content-wrap{float:left}.sidebar-position-right .sidebar{float:right}.sidebar-position-right .footer-inner{padding-left:0;padding-right:260px}.site-brand-wrapper{position:relative}.site-meta{padding:20px 0;color:#fff;background:#222}@media (min-width:768px) and (max-width:991px){.site-meta{box-shadow:0 0 16px rgba(0,0,0,.5)}}@media (max-width:767px){.site-meta{box-shadow:0 0 16px rgba(0,0,0,.5)}}.brand{padding:0;background:0 0}.brand:hover{color:#fff}.site-subtitle{margin:10px 10px 0;font-weight:initial}.site-search form{display:none}.site-nav{border-top:none}@media (min-width:768px) and (max-width:991px){.site-nav{display:none!important}}@media (min-width:768px) and (max-width:991px){.site-nav-on{display:block!important}}.menu .menu-item{display:block;margin:0}.menu .menu-item a{position:relative;box-sizing:border-box;padding:5px 20px;text-align:left;line-height:inherit;transition-property:background-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.menu .menu-item a:hover,.menu-item-active a{background:#f9f9f9;border-bottom-color:#fff}.menu .menu-item br{display:none}.menu-item-active a:after{content:" ";position:absolute;top:50%;margin-top:-3px;right:15px;width:6px;height:6px;border-radius:50%;background-color:#bbb}.btn-bar{background-color:#fff}.site-nav-toggle{left:20px;top:50%;-webkit-transform:translateY(-50%);-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);-o-transform:translateY(-50%);transform:translateY(-50%)}@media (min-width:768px) and (max-width:991px){.site-nav-toggle{display:block}}.use-motion .sidebar .motion-element{opacity:1}.sidebar{margin-left:-100%;right:auto;bottom:auto;-webkit-transform:none}.sidebar-inner{box-sizing:border-box;width:240px;color:#555;background:#fff;box-shadow:initial;border-radius:initial;opacity:0}.sidebar-inner.affix{position:fixed;top:12px}.sidebar-inner.affix-bottom{position:absolute}.site-overview{text-align:left}.site-author:after,.site-author:before{content:" ";display:table}.site-author:after{clear:both}.sidebar a{color:#555}.sidebar a:hover{color:#222}.site-state-item{padding:0 10px}.links-of-author-item a:before{display:none}.links-of-author-item a{border-bottom:none;text-decoration:underline}.feed-link{border-top:1px dotted #ccc;border-bottom:1px dotted #ccc;text-align:center}.feed-link a{display:block;color:#fc6423;border:none}.feed-link a:hover{background:0 0;color:#e34603}.feed-link a:hover i{color:#e34603}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author-item{margin:5px 0 0;width:50%}.links-of-author-item a{max-width:216px;box-sizing:border-box;display:inline-block;margin-right:0;margin-bottom:0;padding:0 5px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.links-of-author-item a{display:block;text-decoration:none}.links-of-author-item a:hover{border-radius:4px;background:#eee}.links-of-author-item .fa{margin-right:2px;font-size:16px}.links-of-author-item .fa-globe{font-size:15px}.links-of-blogroll{text-align:center;margin-top:20px;padding:3px 0 0;border-top:1px dotted #ccc}.links-of-blogroll-title{margin-top:0}.links-of-blogroll-item{padding:0}.links-of-blogroll-inline:after,.links-of-blogroll-inline:before{content:" ";display:table}.links-of-blogroll-inline:after{clear:both}.links-of-blogroll-inline .links-of-blogroll-item{margin:5px 0 0;width:50%;display:inline-block;width:unset}.links-of-blogroll-inline .links-of-blogroll-item a{max-width:216px;box-sizing:border-box;display:inline-block;margin-right:0;margin-bottom:0;padding:0 5px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}@media (max-width:767px){.post-body{text-align:justify}}</style><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.6.3/css/font-awesome.min.css"></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">大鹏的博客</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/21/react/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/21/react/" itemprop="url">react</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-21T17:15:01+08:00">2019-01-21 </time></span><span id="/2019/01/21/react/" class="leancloud_visitors" data-flag-title="react"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">310 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">2</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="组件重用和状态共享"><a href="#组件重用和状态共享" class="headerlink" title="组件重用和状态共享"></a>组件重用和状态共享</h2><p>有时，我们希望在组件之间重用一些有<strong>状态逻辑</strong>的部分。传统上，这个问题有两个流行的解决方案：<a href="https://react.docschina.org/docs/higher-order-components.html" target="_blank" rel="noopener">高阶组件</a>、<a href="https://react.docschina.org/docs/render-props.html" target="_blank" rel="noopener">render props</a>和<a href="">React Hooks</a></p><h3 id="Render-Props"><a href="#Render-Props" class="headerlink" title="Render Props"></a>Render Props</h3><p><code>render prop</code> 是一个组件用来了解要渲染什么内容的函数 <code>prop</code><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;DataProvider render={data =&gt; (</span><br><span class="line">  &lt;h1&gt;Hello {data.target}&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">)}/</span>&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>使用 render props 的库包括 <a href="https://reacttraining.com/react-router/web/api/Route/Route-render-methods" target="_blank" rel="noopener">React Router</a> 和 <a href="https://github.com/paypal/downshift" target="_blank" rel="noopener">Downshift</a></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>{</span><br><span class="line">  render() {</span><br><span class="line">    <span class="keyword">const</span> mouse = <span class="keyword">this</span>.props.mouse;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;img src=<span class="string">"/cat.jpg"</span> style={{ <span class="attr">position</span>: <span class="string">'absolute'</span>, <span class="attr">left</span>: mouse.x, <span class="attr">top</span>: mouse.y }} /&gt;</span><br><span class="line">    );</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mouse</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>{</span><br><span class="line">  <span class="keyword">constructor</span>(props) {</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.handleMouseMove = <span class="keyword">this</span>.handleMouseMove.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.state = { <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> };</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  handleMouseMove(event) {</span><br><span class="line">    <span class="keyword">this</span>.setState({</span><br><span class="line">      x: event.clientX,</span><br><span class="line">      y: event.clientY</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  render() {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div style={{ <span class="attr">height</span>: <span class="string">'100%'</span> }} onMouseMove={<span class="keyword">this</span>.handleMouseMove}&gt;</span><br><span class="line"></span><br><span class="line">        {<span class="comment">/*</span></span><br><span class="line"><span class="comment">          Instead of providing a static representation of what &lt;Mouse&gt; renders,</span></span><br><span class="line"><span class="comment">          use the `render` prop to dynamically determine what to render.</span></span><br><span class="line"><span class="comment">        */</span>}</span><br><span class="line">        {<span class="keyword">this</span>.props.render(<span class="keyword">this</span>.state)}</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  }</span></span><br><span class="line"><span class="regexp">}</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MouseTracker</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>{</span><br><span class="line">  render() {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Move the mouse around!<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">        &lt;Mouse render={mouse =&gt; (</span><br><span class="line">          &lt;Cat mouse={mouse} /&gt;</span><br><span class="line">        )}/&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  }</span></span><br><span class="line"><span class="regexp">}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="高阶组件"><a href="#高阶组件" class="headerlink" title="高阶组件"></a>高阶组件</h3><p><code>高阶组件</code>就是一个函数，且该函数接受一个组件作为参数，并返回一个新的组件</p><hr><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://github.com/dt-fe/weekly/blob/master/75.%E7%B2%BE%E8%AF%BB%E3%80%8AEpitath%20%E6%BA%90%E7%A0%81%20-%20renderProps%20%E6%96%B0%E7%94%A8%E6%B3%95%E3%80%8B.md" target="_blank" rel="noopener">Epitath 源码 - renderProps 新用法</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/21/手写webpack/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/21/手写webpack/" itemprop="url">手写webpack</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-21T15:54:08+08:00">2019-01-21 </time></span><span id="/2019/01/21/手写webpack/" class="leancloud_visitors" data-flag-title="手写webpack"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">2,682 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">14</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="Webpack流程概括"><a href="#Webpack流程概括" class="headerlink" title="Webpack流程概括"></a>Webpack流程概括</h2><ul><li>初始化参数：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数； 开始编译：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译；</li><li>确定入口：根据配置中的 entry 找出所有的入口文件；</li><li>编译模块：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理；<br>完成模块编译：在经过第4步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系；</li><li>输出资源：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会；</li><li>输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</li><li>在以上过程中，Webpack 会在特定的时间点广播出特定的事件，插件在监听到感兴趣的事件后会执行特定的逻辑，并且插件可以调用 Webpack 提供的 API 改变 Webpack 的运行结果。</li></ul><h2 id="钩子"><a href="#钩子" class="headerlink" title="钩子"></a>钩子</h2><ul><li>entryOption 读取配置文件</li><li>afterPlugins 加载所有的插件</li><li>run 开始执行编译流程</li><li>compile 开始编译</li><li>afterCompile 编译完成</li><li>emit 写入文件</li><li>done 完成整体流程</li></ul><h2 id="编写示例项目"><a href="#编写示例项目" class="headerlink" title="编写示例项目"></a>编写示例项目</h2><h3 id="安装依赖模块"><a href="#安装依赖模块" class="headerlink" title="安装依赖模块"></a>安装依赖模块</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm init -y</span><br><span class="line">$ yarn add webpack webpack-cli html-webpack-plugin</span><br></pre></td></tr></tbody></table></figure><h3 id="编写webpack配置文件"><a href="#编写webpack配置文件" class="headerlink" title="编写webpack配置文件"></a>编写webpack配置文件</h3><p>webpack.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">    mode: <span class="string">'development'</span>,</span><br><span class="line">    entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    output: {</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'bundle.js'</span></span><br><span class="line">    },</span><br><span class="line">    <span class="built_in">module</span>: {},</span><br><span class="line">    plugins: []</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="源文件"><a href="#源文件" class="headerlink" title="源文件"></a>源文件</h3><h4 id="src-index-js"><a href="#src-index-js" class="headerlink" title="src/index.js"></a>src/index.js</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a1=<span class="built_in">require</span>(<span class="string">'./a1'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(a1);</span><br></pre></td></tr></tbody></table></figure><h4 id="src-a1-js"><a href="#src-a1-js" class="headerlink" title="src/a1.js"></a>src/a1.js</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a2=<span class="built_in">require</span>(<span class="string">'./base/a2'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports=<span class="string">'a1'</span>+a2;</span><br></pre></td></tr></tbody></table></figure><h4 id="src-base-a2-js"><a href="#src-base-a2-js" class="headerlink" title="src/base/a2.js"></a>src/base/a2.js</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports=<span class="string">'a2'</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="产出bundle-js"><a href="#产出bundle-js" class="headerlink" title="产出bundle.js"></a>产出bundle.js</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> installedModules = {};</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>{</span><br><span class="line">    <span class="keyword">if</span> (installedModules[moduleId]) {</span><br><span class="line">      <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = {</span><br><span class="line">      i: moduleId,</span><br><span class="line">      l: <span class="literal">false</span>,</span><br><span class="line">      exports: {}</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</span><br><span class="line">    <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"./src/index.js"</span>);</span><br><span class="line">})</span><br><span class="line">  ({</span><br><span class="line"></span><br><span class="line">    <span class="string">"./src/a1.js"</span>:</span><br><span class="line">      (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports, __webpack_require__</span>) </span>{</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">"let a2 = __webpack_require__( \"./src/base/a2.js\");\r\nmodule.exports = 'a1' + a2;"</span>);</span><br><span class="line">      }),</span><br><span class="line">    <span class="string">"./src/base/a2.js"</span>:</span><br><span class="line">      (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports</span>) </span>{</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">"module.exports = 'a2';"</span>);</span><br><span class="line">      }),</span><br><span class="line"></span><br><span class="line">    <span class="string">"./src/index.js"</span>:</span><br><span class="line">      (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports, __webpack_require__</span>) </span>{</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">"let a1 = __webpack_require__(\"./src/a1.js\");\r\nconsole.log(a1);"</span>);</span><br><span class="line">      })</span><br><span class="line">  });</span><br></pre></td></tr></tbody></table></figure><h2 id="编写webpack"><a href="#编写webpack" class="headerlink" title="编写webpack"></a>编写webpack</h2><h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add babel-types babel-generator babel-traverse</span><br></pre></td></tr></tbody></table></figure><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>package.json<br></p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"webpackhand"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"bin"</span>: {</span><br><span class="line">    <span class="attr">"webpackhand"</span>: <span class="string">"./bin/webpackhand.js"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"keywords"</span>: [],</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="创建可执行文件"><a href="#创建可执行文件" class="headerlink" title="创建可执行文件"></a>创建可执行文件</h3><p>bin\webpackhand.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/env node</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> Compiler = <span class="built_in">require</span>(<span class="string">'../lib/Compiler'</span>);</span><br><span class="line"><span class="comment">//命令的当前工作目录</span></span><br><span class="line"><span class="keyword">const</span> root = process.cwd();</span><br><span class="line"><span class="comment">//匹配配置文件对象</span></span><br><span class="line"><span class="keyword">let</span> options = <span class="built_in">require</span>(path.resolve(<span class="string">'webpack.config.js'</span>));</span><br><span class="line"><span class="keyword">let</span> compiler = <span class="keyword">new</span> Compiler(options);</span><br><span class="line">compiler.run();</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="创建Compiler对象"><a href="#创建Compiler对象" class="headerlink" title="创建Compiler对象"></a>创建Compiler对象</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> babylon = <span class="built_in">require</span>(<span class="string">'babylon'</span>);</span><br><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"><span class="keyword">const</span> generate = <span class="built_in">require</span>(<span class="string">'babel-generator'</span>).default;</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'babel-traverse'</span>).default;</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compiler</span> </span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options = options;</span><br><span class="line">    }</span><br><span class="line">    run() {</span><br><span class="line">        <span class="keyword">let</span> that = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.root = process.cwd();<span class="comment">//获取当前的工作目录</span></span><br><span class="line">        <span class="keyword">let</span> { entry } = <span class="keyword">this</span>.options;<span class="comment">//获取入口文件路径</span></span><br><span class="line">        <span class="keyword">this</span>.entryId = <span class="literal">null</span>;<span class="comment">//记录入口文件的ID</span></span><br><span class="line">        <span class="keyword">this</span>.modules = {};<span class="comment">//记录模块ID和内容的对应关系，所有的ID都是相对于根目录的</span></span><br><span class="line">        <span class="keyword">this</span>.buildModule(path.resolve(<span class="keyword">this</span>.root, entry), <span class="literal">true</span>);<span class="comment">//从入口文件开始编译</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.modules);</span><br><span class="line">        <span class="keyword">this</span>.emitFile();</span><br><span class="line">    }</span><br><span class="line">    emitFile() {</span><br><span class="line">        <span class="keyword">let</span> mainTemplate = fs.readFileSync(path.join(__dirname, <span class="string">'main.ejs'</span>), <span class="string">'utf8'</span>);</span><br><span class="line">        <span class="keyword">let</span> { modules, entryId } = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">let</span> main = ejs.compile(mainTemplate)({ entryId, modules });</span><br><span class="line">        <span class="keyword">let</span> { <span class="attr">output</span>: { <span class="attr">path</span>: dist, filename } } = <span class="keyword">this</span>.options;</span><br><span class="line">        fs.writeFileSync(path.join(dist, filename), main);</span><br><span class="line">    }</span><br><span class="line">    getSource(modulePath) {</span><br><span class="line">        <span class="keyword">return</span> fs.readFileSync(modulePath, <span class="string">'utf8'</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//解析模块和依赖的模块，路径是一个绝对路径</span></span><br><span class="line">    buildModule(modulePath, isEntry) {</span><br><span class="line">        <span class="keyword">let</span> source = <span class="keyword">this</span>.getSource(modulePath);<span class="comment">//获取源代码</span></span><br><span class="line">        <span class="keyword">let</span> moduleId = <span class="string">'./'</span> + path.relative(<span class="keyword">this</span>.root, modulePath);<span class="comment">//生成相对于工作根目录的模块ID</span></span><br><span class="line">        <span class="keyword">if</span> (isEntry) {<span class="comment">//如果是入口的话把ID赋给入口</span></span><br><span class="line">            <span class="keyword">this</span>.entryId = moduleId;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//获取AST的编译结果 依赖的模块 转换后的源代码</span></span><br><span class="line">        <span class="keyword">let</span> { dependencies, sourcecode } = <span class="keyword">this</span>.parse(source, path.dirname(moduleId));</span><br><span class="line">        <span class="keyword">this</span>.modules[moduleId] = sourcecode;</span><br><span class="line">        <span class="comment">//递归解析依赖的模块</span></span><br><span class="line">        dependencies.forEach(<span class="function"><span class="params">dependency</span> =&gt;</span> <span class="keyword">this</span>.buildModule(path.join(<span class="keyword">this</span>.root, dependency)));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//解析源代码  传入父路径</span></span><br><span class="line">    parse(source, parentPath) {</span><br><span class="line">        <span class="keyword">let</span> that = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">const</span> ast = babylon.parse(source);</span><br><span class="line">        <span class="keyword">let</span> dependencies = [];</span><br><span class="line">        traverse(ast, {</span><br><span class="line">            CallExpression(p) {</span><br><span class="line">                <span class="keyword">if</span> (p.node.callee.name == <span class="string">'require'</span>) {</span><br><span class="line">                    <span class="keyword">let</span> node = p.node;</span><br><span class="line">                    node.callee.name = <span class="string">'__webpack_require__'</span>;</span><br><span class="line">                    <span class="keyword">let</span> modName = node.arguments[<span class="number">0</span>].value;</span><br><span class="line">                    modName += (modName.lastIndexOf(<span class="string">'.'</span>) &gt; <span class="number">0</span> ? <span class="string">''</span> : <span class="string">'.js'</span>);</span><br><span class="line">                    <span class="keyword">let</span> moduleId = <span class="string">'./'</span> + path.join(parentPath, modName);</span><br><span class="line">                    dependencies.push(moduleId);</span><br><span class="line">                    node.arguments = [t.stringLiteral(moduleId)];</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">let</span> sourcecode = generate(ast).code;</span><br><span class="line">        <span class="keyword">return</span> { sourcecode, dependencies };</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = Compiler;</span><br></pre></td></tr></tbody></table></figure><h4 id="入口模板"><a href="#入口模板" class="headerlink" title="入口模板"></a>入口模板</h4><p>main.ejs<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> installedModules = {};</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>{</span><br><span class="line">      <span class="keyword">if</span> (installedModules[moduleId]) {</span><br><span class="line">        <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = {</span><br><span class="line">        i: moduleId,</span><br><span class="line">        l: <span class="literal">false</span>,</span><br><span class="line">        exports: {}</span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">      modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</span><br><span class="line">      <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"&lt;%-entryId%&gt;"</span>);</span><br><span class="line">  })</span><br><span class="line">    ({</span><br><span class="line">        &lt;%</span><br><span class="line">          <span class="keyword">for</span>(<span class="keyword">let</span> id <span class="keyword">in</span> modules){</span><br><span class="line">              <span class="keyword">let</span> source = modules[id];%&gt;</span><br><span class="line">              <span class="string">"&lt;%-id%&gt;"</span>:</span><br><span class="line">              (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports,__webpack_require__</span>) </span>{</span><br><span class="line">                <span class="built_in">eval</span>(<span class="string">`&lt;%-source%&gt;`</span>);</span><br><span class="line">              }),</span><br><span class="line">           &lt;%}</span><br><span class="line">        %&gt;</span><br><span class="line">    });</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="产出文件"><a href="#产出文件" class="headerlink" title="产出文件"></a>产出文件</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> installedModules = {};</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>{</span><br><span class="line">      <span class="keyword">if</span> (installedModules[moduleId]) {</span><br><span class="line">        <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = {</span><br><span class="line">        i: moduleId,</span><br><span class="line">        l: <span class="literal">false</span>,</span><br><span class="line">        exports: {}</span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">      modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</span><br><span class="line">      <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"./src\index.js"</span>);</span><br><span class="line">  })</span><br><span class="line">    ({</span><br><span class="line"></span><br><span class="line">              <span class="string">"./src\index.js"</span>:</span><br><span class="line">              (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports,__webpack_require__</span>) </span>{</span><br><span class="line">                <span class="built_in">eval</span>(<span class="string">`let a1 = __webpack_require__("./src\\a1.js");</span></span><br><span class="line"><span class="string">console.log(a1);`</span>);</span><br><span class="line">              }),</span><br><span class="line"></span><br><span class="line">              <span class="string">"./src\a1.js"</span>:</span><br><span class="line">              (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports,__webpack_require__</span>) </span>{</span><br><span class="line">                <span class="built_in">eval</span>(<span class="string">`let a2 = __webpack_require__("./src\\base\\a2.js");</span></span><br><span class="line"><span class="string">module.exports = 'a1' + a2;`</span>);</span><br><span class="line">              }),</span><br><span class="line"></span><br><span class="line">              <span class="string">"./src\base\a2.js"</span>:</span><br><span class="line">              (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports,__webpack_require__</span>) </span>{</span><br><span class="line">                <span class="built_in">eval</span>(<span class="string">`module.exports = 'a2';`</span>);</span><br><span class="line">              }),</span><br><span class="line"></span><br><span class="line">    });</span><br></pre></td></tr></tbody></table></figure><h2 id="支持loader"><a href="#支持loader" class="headerlink" title="支持loader"></a>支持loader</h2><h3 id="Compiler"><a href="#Compiler" class="headerlink" title="Compiler"></a>Compiler</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">getSource(modulePath) {</span><br><span class="line">       <span class="keyword">let</span> that = <span class="keyword">this</span>;</span><br><span class="line">       <span class="keyword">let</span> source = fs.readFileSync(modulePath, <span class="string">'utf8'</span>);</span><br><span class="line">       <span class="keyword">let</span> { <span class="attr">module</span>: { rules } } = <span class="keyword">this</span>.options;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; rules.length; i++) {</span><br><span class="line">           <span class="keyword">let</span> rule = rules[i];</span><br><span class="line">           <span class="keyword">if</span> (rule.test.test(modulePath)) {</span><br><span class="line">               <span class="keyword">let</span> loaders = rule.use;</span><br><span class="line">               <span class="keyword">let</span> loaderIndex = loaders.length - <span class="number">1</span>;</span><br><span class="line">               <span class="function"><span class="keyword">function</span> <span class="title">iterateLoaders</span>(<span class="params"></span>) </span>{</span><br><span class="line">                   <span class="keyword">let</span> loaderName = loaders[loaderIndex--];</span><br><span class="line">                   <span class="keyword">let</span> loader = <span class="built_in">require</span>(path.resolve(that.root, <span class="string">'node_modules'</span>, loaderName));</span><br><span class="line">                   source = loader(source);</span><br><span class="line">                   <span class="keyword">if</span> (loaderIndex &gt;= <span class="number">0</span>) {</span><br><span class="line">                       iterateLoaders();</span><br><span class="line">                   }</span><br><span class="line">               }</span><br><span class="line">               iterateLoaders();</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           }</span><br><span class="line">       }</span><br><span class="line">       <span class="keyword">return</span> source;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><h3 id="less-loader"><a href="#less-loader" class="headerlink" title="less-loader"></a>less-loader</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> less = <span class="built_in">require</span>(<span class="string">'less'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> css;</span><br><span class="line">    less.render(source, (err, output) =&gt; {</span><br><span class="line">        css = output.css;</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> css.replace(<span class="regexp">/\n/g</span>, <span class="string">'\\n'</span>, <span class="string">'g'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="style-loader"><a href="#style-loader" class="headerlink" title="style-loader"></a>style-loader</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> str = <span class="string">`</span></span><br><span class="line"><span class="string">      let style = document.createElement('style');</span></span><br><span class="line"><span class="string">      style.innerHTML = <span class="subst">${<span class="built_in">JSON</span>.stringify(source)}</span>;</span></span><br><span class="line"><span class="string">      document.head.appendChild(style);</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require('./index.less');</span><br></pre></td></tr></tbody></table></figure><h2 id="支持插件"><a href="#支持插件" class="headerlink" title="支持插件"></a>支持插件</h2><h3 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EntryOptionWebpackPlugin</span> </span>{</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.entryOption.tap(<span class="string">'Plugin'</span>, (option) =&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'EntryOptionWebpackPlugin'</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AfterPlugins</span> </span>{</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.afterPlugins.tap(<span class="string">'Plugin'</span>, (option) =&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'AfterPlugins'</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RunPlugin</span> </span>{</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.run.tap(<span class="string">'Plugin'</span>, (option) =&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'RunPlugin'</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompileWebpackPlugin</span> </span>{</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.compile.tap(<span class="string">'Plugin'</span>, (option) =&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'CompileWebpackPlugin'</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AfterCompileWebpackPlugin</span> </span>{</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.afterCompile.tap(<span class="string">'Plugin'</span>, (option) =&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'AfterCompileWebpackPlugin'</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmitWebpackPlugin</span> </span>{</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.emit.tap(<span class="string">'Plugin'</span>, () =&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'EmitWebpackPlugin'</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoneWebpackPlugin</span> </span>{</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.done.tap(<span class="string">'Plugin'</span>, (option) =&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'DoneWebpackPlugin'</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">    mode: <span class="string">'development'</span>,</span><br><span class="line">    entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    output: {</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'bundle.js'</span></span><br><span class="line">    },</span><br><span class="line">    <span class="built_in">module</span>: {</span><br><span class="line">        rules: [</span><br><span class="line">            {</span><br><span class="line">                test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">                use: [<span class="string">'style-loader'</span>, <span class="string">'less-loader'</span>]</span><br><span class="line">            }</span><br><span class="line">        ]</span><br><span class="line">    },</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> EntryOptionWebpackPlugin(),</span><br><span class="line">        <span class="keyword">new</span> AfterPlugins(),</span><br><span class="line">        <span class="keyword">new</span> RunPlugin(),</span><br><span class="line">        <span class="keyword">new</span> CompileWebpackPlugin(),</span><br><span class="line">        <span class="keyword">new</span> AfterCompileWebpackPlugin(),</span><br><span class="line">        <span class="keyword">new</span> EmitWebpackPlugin(),</span><br><span class="line">        <span class="keyword">new</span> DoneWebpackPlugin()</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Compiler-1"><a href="#Compiler-1" class="headerlink" title="Compiler"></a>Compiler</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> babylon = <span class="built_in">require</span>(<span class="string">'babylon'</span>);</span><br><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"><span class="keyword">const</span> generate = <span class="built_in">require</span>(<span class="string">'babel-generator'</span>).default;</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'babel-traverse'</span>).default;</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">'ejs'</span>);</span><br><span class="line"><span class="keyword">const</span> { SyncHook } = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compiler</span> </span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options = options;</span><br><span class="line">        <span class="keyword">this</span>.hooks = {</span><br><span class="line">            entryOption: <span class="keyword">new</span> SyncHook(),</span><br><span class="line">            afterPlugins: <span class="keyword">new</span> SyncHook(),</span><br><span class="line">            run: <span class="keyword">new</span> SyncHook(),</span><br><span class="line">            compile: <span class="keyword">new</span> SyncHook(),</span><br><span class="line">            afterCompile: <span class="keyword">new</span> SyncHook(),</span><br><span class="line">            emit: <span class="keyword">new</span> SyncHook([<span class="string">"compiler"</span>]),</span><br><span class="line">            afterEmit: <span class="keyword">new</span> SyncHook(),</span><br><span class="line">            done: <span class="keyword">new</span> SyncHook()</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">let</span> plugins = options.plugins;</span><br><span class="line">        <span class="keyword">if</span> (plugins &amp;&amp; plugins.length &gt; <span class="number">0</span>) {</span><br><span class="line">            plugins.forEach(<span class="function"><span class="params">plugin</span> =&gt;</span> plugin.apply(<span class="keyword">this</span>));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">this</span>.hooks.afterPlugins.call();</span><br><span class="line">    }</span><br><span class="line">    run() {</span><br><span class="line">        <span class="keyword">this</span>.hooks.run.call(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">let</span> that = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.root = process.cwd();<span class="comment">//获取当前的工作目录</span></span><br><span class="line">        <span class="keyword">let</span> { entry } = <span class="keyword">this</span>.options;<span class="comment">//获取入口文件路径</span></span><br><span class="line">        <span class="keyword">this</span>.entryId = <span class="literal">null</span>;<span class="comment">//记录入口文件的ID</span></span><br><span class="line">        <span class="keyword">this</span>.modules = {};<span class="comment">//记录模块ID和内容的对应关系，所有的ID都是相对于根目录的</span></span><br><span class="line">        <span class="keyword">this</span>.hooks.compile.call();</span><br><span class="line">        <span class="keyword">this</span>.buildModule(path.resolve(<span class="keyword">this</span>.root, entry), <span class="literal">true</span>);<span class="comment">//从入口文件开始编译</span></span><br><span class="line">        <span class="keyword">this</span>.hooks.afterCompile.call();</span><br><span class="line">        <span class="keyword">this</span>.emitFile();</span><br><span class="line">    }</span><br><span class="line">    emitFile() {</span><br><span class="line">        <span class="keyword">this</span>.hooks.emit.call(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">let</span> mainTemplate = fs.readFileSync(path.join(__dirname, <span class="string">'main.ejs'</span>), <span class="string">'utf8'</span>);</span><br><span class="line">        <span class="keyword">let</span> { modules, entryId } = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">let</span> main = ejs.compile(mainTemplate)({ entryId, modules });</span><br><span class="line">        <span class="keyword">let</span> { <span class="attr">output</span>: { <span class="attr">path</span>: dist, filename } } = <span class="keyword">this</span>.options;</span><br><span class="line">        fs.writeFileSync(path.join(dist, filename), main);</span><br><span class="line">        <span class="keyword">this</span>.hooks.afterEmit.call();</span><br><span class="line">        <span class="keyword">this</span>.hooks.done.call();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = Compiler;</span><br></pre></td></tr></tbody></table></figure><h2 id="支持懒加载"><a href="#支持懒加载" class="headerlink" title="支持懒加载"></a>支持懒加载</h2><h3 id="Compiler-2"><a href="#Compiler-2" class="headerlink" title="Compiler"></a>Compiler</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">emitFile() {</span><br><span class="line">        <span class="keyword">this</span>.hooks.emit.call(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">let</span> mainTemplate = fs.readFileSync(path.join(__dirname, <span class="string">'main.ejs'</span>), <span class="string">'utf8'</span>);</span><br><span class="line">        <span class="keyword">let</span> { modules, entryId } = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">let</span> main = ejs.compile(mainTemplate)({ entryId, modules });</span><br><span class="line">        <span class="keyword">let</span> { <span class="attr">output</span>: { <span class="attr">path</span>: dist, filename } } = <span class="keyword">this</span>.options;</span><br><span class="line">        fs.writeFileSync(path.join(dist, filename), main);</span><br><span class="line">        <span class="built_in">Object</span>.entries(<span class="keyword">this</span>.chunks).forEach(<span class="function">(<span class="params">[chunkIndex, chunk]</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">let</span> chunkTemplate = fs.readFileSync(path.join(__dirname, <span class="string">'chunk.ejs'</span>), <span class="string">'utf8'</span>);</span><br><span class="line">            <span class="keyword">let</span> chunkData = ejs.compile(chunkTemplate)({ chunkIndex, chunk });</span><br><span class="line">            <span class="keyword">let</span> { <span class="attr">output</span>: { <span class="attr">path</span>: dist, filename } } = <span class="keyword">this</span>.options;</span><br><span class="line">            fs.writeFileSync(path.join(dist, <span class="string">`<span class="subst">${chunkIndex}</span>.bundle.js`</span>), chunkData);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">this</span>.hooks.afterEmit.call();</span><br><span class="line">        <span class="keyword">this</span>.hooks.done.call();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析模块和依赖的模块，路径是一个绝对路径</span></span><br><span class="line">    buildModule(modulePath, isEntry, chunkIndex) {</span><br><span class="line">        <span class="keyword">let</span> source = <span class="keyword">this</span>.getSource(modulePath);<span class="comment">//获取源代码</span></span><br><span class="line">        <span class="keyword">let</span> moduleId = <span class="string">'./'</span> + path.relative(<span class="keyword">this</span>.root, modulePath);<span class="comment">//生成相对于工作根目录的模块ID</span></span><br><span class="line">        <span class="keyword">if</span> (isEntry) {<span class="comment">//如果是入口的话把ID赋给入口</span></span><br><span class="line">            <span class="keyword">this</span>.entryId = moduleId;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//获取AST的编译结果 依赖的模块 转换后的源代码</span></span><br><span class="line">        <span class="keyword">let</span> { dependencies, sourcecode } = <span class="keyword">this</span>.parse(source, path.dirname(moduleId));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> chunkIndex != <span class="string">'undefined'</span>) {</span><br><span class="line">            <span class="keyword">let</span> currentChunk = <span class="keyword">typeof</span> <span class="keyword">this</span>.chunks[chunkIndex] == <span class="string">'undefined'</span> ? {} : <span class="keyword">this</span>.chunks[chunkIndex];</span><br><span class="line">            currentChunk[moduleId] = sourcecode;</span><br><span class="line">            <span class="keyword">this</span>.chunks[chunkIndex] = currentChunk;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">this</span>.modules[moduleId] = sourcecode;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//递归解析依赖的模块</span></span><br><span class="line">        dependencies.forEach(<span class="function"><span class="params">dependency</span> =&gt;</span> <span class="keyword">this</span>.buildModule(path.join(<span class="keyword">this</span>.root, dependency, chunkIndex)));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//解析源代码  传入父路径</span></span><br><span class="line">    parse(source, parentPath) {</span><br><span class="line">        <span class="keyword">let</span> that = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">const</span> ast = babylon.parse(source, {</span><br><span class="line">            plugins: [<span class="string">'dynamicImport'</span>]</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">let</span> dependencies = [];</span><br><span class="line">        traverse(ast, {</span><br><span class="line">            CallExpression(p) {</span><br><span class="line">                <span class="keyword">if</span> (p.node.callee.name == <span class="string">'require'</span>) {</span><br><span class="line">                    <span class="keyword">let</span> node = p.node;</span><br><span class="line">                    node.callee.name = <span class="string">'__webpack_require__'</span>;</span><br><span class="line">                    <span class="keyword">let</span> modName = node.arguments[<span class="number">0</span>].value;</span><br><span class="line">                    modName += (modName.lastIndexOf(<span class="string">'.'</span>) &gt; <span class="number">0</span> ? <span class="string">''</span> : <span class="string">'.js'</span>);</span><br><span class="line">                    <span class="keyword">let</span> moduleId = <span class="string">'./'</span> + path.join(parentPath, modName);</span><br><span class="line">                    dependencies.push(moduleId);</span><br><span class="line">                    node.arguments = [t.stringLiteral(moduleId)];</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (t.isImport(p.node.callee)) {</span><br><span class="line">                    <span class="keyword">let</span> node = p.node;</span><br><span class="line">                    <span class="keyword">let</span> modName = node.arguments[<span class="number">0</span>].value;<span class="comment">//取得模块名</span></span><br><span class="line">                    modName += (modName.lastIndexOf(<span class="string">'.'</span>) &gt; <span class="number">0</span> ? <span class="string">''</span> : <span class="string">'.js'</span>);</span><br><span class="line">                    <span class="keyword">let</span> moduleId = <span class="string">'./'</span> + path.join(parentPath, modName);</span><br><span class="line">                    p.replaceWithSourceString(<span class="string">`__webpack_require__.e(<span class="subst">${that.chunkIndex}</span>).then(__webpack_require__.t.bind(null, "<span class="subst">${moduleId}</span>", 7))`</span>);</span><br><span class="line">                    that.buildModule(path.join(that.root, moduleId), <span class="literal">false</span>, that.chunkIndex++);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">let</span> sourcecode = generate(ast).code;</span><br><span class="line">        <span class="keyword">return</span> { sourcecode, dependencies };</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h3 id="chunk-ejs"><a href="#chunk-ejs" class="headerlink" title="chunk.ejs"></a>chunk.ejs</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">window</span>[<span class="string">"webpackJsonp"</span>] = <span class="built_in">window</span>[<span class="string">"webpackJsonp"</span>] || []).push([[<span class="xml"><span class="tag">&lt;<span class="name">%=chunkIndex%</span>&gt;</span>],{</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">%</span></span></span></span><br><span class="line"><span class="xml">        for(let id in chunk){</span></span><br><span class="line"><span class="xml">            let source = chunk[id];%&gt;</span></span><br><span class="line"><span class="xml">        /***/ "<span class="tag">&lt;<span class="name">%-id%</span>&gt;</span>":</span></span><br><span class="line"><span class="xml">        /***/ function(module, exports,__webpack_require__) {</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        eval(`<span class="tag">&lt;<span class="name">%-source%</span>&gt;</span>`);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        /***/ },</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">%}%</span>&gt;</span></span></span><br><span class="line"><span class="xml">    }]);</span></span><br></pre></td></tr></tbody></table></figure><h3 id="index-js-1"><a href="#index-js-1" class="headerlink" title="index.js"></a>index.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> loadButton = <span class="built_in">document</span>.querySelector(<span class="string">'#loadButton'</span>);</span><br><span class="line">loadButton.addEventListener(<span class="string">'click'</span>, () =&gt; {</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">'./video'</span>).then(<span class="function"><span class="params">video</span> =&gt;</span> {</span><br><span class="line">        <span class="built_in">console</span>.log(video.default);</span><br><span class="line">    });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="video-js"><a href="#video-js" class="headerlink" title="video.js"></a>video.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="string">'video'</span>;</span><br></pre></td></tr></tbody></table></figure><hr><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://astexplorer.net/" target="_blank" rel="noopener">astexplorer</a></li><li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md" target="_blank" rel="noopener">plugin-handbook</a></li><li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#toc-babel-types" target="_blank" rel="noopener">babel-types</a></li><li><a href="https://www.npmjs.com/package/babel-types" target="_blank" rel="noopener">babel-types</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/21/plugin/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/21/plugin/" itemprop="url">plugin</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-21T15:34:52+08:00">2019-01-21 </time></span><span id="/2019/01/21/plugin/" class="leancloud_visitors" data-flag-title="plugin"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">2,423 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">12</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h2><p>插件向第三方开发者提供了 webpack 引擎中完整的能力。使用阶段式的构建回调，开发者可以引入它们自己的行为到 webpack 构建流程中。创建插件比创建 loader 更加高级，因为你将需要理解一些 webpack 底层的内部特性来做相应的钩子</p><h3 id="为什么需要一个插件"><a href="#为什么需要一个插件" class="headerlink" title="为什么需要一个插件"></a>为什么需要一个插件</h3><ul><li>webpack基础配置无法满足需求</li><li>插件几乎能够任意更改webpack编译结果</li><li>webpack内部也是通过大量内部插件实现的</li></ul><h3 id="可以加载插件的常用对象"><a href="#可以加载插件的常用对象" class="headerlink" title="可以加载插件的常用对象"></a>可以加载插件的常用对象</h3><table><thead><tr><th>对象</th><th>钩子</th></tr></thead><tbody><tr><td>Compiler</td><td>run,compile,compilation,make,emit,done</td></tr><tr><td>Compilation</td><td>buildModule,normalModuleLoader,succeedModule,finishModules,seal,optimize,after-seal</td></tr><tr><td>Module</td><td>Factory beforeResolver,afterResolver,module,parser</td></tr><tr><td>Module</td><td></td></tr><tr><td>Parser</td><td>program,statement,call,expression</td></tr><tr><td>Template</td><td>hash,bootstrap,localVars,render</td></tr></tbody></table><h3 id="创建插件"><a href="#创建插件" class="headerlink" title="创建插件"></a>创建插件</h3><p>webpack 插件由以下组成：</p><ul><li>一个 JavaScript 命名函数。</li><li>在插件函数的 prototype 上定义一个 apply 方法。</li><li>指定一个绑定到 webpack 自身的事件钩子。</li><li>处理 webpack 内部实例的特定数据。</li><li>功能完成后调用 webpack 提供的回调。</li></ul><h3 id="Compiler-和-Compilation"><a href="#Compiler-和-Compilation" class="headerlink" title="Compiler 和 Compilation"></a>Compiler 和 Compilation</h3><p>在插件开发中最重要的两个资源就是compiler和compilation对象。理解它们的角色是扩展webpack引擎重要的第一步。</p><ul><li><p><code>compiler</code> 对象代表了完整的 webpack 环境配置。这个对象在启动 webpack 时被一次性建立，并配置好所有可操作的设置，包括 options，loader 和 plugin。当在 webpack 环境中应用一个插件时，插件将收到此 compiler 对象的引用。可以使用它来访问 webpack 的主环境。</p></li><li><p><code>compilation</code> 对象代表了一次资源版本构建。当运行 webpack 开发环境中间件时，每当检测到一个文件变化，就会创建一个新的 compilation，从而生成一组新的编译资源。一个 compilation 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息。compilation 对象也提供了很多关键时机的回调，以供插件做自定义处理时选择使用。</p></li><li><p><a href="https://github.com/webpack/webpack/blob/master/lib/Compiler.js" target="_blank" rel="noopener">Compiler</a></p></li><li><p><a href="https://github.com/webpack/webpack/blob/master/lib/Compilation.js" target="_blank" rel="noopener">Compilation</a></p></li><li><a href="https://github.com/webpack/webpack/blob/master/lib/Compilation.js" target="_blank" rel="noopener">Parser</a></li><li><a href="https://github.com/webpack/webpack/blob/master/lib/Compilation.js" target="_blank" rel="noopener">NormalModuleFactory</a></li></ul><h3 id="基本插件架构"><a href="#基本插件架构" class="headerlink" title="基本插件架构"></a>基本插件架构</h3><ul><li>插件是由「具有 apply 方法的 <code>prototype</code> 对象」所实例化出来的。</li><li>这个 <code>apply</code> 方法在安装插件时，会被 <code>webpack compiler</code> 调用一次。</li><li><code>apply</code> 方法可以接收一个 <code>webpack compiler</code> 对象的引用，从而可以在回调函数中访问到 <code>compiler</code> 对象</li></ul><p>webpack/lib/webpack.js:35<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options.plugins &amp;&amp; <span class="built_in">Array</span>.isArray(options.plugins)) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> options.plugins) {</span><br><span class="line">        plugin.apply(compiler);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>一个简单的插件结构如下：<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DonePlugin</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options=options;</span><br><span class="line">    }</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.done.tap(<span class="string">'DonePlugin'</span>, ()=&gt; {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Hello '</span>,<span class="keyword">this</span>.options.name);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports=DonePlugin;</span><br></pre></td></tr></tbody></table></figure><p></p><p>然后，要安装这个插件，只需要在你的 webpack 配置的 plugin 数组中添加一个实例：<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DonePlugin=<span class="built_in">require</span>(<span class="string">'./plugins/DonePlugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports={</span><br><span class="line">    entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    output: {</span><br><span class="line">        path: path.resolve(<span class="string">'build'</span>),</span><br><span class="line">        filename:<span class="string">'bundle.js'</span></span><br><span class="line">    },</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> DonePlugin({<span class="attr">name</span>:<span class="string">'zfpx'</span>})</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack/lib/Compiler.js:251<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.emitRecords(<span class="function"><span class="params">err</span> =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> finalCallback(err);</span><br><span class="line">        <span class="keyword">this</span>.hooks.done.callAsync(stats, err =&gt; {});</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="访问-compilation-对象"><a href="#访问-compilation-对象" class="headerlink" title="访问 compilation 对象"></a>访问 compilation 对象</h3><p>使用 compiler 对象时，你可以绑定提供了编译 compilation 引用的回调函数，然后拿到每次新的 compilation 对象。这些 compilation 对象提供了一些钩子函数，来钩入到构建流程的很多步骤中。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompilationPlugin</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options=options;</span><br><span class="line">    }</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.compilation.tap(<span class="string">'CompilationPlugin'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">compilation</span>) </span>{</span><br><span class="line">            compilation.hooks.optimize.tap(<span class="string">'optimize'</span>,<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'资源正在被优化'</span>);</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports=CompilationPlugin;</span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack/lib/Compiler.js:496<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">newCompilation(params) {</span><br><span class="line">        <span class="keyword">const</span> compilation = <span class="keyword">this</span>.createCompilation();</span><br><span class="line">        <span class="keyword">this</span>.hooks.compilation.call(compilation, params);</span><br><span class="line">        <span class="keyword">return</span> compilation;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack/lib/Compilation.js:1183<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seal(callback) {</span><br><span class="line">        <span class="keyword">this</span>.hooks.seal.call();</span><br><span class="line">        <span class="keyword">this</span>.hooks.optimize.call();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>关于 compiler, compilation 的可用回调，和其它重要的对象的更多信息，请查看 <a href="https://doc.webpack-china.org/api/plugins/" target="_blank" rel="noopener">插件</a> 文档。</p><h3 id="异步编译插件"><a href="#异步编译插件" class="headerlink" title="异步编译插件"></a>异步编译插件</h3><p>有一些编译插件中的步骤是异步的，这样就需要额外传入一个 callback 回调函数，并且在插件运行结束时，必须调用这个回调函数<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompilationAsyncPlugin</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options=options;</span><br><span class="line">    }</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.emit.tapAsync(<span class="string">'EmitPlugin'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">compilation,callback</span>) </span>{</span><br><span class="line">            setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'异步任务完成'</span>);</span><br><span class="line">                callback();</span><br><span class="line">            },<span class="number">500</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports=CompilationAsyncPlugin;</span><br></pre></td></tr></tbody></table></figure><p></p><p>emit事件在即将写入文件前触发 webpack/lib/Compiler.js:364<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.hooks.emit.callAsync(compilation, err =&gt; {</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">    outputPath = compilation.getPath(<span class="keyword">this</span>.outputPath);</span><br><span class="line">    <span class="keyword">this</span>.outputFileSystem.mkdirp(outputPath, emitFiles);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="输出文件列表"><a href="#输出文件列表" class="headerlink" title="输出文件列表"></a>输出文件列表</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileListPlugin</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options = options;</span><br><span class="line">    }</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.emit.tap(<span class="string">'FileListPlugin'</span>, (compilation) =&gt;{</span><br><span class="line">            <span class="keyword">let</span> filelist=<span class="string">'## 文件列表'</span>;</span><br><span class="line">            filelist = <span class="built_in">Object</span>.keys(compilation.assets).reduce(<span class="function">(<span class="params">filelist,filename</span>)=&gt;</span>filelist+<span class="string">'\r\n- '</span>+filename,filelist);</span><br><span class="line">            compilation.assets[<span class="keyword">this</span>.options.name?<span class="keyword">this</span>.options.name:<span class="string">'filelist.md'</span>]={</span><br><span class="line">                source() {</span><br><span class="line">                    <span class="keyword">return</span> filelist;</span><br><span class="line">                },</span><br><span class="line">                size() {</span><br><span class="line">                    <span class="keyword">return</span> filelist.length</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports=FileListPlugin;</span><br></pre></td></tr></tbody></table></figure><h3 id="InlineWebpackPlugin"><a href="#InlineWebpackPlugin" class="headerlink" title="InlineWebpackPlugin"></a>InlineWebpackPlugin</h3><p>有些时候我们希望把脚本和样式单独内联在HTML页面里面</p><ul><li><a href="https://github.com/jantimon/html-webpack-plugin" target="_blank" rel="noopener">html-webpack-plugin</a></li><li><a href="https://github.com/DustinJackson/html-webpack-inline-source-plugin" target="_blank" rel="noopener">html-webpack-inline-source-plugin</a></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InlineWebpackPlugin</span> </span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options = options;</span><br><span class="line">    }</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.compilation.tap(<span class="string">'InlineWebpackPlugin'</span>, compilation =&gt; {</span><br><span class="line">            compilation.hooks.htmlWebpackPluginAlterAssetTags.tapAsync(<span class="string">'InlineWebpackPlugin'</span>, (htmlPluginData, callback) =&gt; {</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.options.inlineSource) {</span><br><span class="line">                    <span class="keyword">return</span> callback(<span class="literal">null</span>, htmlPluginData);</span><br><span class="line">                }</span><br><span class="line">                <span class="built_in">console</span>.log(htmlPluginData);</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * { head:[ { tagName: 'link',</span></span><br><span class="line"><span class="comment">                              selfClosingTag: false,</span></span><br><span class="line"><span class="comment">                              voidTag: true,</span></span><br><span class="line"><span class="comment">                              attributes: [Object] } ],</span></span><br><span class="line"><span class="comment">                    body: [ { tagName: 'script', closeTag: true, attributes: [Object] } ],</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                htmlPluginData = <span class="keyword">this</span>.processTags(compilation, htmlPluginData);</span><br><span class="line">                callback(<span class="literal">null</span>, htmlPluginData);</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    processTags(compilation, htmlPluginData) {</span><br><span class="line">        htmlPluginData.head = htmlPluginData.head.map(<span class="function"><span class="params">tag</span> =&gt;</span> <span class="keyword">this</span>.processTag(compilation, tag));</span><br><span class="line">        htmlPluginData.body = htmlPluginData.body.map(<span class="function"><span class="params">tag</span> =&gt;</span> <span class="keyword">this</span>.processTag(compilation, tag));</span><br><span class="line">        <span class="keyword">return</span> htmlPluginData;</span><br><span class="line">    }</span><br><span class="line">    processTag(compilation, tag) {</span><br><span class="line">        <span class="keyword">let</span> inlineSource = <span class="keyword">this</span>.options.inlineSource;</span><br><span class="line">        <span class="keyword">let</span> assetUrl;</span><br><span class="line">        <span class="keyword">if</span> (tag.tagName == <span class="string">'link'</span> &amp;&amp; inlineSource.test(tag.attributes.href)) {</span><br><span class="line">            assetUrl = tag.attributes.href;</span><br><span class="line">            tag = {</span><br><span class="line">                tagName: <span class="string">'style'</span>,</span><br><span class="line">                closeTag: <span class="literal">true</span>,</span><br><span class="line">                attributes: { <span class="attr">type</span>: <span class="string">'text/css'</span> }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (tag.tagName == <span class="string">'script'</span> &amp;&amp; inlineSource.test(tag.attributes.src)) {</span><br><span class="line">            assetUrl = tag.attributes.src;</span><br><span class="line">            tag = {</span><br><span class="line">                tagName: <span class="string">'script'</span>,</span><br><span class="line">                closeTag: <span class="literal">true</span>,</span><br><span class="line">                attributes: { <span class="attr">type</span>: <span class="string">'text/javascript'</span> }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (assetUrl) {</span><br><span class="line">            <span class="keyword">let</span> asset = compilation.assets[assetUrl];</span><br><span class="line">            tag.innerHTML = asset.source();</span><br><span class="line">            <span class="keyword">delete</span> compilation.assets[assetUrl];</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> tag;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = InlineWebpackPlugin;</span><br></pre></td></tr></tbody></table></figure><p>webpack.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> InlineWebpackPlugin = <span class="built_in">require</span>(<span class="string">'./plugins/InlineWebpackPlugin'</span>);</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">    mode: <span class="string">'development'</span>,</span><br><span class="line">    entry: <span class="string">"./src/index.js"</span>,</span><br><span class="line">    output: {</span><br><span class="line">        path: resolve(<span class="string">"dist"</span>),</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    },</span><br><span class="line">    resolveLoader: {</span><br><span class="line">        modules: [path.resolve(<span class="string">'./loaders'</span>), <span class="string">'node_modules'</span>]</span><br><span class="line">    },</span><br><span class="line">    <span class="built_in">module</span>: {</span><br><span class="line">        rules: [</span><br><span class="line">            {</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                use: [{ <span class="attr">loader</span>: MiniCssExtractPlugin.loader }, <span class="string">'css-loader'</span>]</span><br><span class="line">            }</span><br><span class="line">        ]</span><br><span class="line">    },</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">            template: <span class="string">'./src/index.html'</span>,</span><br><span class="line">            filename: <span class="string">'index.html'</span></span><br><span class="line">        }),</span><br><span class="line">        <span class="keyword">new</span> InlineWebpackPlugin({</span><br><span class="line">            inlineSource: <span class="regexp">/\.(js|css)$/</span></span><br><span class="line">        }),</span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin({</span><br><span class="line">            filename: <span class="string">'[name].css'</span>,</span><br><span class="line">            chunkFilename: <span class="string">'[id].css'</span></span><br><span class="line">        })</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="自动上传资源文件到CDN"><a href="#自动上传资源文件到CDN" class="headerlink" title="自动上传资源文件到CDN"></a>自动上传资源文件到CDN</h3><ul><li><a href="https://developer.qiniu.com/kodo/sdk/1289/nodejs" target="_blank" rel="noopener">qiniu</a></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> qiniu = <span class="built_in">require</span>(<span class="string">'qiniu'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadPlugin</span> </span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options = {}) {</span><br><span class="line">        <span class="keyword">let</span> { bucket = <span class="string">''</span>, domain = <span class="string">""</span>, accessKey = <span class="string">''</span>, secretKey = <span class="string">''</span> } = options;</span><br><span class="line">        <span class="keyword">let</span> mac = <span class="keyword">new</span> qiniu.auth.digest.Mac(accessKey, secretKey);</span><br><span class="line">        <span class="keyword">let</span> putPolicy = <span class="keyword">new</span> qiniu.rs.PutPolicy({ <span class="attr">scope</span>: bucket });</span><br><span class="line">        <span class="keyword">this</span>.uploadToken = putPolicy.uploadToken(mac);</span><br><span class="line">        <span class="keyword">let</span> config = <span class="keyword">new</span> qiniu.conf.Config();</span><br><span class="line">        <span class="keyword">this</span>.formUploader = <span class="keyword">new</span> qiniu.form_up.FormUploader(config);</span><br><span class="line">        <span class="keyword">this</span>.putExtra = <span class="keyword">new</span> qiniu.form_up.PutExtra();</span><br><span class="line">    }</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        compiler.hooks.afterEmit.tapPromise(<span class="string">'UploadPlugin'</span>, compilation =&gt; {</span><br><span class="line">            <span class="keyword">let</span> assets = compilation.assets;</span><br><span class="line">            <span class="keyword">let</span> promises = <span class="built_in">Object</span>.entries(assets).map(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> <span class="keyword">this</span>.upload(key, value.source()));</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.all(promises);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    upload(key, value) {</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'value'</span>, value)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">this</span>.formUploader.put(<span class="keyword">this</span>.uploadToken, key, value, <span class="keyword">this</span>.putExtra, (err, body, info) =&gt; {</span><br><span class="line">                err ? reject(err) : resolve(body);</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = UploadPlugin;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> UploadPlugin({</span><br><span class="line">    bucket: <span class="string">'cnpmjs'</span>,</span><br><span class="line">    domain: <span class="string">"img.zhufenpeixun.cn"</span>,</span><br><span class="line">    accessKey: <span class="string">'fi5imW04AkxJItuFbbRy1ffH1HIoo17HbWOXw5fV'</span>,</span><br><span class="line">    secretKey: <span class="string">'ru__Na4qIor4-V7U4AOJyp2KBUYEw1NWduiJ4Pby'</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h3 id="自动外链"><a href="#自动外链" class="headerlink" title="自动外链"></a>自动外链</h3><h4 id="使用外部类库"><a href="#使用外部类库" class="headerlink" title="使用外部类库"></a>使用外部类库</h4><ul><li>手动指定 external</li><li>手动引入 script</li></ul><p>能否检测代码中的import自动处理这个步骤?</p><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>解决import自动处理external和script的问题，需要怎么实现，该从哪方面开始考虑</p><ul><li><code>依赖</code> 当检测到有<code>import</code>该<code>library</code>时，将其设置为不打包类似exteral,并在指定模版中加入script,那么如何检测import那？这里就用<code>Parser</code></li><li><code>external依赖</code> 需要了解external是如何实现的，webpack的external是通过插件ExternalsPlugin实现的，ExternalsPlugin通过 <code>tap NormalModuleFactory</code> 在每次创建Module的时候判断是否是<code>ExternalModule</code></li><li>webpack4加入了模块类型之后，Parser获取需要指定类型moduleType,一般使用<code>javascript/auto</code>即可</li></ul><h4 id="使用plugins"><a href="#使用plugins" class="headerlink" title="使用plugins"></a>使用plugins</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">            template: <span class="string">'./src/index.html'</span>,</span><br><span class="line">            filename:<span class="string">'index.html'</span></span><br><span class="line">        }),</span><br><span class="line">        <span class="keyword">new</span> AutoExternalPlugin({</span><br><span class="line">            jquery: {</span><br><span class="line">                expose: <span class="string">'$'</span>,</span><br><span class="line">                url: <span class="string">'https://cdn.bootcss.com/jquery/3.1.0/jquery.js'</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    ]</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ExternalModule = <span class="built_in">require</span>(<span class="string">'webpack/lib/ExternalModule'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoExternalPlugin</span> </span>{</span><br><span class="line">    <span class="keyword">constructor</span>(options) {</span><br><span class="line">        <span class="keyword">this</span>.options = options;</span><br><span class="line">        <span class="keyword">this</span>.externalModules = {};</span><br><span class="line">    }</span><br><span class="line">    apply(compiler) {</span><br><span class="line">        <span class="comment">//1.在解析语法树的过程中查找那些需要外部引入的模块名称</span></span><br><span class="line">        compiler.hooks.normalModuleFactory.tap(<span class="string">'AutoExternalPlugin'</span>, normalModuleFactory =&gt; {</span><br><span class="line">            normalModuleFactory.hooks.parser</span><br><span class="line">                .for(<span class="string">'javascript/auto'</span>)</span><br><span class="line">                .tap(<span class="string">'AutoExternalPlugin'</span>, parser =&gt; {</span><br><span class="line">                    parser.hooks.import.tap(<span class="string">'AutoExternalPlugin'</span>, (statement, source) =&gt; {</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.options[source])</span><br><span class="line">                            <span class="keyword">this</span>.externalModules[source] = <span class="literal">true</span>;</span><br><span class="line">                    });</span><br><span class="line">                });</span><br><span class="line">            <span class="comment">//2.在生产模块的过程中发现如果是外部模块则返回外部模块</span></span><br><span class="line">            normalModuleFactory.hooks.factory.tap(<span class="string">'AutoExternalPlugin'</span>, factory =&gt; <span class="function">(<span class="params">data, callback</span>) =&gt;</span> {</span><br><span class="line">                <span class="keyword">const</span> dependency = data.dependencies[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">let</span> value = dependency.request;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.externalModules[value]) {</span><br><span class="line">                    <span class="keyword">let</span> varName = <span class="keyword">this</span>.options[value].expose;</span><br><span class="line">                    callback(<span class="literal">null</span>, <span class="keyword">new</span> ExternalModule(varName, <span class="string">'window'</span>));</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    factory(data, callback);</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line">        compiler.hooks.compilation.tap(<span class="string">'AutoExternalPlugin'</span>, compilation =&gt; {</span><br><span class="line">            <span class="comment">//3.向body底部插入全局变量的脚本</span></span><br><span class="line">            compilation.hooks.htmlWebpackPluginAlterAssetTags.tapAsync(<span class="string">'normalModuleFactory'</span>, (htmlPluginData, callback) =&gt; {</span><br><span class="line">                <span class="built_in">Object</span>.values(<span class="keyword">this</span>.externalModules).forEach(<span class="function"><span class="params">src</span> =&gt;</span> {</span><br><span class="line">                    htmlPluginData.body.unshift({</span><br><span class="line">                        tagName: <span class="string">'script'</span>,</span><br><span class="line">                        closeTag: <span class="literal">true</span>,</span><br><span class="line">                        attributes: { <span class="attr">type</span>: <span class="string">'text/javascript'</span>, src }</span><br><span class="line">                    });</span><br><span class="line">                });</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = AutoExternalPlugin;</span><br></pre></td></tr></tbody></table></figure><h3 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">- webpack-cli/cli.js   compiler = webpack(options);</span><br><span class="line">- webpack/webpack.js compiler = <span class="string">`new Compiler`</span>(options.context);</span><br><span class="line">- webpack-cli/cli.js   compiler.<span class="string">`run`</span>(compilerCallback);</span><br><span class="line">- Compiler.js <span class="string">`run`</span>(callback)</span><br><span class="line">-             <span class="keyword">this</span>.hooks.<span class="string">`beforeRun`</span>.callAsync</span><br><span class="line">-             <span class="keyword">this</span>.hooks.<span class="string">`run`</span>.callAsync</span><br><span class="line">-             <span class="keyword">this</span>.<span class="string">`readRecords`</span></span><br><span class="line">-             <span class="keyword">this</span>.<span class="string">`compile`</span>(onCompiled);</span><br><span class="line">-             <span class="keyword">const</span> params = <span class="keyword">this</span>.newCompilationParams();</span><br><span class="line">-             <span class="keyword">this</span>.hooks.<span class="string">`beforeCompile`</span>.callAsync</span><br><span class="line">-             <span class="keyword">this</span>.hooks.<span class="string">`compile`</span>.call(params);</span><br><span class="line">-             <span class="keyword">const</span> compilation = <span class="keyword">this</span>.newCompilation(params);</span><br><span class="line">-             <span class="keyword">this</span>.hooks.<span class="string">`make`</span>.callAsync</span><br><span class="line">- SingleEntryPlugin.js compilation.addEntry(context, dep, name, callback);</span><br><span class="line">- Compilation.js addEntry</span><br><span class="line">-                <span class="keyword">this</span>._addModuleChain</span><br><span class="line">-                <span class="keyword">const</span> moduleFactory = <span class="keyword">this</span>.dependencyFactories.get(Dep);</span><br><span class="line">-                moduleFactory.create</span><br><span class="line">- NormalModuleFactory create(data, callback)</span><br><span class="line">-                      <span class="keyword">this</span>.hooks.<span class="string">`beforeResolve`</span>.callAsync</span><br><span class="line">-                      <span class="keyword">const</span> factory = <span class="keyword">this</span>.hooks.factory.call(<span class="literal">null</span>);</span><br><span class="line">-                      factory(result, (err, <span class="built_in">module</span>)</span><br><span class="line">-                      <span class="keyword">let</span> resolver = <span class="keyword">this</span>.hooks.resolver.call(<span class="literal">null</span>);</span><br><span class="line">-                      resolver(result</span><br><span class="line">-                      <span class="keyword">this</span>.hooks.resolver.tap(<span class="string">"NormalModuleFactory"</span></span><br><span class="line">-                      <span class="keyword">const</span> result = <span class="keyword">this</span>.ruleSet.exec({</span><br><span class="line">-                     getParser(type, parserOptions) </span><br><span class="line">-                     <span class="keyword">this</span>.hooks.afterResolve.callAsync</span><br><span class="line">-                     <span class="keyword">let</span> createdModule = <span class="keyword">this</span>.hooks.createModule.call(result);</span><br><span class="line">-                     createdModule = <span class="keyword">new</span> NormalModule(result);</span><br><span class="line">-                     createdModule = <span class="keyword">this</span>.hooks.<span class="string">`module`</span>.call(createdModule, result); </span><br><span class="line">- Compilation.js      <span class="keyword">const</span> addModuleResult = <span class="keyword">this</span>.addModule(<span class="built_in">module</span>);</span><br><span class="line">-                     <span class="keyword">this</span>.buildModule(<span class="built_in">module</span></span><br><span class="line">-                     <span class="keyword">this</span>.hooks.buildModule.call(<span class="built_in">module</span>);</span><br><span class="line">-                     <span class="built_in">module</span>.build(</span><br><span class="line">- NormalModule.js     build(options, compilation, resolver, fs, callback) </span><br><span class="line">-                     <span class="keyword">return</span> <span class="keyword">this</span>.doBuild(options, compilation, resolver, fs</span><br><span class="line">-                     runLoaders()</span><br><span class="line">-                     <span class="keyword">this</span>._source = <span class="keyword">this</span>.createSource(</span><br><span class="line">-                     <span class="keyword">this</span>._ast =</span><br><span class="line">-                      <span class="keyword">const</span> result = <span class="keyword">this</span>.parser.parse(<span class="keyword">this</span>._ast</span><br><span class="line">- Compilation.js      <span class="keyword">this</span>.hooks.succeedModule.call(<span class="built_in">module</span>);</span><br><span class="line">-                        <span class="keyword">this</span>.processModuleDependencies</span><br><span class="line">-                          <span class="keyword">if</span> (<span class="built_in">module</span>) </span><br><span class="line">- Compiler.js        compilation.finish()</span><br><span class="line">-                    compilation.seal</span><br><span class="line">-                    <span class="keyword">this</span>.hooks.afterCompile</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developer.qiniu.com/kodo/sdk/1289/nodejs" target="_blank" rel="noopener">Node.js SDK</a></li><li><a href="https://webpack.js.org/contribute/writing-a-plugin/" target="_blank" rel="noopener">writing-a-plugin</a></li><li><a href="https://webpack.js.org/api/plugins/" target="_blank" rel="noopener">api/plugins</a></li><li><a href="http://www.css88.com/doc/webpack2/api/plugins/" target="_blank" rel="noopener">插件 API</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/15/loader/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/15/loader/" itemprop="url">loader</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-15T11:34:48+08:00">2019-01-15 </time></span><span id="/2019/01/15/loader/" class="leancloud_visitors" data-flag-title="loader"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">5,889 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">28</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="loader运行的总体流程-一个函数"><a href="#loader运行的总体流程-一个函数" class="headerlink" title="loader运行的总体流程(一个函数)"></a>loader运行的总体流程(一个函数)</h2><p><img src="http://b.zhangyapeng.club/loader-2019115113541.jpg" alt="loader-2019115113541"></p><h2 id="loader配置"><a href="#loader配置" class="headerlink" title="loader配置"></a>loader配置</h2><p><code>loader</code>是导出为一个<code>函数</code>的node模块。该函数在<code>loader</code>转换资源的时候调用。给定的函数将调用<code>loader API</code>(loaderContext)，并通过<code>this</code>上下文访问。</p><h3 id="匹配-test-单个-loader"><a href="#匹配-test-单个-loader" class="headerlink" title="匹配(test)单个 loader"></a>匹配(test)单个 loader</h3><p>匹配(test)单个 <code>loader</code>，你可以简单通过在 <strong>rule</strong> 对象设置 <code>path.resolve</code> 指向这个本地文件<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  test: <span class="regexp">/\.js$/</span></span><br><span class="line">  use: [</span><br><span class="line">    {</span><br><span class="line">      loader: path.resolve(<span class="string">'path/to/loader.js'</span>),</span><br><span class="line">      options: {<span class="comment">/* ... */</span>}</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="匹配-test-多个-loaders"><a href="#匹配-test-多个-loaders" class="headerlink" title="匹配(test)多个 loaders"></a>匹配(test)多个 loaders</h3><p>你可以使用 <code>resolveLoader.modules</code> 配置，<code>webpack</code> 将会从这些目录中搜索这些 <code>loaders</code><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolveLoader: {</span><br><span class="line">   modules: [path.resolve(<span class="string">'node_modules'</span>), path.resolve(__dirname, <span class="string">'src'</span>, <span class="string">'loaders'</span>)]</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="npm-link"><a href="#npm-link" class="headerlink" title="npm link"></a>npm link</h3><ul><li>确保正在开发的本地<code>Npm</code> 模块（也就是正在开发的 Loader）的 <code>package.json</code> 已经正确配置好； 在本地 <code>Npm</code> 模块根目录下执行 <code>npm link</code>，把本地模块注册到全局；</li><li>在项目根目录下执行<code>npm link loader-name</code>，把第2步注册到全局的本地 <code>Npm</code> 模块链接到项目的 <code>node_moduels</code> 下，其中的 - <code>loader-name</code> 是指在第1步中的 <code>package.json</code> 文件中配置的模块名称。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm link</span><br></pre></td></tr></tbody></table></figure><h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resolveLoader: {</span><br><span class="line">        alias: {</span><br><span class="line">            <span class="string">"babel-loader"</span>: resolve(<span class="string">'./loaders/babel-loader.js'</span>),</span><br><span class="line">            <span class="string">"css-loader"</span>: resolve(<span class="string">'./loaders/css-loader.js'</span>),</span><br><span class="line">            <span class="string">"style-loader"</span>: resolve(<span class="string">'./loaders/style-loader.js'</span>),</span><br><span class="line">            <span class="string">"file-loader"</span>: resolve(<span class="string">'./loaders/file-loader.js'</span>),</span><br><span class="line">            <span class="string">"url-loader"</span>: resolve(<span class="string">'./loaders/url-loader.js'</span>)</span><br><span class="line">        }</span><br><span class="line">    },</span><br></pre></td></tr></tbody></table></figure><hr><h2 id="loader用法"><a href="#loader用法" class="headerlink" title="loader用法"></a>loader用法</h2><h3 id="单个loader用法"><a href="#单个loader用法" class="headerlink" title="单个loader用法"></a>单个loader用法</h3><ul><li>当一个 <strong>loader</strong> 在资源中使用，这个 <strong>loader</strong> 只能传入一个参数 - 这个参数是一个包含<code>资源文件内容的字符串</code></li><li>同步 <strong>loader</strong> 可以简单的返回一个代表模块转化后的值。</li><li>在更复杂的情况下，<code>loader</code> 也可以通过使用 <code>this.callback(err, values...)</code>函数，返回任意数量的值。错误要么传递给这个<code>this.callback</code> 函数，要么扔进同步 <code>loader</code> 中。</li><li><code>loader</code>只能传入一个包含包含资源文件内容的字符串</li><li>同步 <code>loader</code>可以简单的返回一个代表模块转化后的值</li><li>loader 也可以通过使用 <code>this.callback(err, values...)</code> 函数，返回任意数量的值</li><li>loader 会返回<strong>一个或者两个值</strong>。第一个值的类型是 <code>JavaScript</code> 代码的<code>字符串</code>或者 <code>buffer</code>。第二个参数值是<code>SourceMap</code>，它是个 <code>JavaScript</code> 对象</li></ul><h3 id="多个loader"><a href="#多个loader" class="headerlink" title="多个loader"></a>多个loader</h3><p>当链式调用多个 <strong>loader</strong>的时候，请记住它们会以相反的顺序执行。取决于数组写法格式，从<code>右向左</code>或者从<code>下向上</code>执行。</p><ul><li>最后的 loader 最早调用，将会传入原始资源内容。</li><li>第一个 loader 最后调用，期望值是传出 <code>JavaScript</code> 和 <code>source map</code>（可选）。</li><li>中间的 loader 执行时，会传入前一个 <code>loader</code> 传出的结果。</li></ul><h3 id="单个loader用法-1"><a href="#单个loader用法-1" class="headerlink" title="单个loader用法"></a>单个loader用法</h3><ul><li>最后的 <code>loader</code> 最早调用，将会传入原始资源内容。</li><li>第一个 <code>loader</code> 最后调用，期望值是传出 <code>JavaScript</code> 和 <code>source map</code>（可选）。</li><li>中间的<code>loader</code> 执行时，会传入前一个 <code>loader</code> 传出的结果。</li></ul><hr><h2 id="用法准则"><a href="#用法准则" class="headerlink" title="用法准则"></a>用法准则</h2><h3 id="简单"><a href="#简单" class="headerlink" title="简单"></a>简单</h3><p><code>loaders</code> 应该只做单一任务。这不仅使每个 <code>loader</code> 易维护，也可以在更多场景链式调用。</p><h3 id="链式-Chaining"><a href="#链式-Chaining" class="headerlink" title="链式(Chaining)"></a>链式(Chaining)</h3><p>利用 <code>loader</code> 可以链式调用的优势。写五个简单的 <code>loader</code> 实现五项任务，而不是一个 <code>loader</code> 实现五项任务</p><h3 id="模块化-Modular"><a href="#模块化-Modular" class="headerlink" title="模块化(Modular)"></a>模块化(Modular)</h3><p>保证输出模块化。<code>loader</code> 生成的模块与普通模块遵循相同的设计原则。</p><h3 id="无状态-Stateless"><a href="#无状态-Stateless" class="headerlink" title="无状态(Stateless)"></a>无状态(Stateless)</h3><p>确保 <code>loader</code> 在不同模块转换之间不保存状态。每次运行都应该独立于其他编译模块以及相同模块之前的编译结果。</p><h3 id="loader-工具库-Loader-Utilities"><a href="#loader-工具库-Loader-Utilities" class="headerlink" title="loader 工具库(Loader Utilities)"></a>loader 工具库(Loader Utilities)</h3><p><a href="https://github.com/webpack/loader-utils" target="_blank" rel="noopener">loader-utils</a> 包。它提供了许多有用的工具，但最常用的一种工具是获取传递给 <code>loader</code> 的选项</p><p><a href="https://github.com/webpack-contrib/schema-utils" target="_blank" rel="noopener">schema-utils</a> 包配合 <code>loader-utils</code>，用于保证 <code>loader</code> 选项，进行与 <code>JSON Schema</code> 结构一致的校验</p><h3 id="loader-依赖-Loader-Dependencies"><a href="#loader-依赖-Loader-Dependencies" class="headerlink" title="loader 依赖(Loader Dependencies)"></a>loader 依赖(Loader Dependencies)</h3><p>如果一个 <code>loader</code> 使用外部资源（例如，从文件系统读取），必须声明它。这些信息用于使缓存 <code>loaders</code> 无效，以及在观察模式(watch mode)下重编译。</p><h3 id="模块依赖-Module-Dependencies"><a href="#模块依赖-Module-Dependencies" class="headerlink" title="模块依赖(Module Dependencies)"></a>模块依赖(Module Dependencies)</h3><p>根据模块类型，可能会有不同的模式指定依赖关系。例如在 <code>CSS</code> 中，使用 <code>@import</code> 和 <code>url(...)</code> 语句来声明依赖。这些依赖关系应该由模块系统解析。</p><h3 id="绝对路径-Absolute-Paths"><a href="#绝对路径-Absolute-Paths" class="headerlink" title="绝对路径(Absolute Paths)"></a>绝对路径(Absolute Paths)</h3><p>不要在模块代码中插入绝对路径，因为当项目根路径变化时，文件绝对路径也会变化。<code>loader-utils</code> 中的 <code>stringifyRequest</code> 方法，可以将绝对路径转化为相对路径。</p><h3 id="同等依赖-Peer-Dependencies"><a href="#同等依赖-Peer-Dependencies" class="headerlink" title="同等依赖(Peer Dependencies)"></a>同等依赖(Peer Dependencies)</h3><p>如果你的 <code>loader</code> 简单包裹另外一个包，你应该把这个包作为一个 <code>peerDependency</code> 引入。<br>这种方式允许应用程序开发者在必要情况下，在 <code>package.json</code> 中指定所需的确定版本。</p><hr><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="缓存结果"><a href="#缓存结果" class="headerlink" title="缓存结果"></a>缓存结果</h3><p><code>webpack</code>充分地利用缓存来提高编译效率<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.cacheable();</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>当一个 <code>Loader</code> 无依赖，可异步的时候我想都应该让它不再阻塞地去异步<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让 Loader 缓存</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">    <span class="comment">// 做异步的事</span></span><br><span class="line">    doSomeAsyncOperation(content, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>{</span><br><span class="line">        <span class="keyword">if</span>(err) <span class="keyword">return</span> callback(err);</span><br><span class="line">        callback(<span class="literal">null</span>, result);</span><br><span class="line">    });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="raw-loader"><a href="#raw-loader" class="headerlink" title="raw loader"></a>raw loader</h3><p>默认的情况源文件是以 <code>UTF-8</code>字符串的形式传入给 <code>Loader</code>,设置<code>module.exports.raw = true</code>可使用 <code>buffer</code> 的形式进行处理<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.raw = <span class="literal">true</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="获得-Loader-的-options"><a href="#获得-Loader-的-options" class="headerlink" title="获得 Loader 的 options"></a>获得 Loader 的 options</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>{</span><br><span class="line">  <span class="comment">// 获取到用户给当前 Loader 传入的 options</span></span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h3 id="返回其它结果"><a href="#返回其它结果" class="headerlink" title="返回其它结果"></a>返回其它结果</h3><p><code>Loader</code>有些场景下还需要返回除了内容之外的东西<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>{</span><br><span class="line">  <span class="comment">// 通过 this.callback 告诉 Webpack 返回的结果</span></span><br><span class="line">  <span class="keyword">this</span>.callback(<span class="literal">null</span>, source, sourceMaps);</span><br><span class="line">  <span class="comment">// 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined，</span></span><br><span class="line">  <span class="comment">// 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中 </span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>完整格式(<code>见NormalModule.js----&gt;runLoaders</code>)<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.callback(</span><br><span class="line">    <span class="comment">// 当无法转换原内容时，给 Webpack 返回一个 Error</span></span><br><span class="line">    err: <span class="built_in">Error</span> | <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// 原内容转换后的内容</span></span><br><span class="line">    content: string | Buffer,</span><br><span class="line">    <span class="comment">// 用于把转换后的内容得出原内容的 Source Map，方便调试</span></span><br><span class="line">    sourceMap?: SourceMap,</span><br><span class="line">    <span class="comment">// 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回，</span></span><br><span class="line">    <span class="comment">// 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能</span></span><br><span class="line">    abstractSyntaxTree?: AST</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h3><p><code>Loader</code> 有同步和异步之分，上面介绍的<code>Loader</code> 都是同步的 <code>Loader</code>，因为它们的转换流程都是同步的，转换完成后再返回结果。 但在有些场景下转换的步骤只能是异步完成的，例如你需要通过网络请求才能得出结果，如果采用同步的方式网络请求就会阻塞整个构建，导致构建非常缓慢。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="comment">// 告诉 Webpack 本次转换是异步的，Loader 会在 callback 中回调结果</span></span><br><span class="line">    <span class="keyword">var</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">    someAsyncOperation(source, <span class="function"><span class="keyword">function</span>(<span class="params">err, result, sourceMaps, ast</span>) </span>{</span><br><span class="line">        <span class="comment">// 通过 callback 返回异步执行后的结果</span></span><br><span class="line">        callback(err, result, sourceMaps, ast);</span><br><span class="line">    });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="处理二进制数据"><a href="#处理二进制数据" class="headerlink" title="处理二进制数据"></a>处理二进制数据</h3><p>在默认的情况下，<code>Webpack</code> 传给 <code>Loader</code> 的原内容都是 <code>UTF-8</code> 格式编码的字符串。 但有些场景下 <code>Loader</code> 不是处理文本文件，而是处理二进制文件，例如 <code>file-loader</code>，就需要 <code>Webpack</code> 给 <code>Loader</code> 传入二进制格式的数据。 为此，你需要这样编写 <code>Loader</code>：<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="comment">// 在 exports.raw === true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的</span></span><br><span class="line">    source <span class="keyword">instanceof</span> Buffer === <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// Loader 返回的类型也可以是 Buffer 类型的</span></span><br><span class="line">    <span class="comment">// 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果</span></span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">};</span><br><span class="line"><span class="comment">// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据 </span></span><br><span class="line"><span class="built_in">module</span>.exports.raw = <span class="literal">true</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>在有些情况下，有些转换操作需要大量计算非常<code>耗时</code>，如果每次构建都重新执行重复的转换操作，构建将会变得非常缓慢。 为此，<code>Webpack</code>会<strong>默认缓存</strong>所有<code>Loader</code> 的处理结果，也就是说在需要被处理的文件或者其依赖的文件没有发生变化时， 是不会重新调用对应的 <code>Loader</code> 去执行转换操作的。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>{</span><br><span class="line">  <span class="comment">// 关闭该 Loader 的缓存功能</span></span><br><span class="line">  <span class="keyword">this</span>.cacheable(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="其它-Loader-API"><a href="#其它-Loader-API" class="headerlink" title="其它 Loader API"></a>其它 Loader API</h3><ul><li><a href="https://webpack.docschina.org/api/loaders/#%E5%90%8C%E6%AD%A5-loader" target="_blank" rel="noopener">完整API</a></li></ul><table><thead><tr><th>方法名</th><th>含义</th></tr></thead><tbody><tr><td>this.context</td><td>当前处理文件的所在目录，假如当前 Loader 处理的文件是 /src/main.js，则 this.context 就等于 /src</td></tr><tr><td>this.resource</td><td>当前处理文件的完整请求路径，包括 querystring，例如 /src/main.js?name=1。</td></tr><tr><td>this.resourcePath</td><td>当前处理文件的路径，例如 /src/main.js</td></tr><tr><td>this.resourceQuery</td><td>当前处理文件的 querystring</td></tr><tr><td>this.target</td><td>等于 Webpack 配置中的 Target</td></tr><tr><td>this.loadModule</td><td>但 Loader 在处理一个文件时，如果依赖其它文件的处理结果才能得出当前文件的结果时,就可以通过 this.loadModule(request: string,</td><td>callback: function(err, source, sourceMap, module)) 去获得 request 对应文件的处理结果</td></tr><tr><td>this.resolve</td><td>像 require 语句一样获得指定文件的完整路径，使用方法为 resolve(context: string, request: string, callback: function(err, result: string))</td></tr><tr><td>this.addDependency</td><td>给当前处理文件添加其依赖的文件，以便再其依赖的文件发生变化时，会重新调用 Loader 处理该文件。使用方法为 addDependency(file: string)</td></tr><tr><td>this.addContextDependency</td><td>和 addDependency 类似，但 addContextDependency 是把整个目录加入到当前正在处理文件的依赖中。使用方法为 addContextDependency(directory: string)</td></tr><tr><td>this.clearDependencies</td><td>清除当前正在处理文件的所有依赖，使用方法为 clearDependencies()</td></tr><tr><td>this.emitFile</td><td>输出一个文件，使用方法为 emitFile(name: string, content: Buffer/string, sourceMap: {…})</td></tr><tr><td>loader-utils.stringifyRequest</td><td>Turns a request into a string that can be used inside require() or import while avoiding absolute paths. Use it instead of JSON.stringify(…) if you’re generating code inside a loader 把一个请求字符串转成一个字符串，以便能在require或者import中使用以避免绝对路径。如果你在一个loder中生成代码的话请使用这个而不要用JSON.stringify()</td></tr><tr><td>loader-utils.interpolateName</td><td>Interpolates a filename template using multiple placeholders and/or a regular expression. The template and regular expression are set as query params called name and regExp on the current loader’s context. 使用多个占位符或一个正则表达式转换一个文件名的模块。这个模板和正则表达式被设置为查询参数，在当前loader的上下文中被称为name或者regExp</td></tr></tbody></table><h2 id="loader实战"><a href="#loader实战" class="headerlink" title="loader实战"></a>loader实战</h2><hr><ul><li>loader-utils</li><li>schema-utils</li><li>this.async</li><li>this.cacheable</li><li>getOptions</li><li>validateOptions</li><li>addDependency</li></ul><hr><h3 id="babel-loader"><a href="#babel-loader" class="headerlink" title="babel-loader"></a>babel-loader</h3><ul><li><a href="https://babeljs.io/docs/en/babel-core/" target="_blank" rel="noopener">babel-core</a></li><li><a href="https://github.com/babel/babel-loader/blob/master/src/index.js" target="_blank" rel="noopener">babel-loader</a></li><li><p><a href="https://babeljs.io/docs/en/babel-plugin-transform-react-jsx/" target="_blank" rel="noopener">babel-plugin-transform-react-jsx</a></p></li><li><p>this.request=<code>/loaders/babel-loader.js!/src/index.js'</code></p></li><li>this.userRequest = <code>/src/index.js</code></li><li>this.rawRequest = <code>./src/index.js</code></li><li>this.resourcePath = <code>/src/index.js</code></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babel=<span class="built_in">require</span>(<span class="string">'babel-core'</span>);</span><br><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports=<span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">const</span> options = {</span><br><span class="line">        presets: [<span class="string">'env'</span>],</span><br><span class="line">        sourceMap: <span class="literal">true</span>,</span><br><span class="line">        filename:<span class="keyword">this</span>.request.split(<span class="string">'/'</span>).pop()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">let</span> result=babel.transform(source,options);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.callback(<span class="literal">null</span>,result.code,result.map);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resolveLoader: {</span><br><span class="line">    alias: {</span><br><span class="line">      <span class="string">"babel-loader"</span>: resolve(<span class="string">'./build/babel-loader.js'</span>)</span><br><span class="line">    }</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><h3 id="BannerLoader"><a href="#BannerLoader" class="headerlink" title="BannerLoader"></a>BannerLoader</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> validateOptions = <span class="built_in">require</span>(<span class="string">'schema-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="comment">//把loader改为异步,任务完成后需要手工执行callback</span></span><br><span class="line">    <span class="keyword">let</span> cb = <span class="keyword">this</span>.async();</span><br><span class="line">    <span class="comment">//启用loader缓存</span></span><br><span class="line">    <span class="keyword">this</span>.cacheable &amp;&amp; <span class="keyword">this</span>.cacheable();</span><br><span class="line">    <span class="comment">//用来验证options的合法性</span></span><br><span class="line">    <span class="keyword">let</span> schema = { </span><br><span class="line">        type: <span class="string">'object'</span>,</span><br><span class="line">        properties: {</span><br><span class="line">            filename: {</span><br><span class="line">                type: <span class="string">'string'</span></span><br><span class="line">            },</span><br><span class="line">            text: {</span><br><span class="line">                type: <span class="string">'string'</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//通过工具方法获取options</span></span><br><span class="line">    <span class="keyword">let</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//用来验证options的合法性</span></span><br><span class="line">    validateOptions(schema, options, <span class="string">'Banner-Loader'</span>);</span><br><span class="line">    <span class="keyword">let</span> { text, filename } = options;</span><br><span class="line">    <span class="keyword">if</span> (text) {</span><br><span class="line">        cb(<span class="literal">null</span>, text + source);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (filename) {</span><br><span class="line">        fs.readFile(filename, <span class="string">'utf8'</span>, (err, text) =&gt; {</span><br><span class="line">            cb(err, text + source);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br></pre></td></tr></tbody></table></figure><p><code>banner.js</code><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*zfpx*/</span></span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">options:{</span><br><span class="line">  filename:<span class="string">"./src/loaders/banner.js"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="pitch"><a href="#pitch" class="headerlink" title="pitch"></a>pitch</h2><blockquote><p>The loaders are called from right to left. But in some cases loaders do not care about the results of the previous loader or the resource. They only care for metadata. The pitch method on the loaders is called from left to right before the loaders are called. If a loader delivers a result in the pitch method the process turns around and skips the remaining loaders, continuing with the calls to the more left loaders. data can be passed between pitch and normal call.</p></blockquote><blockquote><p>In the complex case, when multiple loaders are chained, only the last loader gets the resource file and only the first loader is expected to give back one or two values (JavaScript and SourceMap). Values that any other loader give back are passed to the previous loader.</p></blockquote><ul><li>比如a!b!c!module, 正常调用顺序应该是c、b、a，但是真正调用顺序是 a(pitch)、b(pitch)、c(pitch)、c、b、a,如果其中任何一个pitching loader返回了值就相当于在它以及它右边的loader已经执行完毕</li><li>比如如果b返回了字符串”result b”, 接下来只有a会被系统执行，且a的loader收到的参数是result b</li><li>loader根据返回值可以分为两种，一种是返回js代码（一个module的代码，含有类似module.export语句）的loader，还有不能作为最左边loader的其他loader</li><li>有时候我们想把两个第一种loader chain起来，比如style-loader!css-loader! 问题是css-loader的返回值是一串js代码，如果按正常方式写style-loader的参数就是一串代码字符串</li><li>为了解决这种问题，我们需要在style-loader里执行require(css-loader!resouce)</li></ul><h3 id="pitch与loader本身方法的执行顺序图"><a href="#pitch与loader本身方法的执行顺序图" class="headerlink" title="pitch与loader本身方法的执行顺序图"></a>pitch与loader本身方法的执行顺序图</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|- a-loader `pitch`</span><br><span class="line">  |- b-loader `pitch`</span><br><span class="line">    |- c-loader `pitch`</span><br><span class="line">      |- requested module is picked up as a dependency</span><br><span class="line">    |- c-loader normal execution</span><br><span class="line">  |- b-loader normal execution</span><br><span class="line">|- a-loader normal execution</span><br></pre></td></tr></tbody></table></figure><h3 id="log-loader1-js"><a href="#log-loader1-js" class="headerlink" title="log-loader1.js"></a>log-loader1.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source就是接收到的源文件的内容</span></span><br><span class="line"><span class="keyword">let</span> loader = <span class="function"><span class="keyword">function</span> (<span class="params">source, sourceMaps, extra</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> cb = <span class="keyword">this</span>.async();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'loader1'</span>);</span><br><span class="line">    cb(<span class="literal">null</span>, source);</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br><span class="line">loader.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">remainingRequest,previousRequest,data</span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'pitch1'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="log-loader2-js"><a href="#log-loader2-js" class="headerlink" title="log-loader2.js"></a>log-loader2.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source就是接收到的源文件的内容</span></span><br><span class="line"><span class="keyword">let</span> loader = <span class="function"><span class="keyword">function</span> (<span class="params">source, sourceMaps, extra</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> cb = <span class="keyword">this</span>.async();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'loader2'</span>);</span><br><span class="line">    cb(<span class="literal">null</span>, source);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br><span class="line">loader.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">remainingRequest,previousRequest,data</span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'pitch2'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"2"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="log-loader3-js"><a href="#log-loader3-js" class="headerlink" title="log-loader3.js"></a>log-loader3.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source就是接收到的源文件的内容</span></span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">let</span> loader = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> cb = <span class="keyword">this</span>.async();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'loader3'</span>);</span><br><span class="line">    cb(<span class="literal">null</span>, source);</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br><span class="line">loader.pitch = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'pitch3'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">  use:[path.resolve(<span class="string">'src/loaders/log-loader1'</span>),path.resolve(<span class="string">'src/loaders/log-loader2'</span>),path.resolve(<span class="string">'src/loaders/log-loader3'</span>)]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="css"><a href="#css" class="headerlink" title="css"></a>css</h3><ul><li><a href="https://github.com/webpack-contrib/css-loader/blob/master/lib/loader.js" target="_blank" rel="noopener">css-loader</a> 的作用是处理css中的 @import 和 url 这样的外部资源</li><li><a href="https://github.com/webpack-contrib/style-loader/blob/master/index.js" target="_blank" rel="noopener">style-loader</a> 的作用是把样式插入到 DOM中，方法是在head中插入一个style标签，并把样式写入到这个标签的 innerHTML里</li><li><a href="https://github.com/webpack-contrib/less-loader" target="_blank" rel="noopener">less-loader</a> Compiles Less to CSS</li><li><a href="https://webpack.js.org/api/loaders/#pitching-loader" target="_blank" rel="noopener">pitching-loader</a></li><li><a href="https://github.com/webpack/loader-utils" target="_blank" rel="noopener">loader-utils</a></li><li><p><a href="https://webpack.js.org/concepts/loaders/#configuration" target="_blank" rel="noopener">!!</a></p></li><li><p>post(后置)+inline(内联)+normal(正常)+pre(前置)</p></li><li><p><code>!</code> noAutoLoaders 所有的普通loader都不要执行</p></li><li><code>!!</code> noPrePostAutoLoaders 不要前后置loader</li><li><code>-!</code> noPreAutoLoaders 不要前置loader</li></ul><h3 id="less-loader-js"><a href="#less-loader-js" class="headerlink" title="less-loader.js"></a>less-loader.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> less = <span class="built_in">require</span>(<span class="string">'less'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">    less.render(source, { <span class="attr">filename</span>: <span class="keyword">this</span>.resource }, (err, output) =&gt; {</span><br><span class="line">        <span class="keyword">this</span>.callback(err, output.css);</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>有些时间我们希望<code>less-loader</code>可以放在use数组最左边，最左边要求返回一个<code>JS脚本</code><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> less=<span class="built_in">require</span>(<span class="string">'less'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports=<span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">    less.render(source,(err,output) =&gt; {</span><br><span class="line">        callback(err, <span class="string">`module.exports = <span class="subst">${<span class="built_in">JSON</span>.stringify(output.css)}</span>`</span>);</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="css-loader-js"><a href="#css-loader-js" class="headerlink" title="css-loader.js"></a>css-loader.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="style-loader"><a href="#style-loader" class="headerlink" title="style-loader"></a>style-loader</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> loaderUtils=<span class="built_in">require</span>(<span class="string">"loader-utils"</span>);</span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> script=(<span class="string">`</span></span><br><span class="line"><span class="string">      let style = document.createElement("style");</span></span><br><span class="line"><span class="string">      style.innerHTML = <span class="subst">${<span class="built_in">JSON</span>.stringify(source)}</span>;</span></span><br><span class="line"><span class="string">      document.head.appendChild(style);</span></span><br><span class="line"><span class="string">    `</span>);</span><br><span class="line">    <span class="keyword">return</span> script;</span><br><span class="line">} </span><br><span class="line"><span class="comment">//pitch里的参数可不是文件内容，而是文件的请求路径</span></span><br><span class="line"><span class="comment">//pitch request就是你要加载的文件路径 //index.less</span></span><br><span class="line">loader.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">request</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> style = <span class="string">`</span></span><br><span class="line"><span class="string">    var style = document.createElement("style");</span></span><br><span class="line"><span class="string">    style.innerHTML = require(<span class="subst">${loaderUtils.stringifyRequest(<span class="keyword">this</span>, <span class="string">"!!"</span> + request)}</span>);</span></span><br><span class="line"><span class="string">    document.head.appendChild(style);</span></span><br><span class="line"><span class="string"> `</span>;</span><br><span class="line">    <span class="keyword">return</span> style;</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br></pre></td></tr></tbody></table></figure><h3 id="bundle"><a href="#bundle" class="headerlink" title="bundle"></a>bundle</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line"> <span class="string">"./loaders/css-loader.js!./loaders/less-loader.js!./src/index.less"</span>:</span><br><span class="line"><span class="comment">/*!*************************************************************************!*\</span></span><br><span class="line"><span class="comment">  !*** ./loaders/css-loader.js!./loaders/less-loader.js!./src/index.less ***!</span></span><br><span class="line"><span class="comment">  \*************************************************************************/</span></span><br><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>{</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"let lists = [];\r\nlists.push(\"div {\\n  color: red;\\n}\\nbody {\\n  background: \")\r\nlists.push(\"url(\"+__webpack_require__(/*! ./baidu.png */ \"./src/baidu.png\")+\")\")\r\nlists.push(\";\\n}\\n\")\r\nmodule.exports = lists.join('')\n\n//# sourceURL=webpack:///./src/index.less?./loaders/css-loader.js!./loaders/less-loader.js"</span>);</span><br><span class="line"></span><br><span class="line"> }),</span><br><span class="line"> <span class="string">"./src/baidu.png"</span>:</span><br><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>{</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"module.exports = __webpack_require__.p + \"b15c113aeddbeb606d938010b88cf8e6.png\";\n\n//# sourceURL=webpack:///./src/baidu.png?"</span>);</span><br><span class="line"> }),</span><br><span class="line"> <span class="string">"./src/index.js"</span>:</span><br><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>{</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _index_less__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index.less */ \"./src/index.less\");\n/* harmony import */ var _index_less__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_index_less__WEBPACK_IMPORTED_MODULE_0__);\n\n\n//# sourceURL=webpack:///./src/index.js?"</span>);</span><br><span class="line"> }),</span><br><span class="line"> <span class="string">"./src/index.less"</span>:</span><br><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>{</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"\n    var style = document.createElement(\"style\");\n    style.innerHTML = __webpack_require__(/*! !../loaders/css-loader.js!../loaders/less-loader.js!./index.less */ \"./loaders/css-loader.js!./loaders/less-loader.js!./src/index.less\");\n    document.head.appendChild(style);\n \n\n//# sourceURL=webpack:///./src/index.less?"</span>);</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure><h3 id="exact-loader-js"><a href="#exact-loader-js" class="headerlink" title="exact-loader.js"></a>exact-loader.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//把CSS文件单独放置到一个文件中去，然后在页面中通过link标签去引入</span></span><br><span class="line"><span class="keyword">let</span> loader = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="comment">//发射或者说输出一个文件，这个文件的内容 就是css文件的内容</span></span><br><span class="line">    <span class="keyword">this</span>.emitFile(<span class="string">'main.css'</span>, source);</span><br><span class="line">    <span class="keyword">let</span> script = <span class="string">`</span></span><br><span class="line"><span class="string">     let link  = document.createElement('link');</span></span><br><span class="line"><span class="string">     link.setAttribute('rel','stylesheet');</span></span><br><span class="line"><span class="string">     link.setAttribute('href','main.css');</span></span><br><span class="line"><span class="string">     document.head.appendChild(link);</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line">    <span class="keyword">return</span> script;</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br></pre></td></tr></tbody></table></figure><h3 id="file"><a href="#file" class="headerlink" title="file"></a>file</h3><p><code>file-loader</code> 并不会对文件内容进行任何转换，只是复制一份文件内容，并根据配置为他生成一个唯一的文件名。</p><h4 id="file-loader"><a href="#file-loader" class="headerlink" title="file-loader"></a>file-loader</h4><ul><li><a href="https://github.com/webpack-contrib/file-loader/blob/master/src/index.js" target="_blank" rel="noopener">file-loader</a></li><li><a href="https://webpack.js.org/guides/public-path/#on-the-fly" target="_blank" rel="noopener">public-path</a></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> { getOptions, interpolateName } = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">content</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> options=getOptions(<span class="keyword">this</span>)||{};</span><br><span class="line">    <span class="keyword">let</span> url = interpolateName(<span class="keyword">this</span>, options.filename || <span class="string">"[hash]"</span>, {content});</span><br><span class="line">    url = url  + <span class="keyword">this</span>.resourcePath.slice(<span class="keyword">this</span>.resourcePath.lastIndexOf(<span class="string">'.'</span>));</span><br><span class="line">    <span class="comment">//发射一个文件 向输出里保存一个文件</span></span><br><span class="line">    <span class="keyword">this</span>.emitFile(url, content);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`module.exports = <span class="subst">${<span class="built_in">JSON</span>.stringify(url)}</span>`</span>;</span><br><span class="line">}</span><br><span class="line">loader.raw = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br></pre></td></tr></tbody></table></figure><ul><li>通过 <code>loaderUtils.interpolateName</code> 方法可以根据 <code>options.name</code> 以及文件内容生成一个唯一的文件名 <code>url</code>（一般配置都会带上hash，否则很可能由于文件重名而冲突）</li><li>通过 <code>this.emitFile(url, content)</code> 告诉 webpack 我需要创建一个文件，webpack会根据参数创建对应的文件，放在 <code>public path</code> 目录下</li><li>返回 <code>module.exports = ${JSON.stringify(url)}</code>,这样就会把原来的文件路径替换为编译后的路径</li></ul><h3 id="url-loader"><a href="#url-loader" class="headerlink" title="url-loader"></a>url-loader</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> { getOptions } = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">var</span> mime = <span class="built_in">require</span>(<span class="string">'mime'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> options=getOptions(<span class="keyword">this</span>)||{};</span><br><span class="line">    <span class="keyword">let</span> { limit, fallback=<span class="string">'file-loader'</span> } = options;</span><br><span class="line">    <span class="keyword">if</span> (limit) {</span><br><span class="line">      limit = <span class="built_in">parseInt</span>(limit, <span class="number">10</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">const</span> mimetype=mime.getType(<span class="keyword">this</span>.resourcePath);</span><br><span class="line">    <span class="keyword">if</span> (!limit || source.length &lt; limit) {</span><br><span class="line">        <span class="keyword">let</span> base64 = <span class="string">`data:<span class="subst">${mimetype}</span>;base64,<span class="subst">${source.toString(<span class="string">'base64'</span>)}</span>`</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`module.exports = <span class="subst">${<span class="built_in">JSON</span>.stringify(base64)}</span>`</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">let</span> fileLoader = <span class="built_in">require</span>(fallback || <span class="string">'file-loader'</span>);</span><br><span class="line">        <span class="keyword">return</span> fileLoader.call(<span class="keyword">this</span>, source);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">loader.raw = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br></pre></td></tr></tbody></table></figure><h3 id="html-layout-loader"><a href="#html-layout-loader" class="headerlink" title="html-layout-loader"></a>html-layout-loader</h3><h4 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  test: <span class="regexp">/\.html$/</span>,</span><br><span class="line">     use: {</span><br><span class="line">          loader: <span class="string">'html-layout-loader'</span>,</span><br><span class="line">          options: {</span><br><span class="line">              layout: path.join(__dirname, <span class="string">'src'</span>, <span class="string">'layout.html'</span>),</span><br><span class="line">              placeholder: <span class="string">'{{__content__}}'</span></span><br><span class="line">     }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">            template: <span class="string">'./src/login.html'</span>,</span><br><span class="line">            filename: <span class="string">'login.html'</span></span><br><span class="line">        }),</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">            template: <span class="string">'./src/home.html'</span>,</span><br><span class="line">            filename: <span class="string">'home.html'</span></span><br><span class="line">        })</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure><h4 id="html-layout-loader-1"><a href="#html-layout-loader-1" class="headerlink" title="html-layout-loader"></a>html-layout-loader</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> defaultOptions = {</span><br><span class="line">    placeholder: <span class="string">'{{__content__}}'</span>,</span><br><span class="line">    decorator: <span class="string">'layout'</span></span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">    <span class="keyword">this</span>.cacheable &amp;&amp; <span class="keyword">this</span>.cacheable();</span><br><span class="line">    <span class="keyword">const</span> options = <span class="built_in">Object</span>.assign(loaderUtils.getOptions(<span class="keyword">this</span>), defaultOptions);</span><br><span class="line">    <span class="keyword">const</span> { placeholder, decorator, layout } = options;</span><br><span class="line">    fs.readFile(layout, <span class="string">'utf8'</span>, (err, html) =&gt; {</span><br><span class="line">        html = html.replace(placeholder, source);</span><br><span class="line">        callback(<span class="literal">null</span>, <span class="string">`module.exports = <span class="subst">${<span class="built_in">JSON</span>.stringify(html)}</span>`</span>);</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> defaultOptions = {</span><br><span class="line">    placeholder:<span class="string">'{{__content__}}'</span>,</span><br><span class="line">    decorator:<span class="string">'layout'</span></span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>)</span>{</span><br><span class="line">    <span class="keyword">let</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">    <span class="keyword">this</span>.cacheable&amp;&amp; <span class="keyword">this</span>.cacheable();</span><br><span class="line">    <span class="keyword">const</span> options = {...loaderUtils.getOptions(<span class="keyword">this</span>),...defaultOptions};</span><br><span class="line">    <span class="keyword">const</span> {placeholder,layout,decorator} = options;</span><br><span class="line">    <span class="keyword">const</span> layoutReg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`@<span class="subst">${decorator}</span>\\((.+?)\\)`</span>);</span><br><span class="line">    <span class="keyword">let</span> result = source.match(layoutReg);</span><br><span class="line">    <span class="keyword">if</span>(result){</span><br><span class="line">        source = source.replace(result[<span class="number">0</span>],<span class="string">''</span>);</span><br><span class="line">        render(path.resolve(<span class="keyword">this</span>.context,result[<span class="number">1</span>]), placeholder, source, callback)</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        render(layout, placeholder, source, callback);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">layout, placeholder, source, callback</span>) </span>{</span><br><span class="line">    fs.readFile(layout, <span class="string">'utf8'</span>, (err, html) =&gt; {</span><br><span class="line">        html = html.replace(placeholder, source);</span><br><span class="line">        callback(<span class="literal">null</span>, <span class="string">`module.exports = <span class="subst">${<span class="built_in">JSON</span>.stringify(html)}</span>`</span>);</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="loader测试"><a href="#loader测试" class="headerlink" title="loader测试"></a>loader测试</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cnpm install --save-dev jest babel-jest babel-preset-env</span><br><span class="line">cnpm install --save-dev webpack memory-fs</span><br></pre></td></tr></tbody></table></figure><h3 id="src-loader-js"><a href="#src-loader-js" class="headerlink" title="src/loader.js"></a>src/loader.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {getOptions} = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>)</span>{</span><br><span class="line">   <span class="keyword">const</span> options = getOptions(<span class="keyword">this</span>);</span><br><span class="line">   source=source.replace(<span class="regexp">/\[name\]/g</span>,options.name);</span><br><span class="line">   <span class="keyword">return</span> <span class="string">`module.exports = <span class="subst">${<span class="built_in">JSON</span>.stringify(source)}</span>`</span>;</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports=loader;</span><br></pre></td></tr></tbody></table></figure><h3 id="test-example-txt"><a href="#test-example-txt" class="headerlink" title="test/example.txt"></a>test/example.txt</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello [name]</span><br></pre></td></tr></tbody></table></figure><h3 id="test-compile-js"><a href="#test-compile-js" class="headerlink" title="test/compile.js"></a>test/compile.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> webpack=<span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">let</span> MemoryFs=<span class="built_in">require</span>(<span class="string">'memory-fs'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">fixture,options={}</span>) </span>{</span><br><span class="line">    <span class="keyword">const</span> compiler=webpack({</span><br><span class="line">        mode:<span class="string">'development'</span>,</span><br><span class="line">        context: __dirname,</span><br><span class="line">        entry: <span class="string">`./<span class="subst">${fixture}</span>`</span>,</span><br><span class="line">        output: {</span><br><span class="line">            path: path.resolve(__dirname),</span><br><span class="line">            filename:<span class="string">'bundle.js'</span></span><br><span class="line">        },</span><br><span class="line">        <span class="built_in">module</span>: {</span><br><span class="line">            rules: [</span><br><span class="line">                {</span><br><span class="line">                    test: <span class="regexp">/\.txt$/</span>,</span><br><span class="line">                    use: {</span><br><span class="line">                        loader: path.resolve(__dirname,<span class="string">'../src/loader.js'</span>),</span><br><span class="line">                        options:{<span class="attr">name</span>:<span class="string">'Alice'</span>}</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            ]</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">    compiler.outputFileSystem=<span class="keyword">new</span> MemoryFs();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve,reject</span>) </span>{</span><br><span class="line">        compiler.run(<span class="function">(<span class="params">err,stats</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">if</span> (err) reject(err);</span><br><span class="line">            <span class="keyword">else</span> resolve(stats);</span><br><span class="line">        });</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="test-loader-test-js"><a href="#test-loader-test-js" class="headerlink" title="test/loader.test.js"></a>test/loader.test.js</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> compile=<span class="built_in">require</span>(<span class="string">'./compile'</span>);</span><br><span class="line">test(<span class="string">'replace name'</span>,<span class="keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="keyword">const</span> stats=<span class="keyword">await</span> compile(<span class="string">'example.txt'</span>);</span><br><span class="line">    <span class="keyword">const</span> data=stats.toJson();</span><br><span class="line">    <span class="keyword">const</span> source=data.modules[<span class="number">0</span>].source;</span><br><span class="line">    expect(source).toBe(<span class="string">`module.exports = "hello Alice"`</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: {</span><br><span class="line">  <span class="string">"test"</span>:<span class="string">"jest"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="loader源码"><a href="#loader源码" class="headerlink" title="loader源码"></a>loader源码</h3><p>loader是用来加载处理各种形式的资源,本质上是一个函数, 接受文件作为参数,返回转化后的结构。</p><ul><li>loader 用于对模块的源代码进行转换</li><li>loader 可以使你在 import 或”加载”模块时预处理文件</li></ul><h4 id="NormalModuleFactory"><a href="#NormalModuleFactory" class="headerlink" title="NormalModuleFactory"></a>NormalModuleFactory</h4><ul><li><code>!</code> noAutoLoaders 所有的loader都不要执行</li><li><code>!!</code> noPrePostAutoLoaders 不要前后置loader</li><li><code>-!</code> noPreAutoLoaders 不要前置loader</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.hooks.resolver.tap(<span class="string">"NormalModuleFactory"</span>, () =&gt; <span class="function">(<span class="params">data, callback</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">const</span> contextInfo = data.contextInfo;</span><br><span class="line">            <span class="keyword">const</span> context = data.context;</span><br><span class="line">            <span class="keyword">const</span> request = data.request;</span><br><span class="line">            <span class="keyword">debugger</span> <span class="comment">/*resolve钩子上注册的方法较长，其中还包括了模块资源本身的路径解析。resolver有两种，分别是loaderResolver和normalResolver。*/</span></span><br><span class="line">            <span class="keyword">const</span> loaderResolver = <span class="keyword">this</span>.getResolver(<span class="string">"loader"</span>);</span><br><span class="line">            <span class="keyword">const</span> normalResolver = <span class="keyword">this</span>.getResolver(<span class="string">"normal"</span>, data.resolveOptions);</span><br><span class="line">            <span class="comment">//匹配的资源</span></span><br><span class="line">            <span class="keyword">let</span> matchResource = <span class="literal">undefined</span>;</span><br><span class="line">            <span class="keyword">let</span> requestWithoutMatchResource = request;<span class="comment">//这是原始的请求</span></span><br><span class="line">            <span class="keyword">const</span> matchResourceMatch = MATCH_RESOURCE_REGEX.exec(request);<span class="comment">//"^([^!]+)!=!"</span></span><br><span class="line">            <span class="keyword">if</span> (matchResourceMatch) {<span class="comment">//如果能匹配上</span></span><br><span class="line">                matchResource = matchResourceMatch[<span class="number">1</span>];<span class="comment">//取得匹配到的资源 </span></span><br><span class="line">                <span class="keyword">if</span> (<span class="regexp">/^\.\.?\//</span>.test(matchResource)) {<span class="comment">//如果是一个相对路径,则转成绝对路径</span></span><br><span class="line">                    matchResource = path.join(context, matchResource);</span><br><span class="line">                }<span class="comment">//把匹配到的部分截取掉</span></span><br><span class="line">                requestWithoutMatchResource = request.substr(</span><br><span class="line">                    matchResourceMatch[<span class="number">0</span>].length</span><br><span class="line">                );</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">debugger</span> <span class="comment">/*noPreAuto指的是只用行内loader,禁用配置文件中的loader配置*/</span></span><br><span class="line">            <span class="keyword">const</span> noPreAutoLoaders = requestWithoutMatchResource.startsWith(<span class="string">"-!"</span>);</span><br><span class="line">            <span class="keyword">const</span> noAutoLoaders =</span><br><span class="line">                noPreAutoLoaders || requestWithoutMatchResource.startsWith(<span class="string">"!"</span>);<span class="comment">//!表示不走配置</span></span><br><span class="line">            <span class="keyword">const</span> noPrePostAutoLoaders = requestWithoutMatchResource.startsWith(<span class="string">"!!"</span>);<span class="comment">//表示禁用前后loader</span></span><br><span class="line">            <span class="keyword">let</span> elements = requestWithoutMatchResource</span><br><span class="line">                .replace(<span class="regexp">/^-?!+/</span>, <span class="string">""</span>)<span class="comment">//把-!替换成空</span></span><br><span class="line">                .replace(<span class="regexp">/!!+/g</span>, <span class="string">"!"</span>)<span class="comment">//把!!替换成一个!</span></span><br><span class="line">                .split(<span class="string">"!"</span>); <span class="keyword">debugger</span> <span class="comment">/*webpack会从request中解析出所需的loader,包括资源本身 */</span></span><br><span class="line">            <span class="keyword">let</span> resource = elements.pop();<span class="comment">//取得资源</span></span><br><span class="line">            elements = elements.map(identToLoaderRequest);<span class="comment">//剩下的全转成loader对象</span></span><br></pre></td></tr></tbody></table></figure><h3 id="webpack-lib-NormalModule-js-263"><a href="#webpack-lib-NormalModule-js-263" class="headerlink" title="webpack/lib/NormalModule.js:263"></a>webpack/lib/NormalModule.js:263</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">runLoaders({</span><br><span class="line">                resource: <span class="keyword">this</span>.resource,</span><br><span class="line">                loaders: <span class="keyword">this</span>.loaders,</span><br><span class="line">                context: loaderContext</span><br><span class="line">},</span><br><span class="line">(err, result) =&gt; {</span><br><span class="line"><span class="keyword">const</span> resourceBuffer = result.resourceBuffer;</span><br><span class="line"><span class="keyword">const</span> source = result.result[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> sourceMap = result.result.length &gt;= <span class="number">1</span> ? result.result[<span class="number">1</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> extraInfo = result.result.length &gt;= <span class="number">2</span> ? result.result[<span class="number">2</span>] : <span class="literal">null</span>;<span class="comment">//ast</span></span><br><span class="line"><span class="keyword">this</span>._source = <span class="keyword">this</span>.createSource(</span><br><span class="line">                    <span class="keyword">this</span>.binary ? asBuffer(source) : asString(source),</span><br><span class="line">                    resourceBuffer,</span><br><span class="line">                    sourceMap</span><br><span class="line">);</span><br><span class="line"><span class="keyword">this</span>._ast = <span class="keyword">typeof</span> extraInfo === <span class="string">"object"</span> &amp;&amp;</span><br><span class="line">                    extraInfo !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                    extraInfo.webpackAST !== <span class="literal">undefined</span>? extraInfo.webpackAST: <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="LoaderRunner-js"><a href="#LoaderRunner-js" class="headerlink" title="LoaderRunner.js"></a>LoaderRunner.js</h3><p>loader-runner/lib/LoaderRunner.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iteratePitchingLoaders(processOptions, loaderContext, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>{</span><br><span class="line">callback(<span class="literal">null</span>, {</span><br><span class="line">            result: result,<span class="comment">//结果</span></span><br><span class="line">            resourceBuffer: processOptions.resourceBuffer,</span><br><span class="line">            cacheable: requestCacheable,</span><br><span class="line">            fileDependencies: fileDependencies,</span><br><span class="line">            contextDependencies: contextDependencies</span><br><span class="line">});</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="LoaderRunner-js-155"><a href="#LoaderRunner-js-155" class="headerlink" title="LoaderRunner.js:155"></a>LoaderRunner.js:155</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(loaderContext.loaderIndex &gt;= loaderContext.loaders.length)</span><br><span class="line">        <span class="keyword">return</span> processResource(options, loaderContext, callback);</span><br><span class="line"><span class="keyword">var</span> fn = currentLoaderObject.pitch;</span><br><span class="line"></span><br><span class="line">runSyncOrAsync(fn,loaderContext);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runSyncOrAsync</span>(<span class="params">fn, context, args, callback</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> isSync = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">var</span> isDone = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> isError = <span class="literal">false</span>; <span class="comment">// internal error</span></span><br><span class="line">    <span class="keyword">var</span> reportedError = <span class="literal">false</span>;</span><br><span class="line">    context.async = <span class="function"><span class="keyword">function</span> <span class="title">async</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (isDone) {</span><br><span class="line">            <span class="keyword">if</span> (reportedError) <span class="keyword">return</span>; <span class="comment">// ignore</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"async(): The callback was already called."</span>);</span><br><span class="line">        }</span><br><span class="line">        isSync = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> innerCallback;</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">var</span> innerCallback = context.callback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (isDone) {</span><br><span class="line">            <span class="keyword">if</span> (reportedError) <span class="keyword">return</span>; <span class="comment">// ignore</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"callback(): The callback was already called."</span>);</span><br><span class="line">        }</span><br><span class="line">        isDone = <span class="literal">true</span>;</span><br><span class="line">        isSync = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            callback.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (e) {</span><br><span class="line">            isError = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">var</span> result = (<span class="function"><span class="keyword">function</span> <span class="title">LOADER_EXECUTION</span>(<span class="params"></span>) </span>{</span><br><span class="line">            <span class="keyword">return</span> fn.apply(context, args);</span><br><span class="line">        }());</span><br><span class="line">        <span class="keyword">if</span> (isSync) {</span><br><span class="line">            isDone = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (result === <span class="literal">undefined</span>)</span><br><span class="line">                <span class="keyword">return</span> callback();</span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; <span class="keyword">typeof</span> result === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> result.then === <span class="string">"function"</span>) {</span><br><span class="line">                <span class="keyword">return</span> result.catch(callback).then(<span class="function"><span class="keyword">function</span> (<span class="params">r</span>) </span>{</span><br><span class="line">                    callback(<span class="literal">null</span>, r);</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> callback(<span class="literal">null</span>, result);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (e) {</span><br><span class="line">        <span class="keyword">if</span> (isError) <span class="keyword">throw</span> e;</span><br><span class="line">        <span class="keyword">if</span> (isDone) {</span><br><span class="line">            <span class="comment">// loader is already "done", so we cannot use the callback function</span></span><br><span class="line">            <span class="comment">// for better debugging we print the error on the console</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> e === <span class="string">"object"</span> &amp;&amp; e.stack) <span class="built_in">console</span>.error(e.stack);</span><br><span class="line">            <span class="keyword">else</span> <span class="built_in">console</span>.error(e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        isDone = <span class="literal">true</span>;</span><br><span class="line">        reportedError = <span class="literal">true</span>;</span><br><span class="line">        callback(e);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runSyncOrAsync</span>(<span class="params">fn, context, callback</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> isSync = <span class="literal">true</span>;</span><br><span class="line">    context.callback = callback;</span><br><span class="line">    context.async = <span class="function"><span class="keyword">function</span> <span class="title">async</span>(<span class="params"></span>) </span>{</span><br><span class="line">        isSync = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> context.callback;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = fn.apply(context);</span><br><span class="line">    <span class="keyword">if</span> (isSync) {</span><br><span class="line">        <span class="keyword">return</span> callback(<span class="literal">null</span>, result);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">say2</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">let</span> cb = <span class="keyword">this</span>.async();</span><br><span class="line">    cb(<span class="literal">null</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> context = { <span class="attr">name</span>: <span class="string">'zfpx'</span> };</span><br><span class="line">runSyncOrAsync(say2, context, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="loadLoader-js-13"><a href="#loadLoader-js-13" class="headerlink" title="loadLoader.js:13"></a>loadLoader.js:13</h3><p>loader-runner/lib/loadLoader.js:13<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">module</span> = <span class="built_in">require</span>(loader.path);</span><br><span class="line">loader.normal = <span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">"function"</span> ? <span class="built_in">module</span> : <span class="built_in">module</span>.default;</span><br><span class="line">loader.pitch = <span class="built_in">module</span>.pitch;</span><br><span class="line">loader.raw = <span class="built_in">module</span>.raw;</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="LoaderRunner-js-1"><a href="#LoaderRunner-js-1" class="headerlink" title="LoaderRunner.js"></a>LoaderRunner.js</h3><p>loader-runner/lib/LoaderRunner.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">runSyncOrAsync(</span><br><span class="line">            fn,</span><br><span class="line">            loaderContext, [loaderContext.remainingRequest, loaderContext.previousRequest, currentLoaderObject.data = {}],</span><br><span class="line">            <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>{</span><br><span class="line">                <span class="keyword">if</span>(err) <span class="keyword">return</span> callback(err);</span><br><span class="line">                <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>) {</span><br><span class="line">                    loaderContext.loaderIndex--;</span><br><span class="line">                    iterateNormalLoaders(options, loaderContext, args, callback);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    iteratePitchingLoaders(options, loaderContext, callback);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        );</span><br></pre></td></tr></tbody></table></figure><p></p><hr><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://github.com/webpack/loader-utils" target="_blank" rel="noopener">loader-utils</a></li><li><a href="https://github.com/webpack-contrib/schema-utils" target="_blank" rel="noopener">schema-utils</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/14/AST/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/14/AST/" itemprop="url">AST</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-14T17:29:38+08:00">2019-01-14 </time></span><span id="/2019/01/14/AST/" class="leancloud_visitors" data-flag-title="AST"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">2,031 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">9</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="抽象语法树-Abstract-Syntax-Tree"><a href="#抽象语法树-Abstract-Syntax-Tree" class="headerlink" title="抽象语法树(Abstract Syntax Tree)"></a>抽象语法树(Abstract Syntax Tree)</h2><p><strong>webpack</strong>和<strong>Lint</strong>等很多的工具和库的核心都是通过<strong>Abstract Syntax Tree</strong>抽象语法树这个概念来实现对代码的<code>检查</code>、<code>分析</code>等操作的。通过了解抽象语法树这个概念，你也可以随手编写类似的工具</p><h2 id="抽象语法树用途"><a href="#抽象语法树用途" class="headerlink" title="抽象语法树用途"></a>抽象语法树用途</h2><ul><li>代码语法的检查、代码风格的检查、代码的格式化、代码的高亮、代码错误提示、代码自动补全等等<ul><li>如JSLint、JSHint对代码错误或风格的检查，发现一些潜在的错误</li><li>IDE的错误提示、格式化、高亮、自动补全等等</li></ul></li><li>代码混淆压缩<ul><li>UglifyJS2等</li></ul></li><li>优化变更代码，改变代码结构使达到想要的结构<ul><li>代码打包工具webpack、rollup等等</li><li>CommonJS、AMD、CMD、UMD等代码规范之间的转化</li><li>CoffeeScript、TypeScript、JSX等转化为原生Javascript</li></ul></li></ul><h2 id="抽象语法树定义"><a href="#抽象语法树定义" class="headerlink" title="抽象语法树定义"></a>抽象语法树定义</h2><p>这些工具的原理都是通过<code>JavaScript Parser</code>把代码转化为一颗抽象语法树（<code>AST</code>），这颗树定义了<code>代码的结构</code>，通过操纵这颗树，我们可以精准的定位到<code>声明语句</code>、<code>赋值语句</code>、运算语句等等，实现对代码的分析、优化、变更等操作</p><blockquote><p>在计算机科学中，抽象语法树（abstract syntax tree或者缩写为AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式，这里特指编程语言的源代码。<br>Javascript的语法是为了给开发者更好的编程而设计的，但是不适合程序的理解。所以需要转化为AST来更适合程序分析，浏览器编译器一般会把源码转化为AST来进行进一步的分析等其他操作。<br><img src="http://b.zhangyapeng.club/ast-2019115103639.jpg" alt="ast-2019115103639"></p></blockquote><h2 id="抽象语法树的生成过程（编译）"><a href="#抽象语法树的生成过程（编译）" class="headerlink" title="抽象语法树的生成过程（编译）"></a>抽象语法树的生成过程（编译）</h2><h2 id=""><a href="#" class="headerlink" title=""></a><img src="http://b.zhangyapeng.club/1675f140480d7f78-2019115102522.webp" alt="1675f140480d7f78-2019115102522"></h2><h3 id="js为例"><a href="#js为例" class="headerlink" title="js为例"></a>js为例</h3><ul><li><code>词法分析</code>（lexical analysis）：进行词法分析的程序或者函数叫作词法分析器（Lexical analyzer，简称Lexer），也叫扫描器（Scanner，例如typescript源码中的scanner.ts），字符流转换成对应的<code>Token流</code>。</li><li><code>tokenize</code>：tokenize就是按照一定的规则，例如token令牌（通常代表<code></code>关键字<code>，变量名</code>，<code>语法符号</code>等），将代码分割为一个个的<strong>串</strong>，也就是语法单元）。涉及到词法解析的时候，常会用到tokennize。</li><li><code>语法分析</code>（parse analysis）：是编译过程的一个逻辑阶段。语法分析的任务是在词法分析的基础上将单词序列组合成<code>语法树</code>，如“程序”，“语句”，“表达式”等等.语法分析程序判断源程序在结构上是否正确。源程序的结构由上下文无关文法描述。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> b = a + <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><p><img src="http://b.zhangyapeng.club/js转换AST流程图-201911510340.webp" alt="js转换AST流程图-201911510340"></p><ul><li><p><code>词法解析过程</code>：一边扫描源代码一边进行分类，例如扫描到第一行<code>const a = 1</code>,首先扫描到<code>const</code>，会生成一个语法单元说这是关键字<code>const</code>，接着扫描到<code>a</code>，这是变量名<code>a</code>，接着操作符<code>=</code>，接着常量<code>1</code>，等等，构成一个个<code>token流</code>。</p></li><li><p><code>语法分析过程</code>：将<code>token流转化</code>为一个有元素层级嵌套所组成的代表程序语法结构的树，这个树被叫做<code>抽象语法树AST</code>。</p></li></ul><h2 id="JavaScript-Parser"><a href="#JavaScript-Parser" class="headerlink" title="JavaScript Parser"></a>JavaScript Parser</h2><ul><li><strong>JavaScript Parser:</strong>把js源码转化为抽象语法树的解析器</li><li>浏览器会把<code>js源码</code>通过解析器转为<code>抽象语法树</code>，再进一步转化为<code>字节码</code>或直接<code>生成机器码</code>。</li><li>一般来说每个js引擎都会有自己的抽象语法树格式，<code>Chrome的v8引擎</code>，<code>firefox的SpiderMonkey</code>引擎等等，MDN提供了详细<code>SpiderMonkey AST format</code>的详细说明，算是业界的标准。</li></ul><h3 id="常用的JavaScript-Parser有"><a href="#常用的JavaScript-Parser有" class="headerlink" title="常用的JavaScript Parser有"></a>常用的JavaScript Parser有</h3><ul><li>esprima</li><li>traceur</li><li>acorn(babel和webpack的实现)</li><li>shift</li></ul><hr><h2 id="esprima"><a href="#esprima" class="headerlink" title="esprima"></a>esprima</h2><ul><li>通过 <a href="https://www.npmjs.com/package/esprima" target="_blank" rel="noopener">esprima</a> 把源码转化为AST</li><li>通过 <a href="https://www.npmjs.com/package/estraverse" target="_blank" rel="noopener">estraverse</a> 遍历并更新AST</li><li>通过 <a href="https://www.npmjs.com/package/escodegen" target="_blank" rel="noopener">escodegen</a> 将AST重新生成源码</li><li><a href="https://astexplorer.net/" target="_blank" rel="noopener">astexplorer</a></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i esprima estraverse escodegen- S</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> esprima = <span class="built_in">require</span>(<span class="string">'esprima'</span>);</span><br><span class="line"><span class="keyword">var</span> estraverse = <span class="built_in">require</span>(<span class="string">'estraverse'</span>);</span><br><span class="line"><span class="keyword">var</span> escodegen = <span class="built_in">require</span>(<span class="string">"escodegen"</span>);</span><br><span class="line"><span class="keyword">let</span> code = <span class="string">'function ast(){}'</span>;</span><br><span class="line"><span class="keyword">let</span> ast=esprima.parse(code);</span><br><span class="line"><span class="keyword">let</span> indent=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pad</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="string">' '</span>.repeat(indent);</span><br><span class="line">}</span><br><span class="line">estraverse.traverse(ast,{</span><br><span class="line">    enter(node) {</span><br><span class="line">        <span class="built_in">console</span>.log(pad()+node.type);</span><br><span class="line">        <span class="keyword">if</span>(node.type == <span class="string">'FunctionDeclaration'</span>){</span><br><span class="line">            node.id.name = <span class="string">'ast_rename'</span>;</span><br><span class="line">        }</span><br><span class="line">        indent+=<span class="number">2</span>;</span><br><span class="line">     },</span><br><span class="line">    leave(node) {</span><br><span class="line">        indent-=<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(pad()+node.type);</span><br><span class="line"></span><br><span class="line">     }</span><br><span class="line"> });</span><br><span class="line"><span class="keyword">let</span> generated = escodegen.generate(ast);</span><br><span class="line"><span class="built_in">console</span>.log(generated);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Program</span><br><span class="line">  FunctionDeclaration</span><br><span class="line">    Identifier</span><br><span class="line">    Identifier</span><br><span class="line">    BlockStatement</span><br><span class="line">    BlockStatement</span><br><span class="line">  FunctionDeclaration</span><br><span class="line">Program</span><br></pre></td></tr></tbody></table></figure><h2 id="转换箭头函数"><a href="#转换箭头函数" class="headerlink" title="转换箭头函数"></a>转换箭头函数</h2><ul><li>访问者模式<code>Visitor</code> 对于某个对象或者一组对象，不同的访问者，产生的结果不同，执行操作也不同</li><li><a href="https://www.npmjs.com/package/@babel/core" target="_blank" rel="noopener">@babel/core</a></li><li><a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener">babel-types</a>它包含了构造、验证以及变换 AST 节点的方法</li><li><a href="https://babeljs.io/docs/en/next/babel-types.html" target="_blank" rel="noopener">babel-types-api</a></li><li><a href="https://github.com/brigand/babel-plugin-handbook/blob/master/translations/zh-Hans/README.md#asts" target="_blank" rel="noopener">Babel 插件手册</a></li><li><a href="https://babeljs.io/en/repl.html" target="_blank" rel="noopener">babeljs.io</a></li><li><a href="https://www.npmjs.com/package/babel-plugin-transform-es2015-arrow-functions" target="_blank" rel="noopener">babel-plugin-transform-es2015-arrow-functions</a></li></ul><p>转换前<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = <span class="function">(<span class="params">a,b</span>)=&gt;</span>a+b</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="http://b.zhangyapeng.club/arrow-left-2019115111231.png" alt="arrow-left-2019115111231"><br>转换后<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sum = <span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="http://b.zhangyapeng.club/arrow-right-2019115111311.png" alt="arrow-right-2019115111311"><br>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>);</span><br><span class="line"><span class="keyword">let</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>); <span class="comment">//</span></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`const sum = (a,b)=&gt;a+b`</span>;</span><br><span class="line"><span class="comment">// path.node  父节点</span></span><br><span class="line"><span class="comment">// path.parentPath 父路径</span></span><br><span class="line"><span class="keyword">let</span> transformArrowFunctions = {</span><br><span class="line">    visitor: {</span><br><span class="line">        ArrowFunctionExpression: <span class="function">(<span class="params">path, state</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">let</span> node = path.node;</span><br><span class="line">            <span class="keyword">let</span> id = path.parent.id;</span><br><span class="line">            <span class="keyword">let</span> params = node.params;</span><br><span class="line">            <span class="keyword">let</span> body=t.blockStatement([</span><br><span class="line">                t.returnStatement(node.body)</span><br><span class="line">            ]);</span><br><span class="line">            <span class="keyword">let</span> functionExpression = t.functionExpression(id,params,body,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">            path.replaceWith(functionExpression);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">const</span> result = babel.transform(code, {</span><br><span class="line">    plugins: [transformArrowFunctions]</span><br><span class="line">});</span><br><span class="line"><span class="built_in">console</span>.log(result.code);</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="预计算babel插件"><a href="#预计算babel插件" class="headerlink" title="预计算babel插件"></a>预计算babel插件</h2><p>转换前<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="number">1</span> + <span class="number">2</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="http://b.zhangyapeng.club/precalcleft-2019115111447.png" alt="precalcleft-2019115111447"><br>转换后<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="http://b.zhangyapeng.club/precalcright-2019115111519.png" alt="precalcright-2019115111519"><br>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>);</span><br><span class="line"><span class="keyword">let</span> t=<span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"><span class="keyword">let</span> preCalculator={</span><br><span class="line">    visitor: {</span><br><span class="line">        BinaryExpression(path) {</span><br><span class="line">            <span class="keyword">let</span> node=path.node;</span><br><span class="line">            <span class="keyword">let</span> left=node.left;</span><br><span class="line">            <span class="keyword">let</span> operator=node.operator;</span><br><span class="line">            <span class="keyword">let</span> right=node.right;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">isNaN</span>(left.value) &amp;&amp; !<span class="built_in">isNaN</span>(right.value)) {</span><br><span class="line">                <span class="keyword">let</span> result=<span class="built_in">eval</span>(left.value+operator+right.value);</span><br><span class="line">                path.replaceWith(t.numericLiteral(result));</span><br><span class="line">                <span class="keyword">if</span> (path.parent&amp;&amp; path.parent.type == <span class="string">'BinaryExpression'</span>) {</span><br><span class="line">                    preCalculator.visitor.BinaryExpression.call(<span class="literal">null</span>,path.parentPath);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = babel.transform(<span class="string">'const sum = 1+2+3'</span>,{</span><br><span class="line">    plugins:[</span><br><span class="line">        preCalculator</span><br><span class="line">    ]</span><br><span class="line">});</span><br><span class="line"><span class="built_in">console</span>.log(result.code);</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="把类编译为Function"><a href="#把类编译为Function" class="headerlink" title="把类编译为Function"></a>把类编译为Function</h2><ul><li><a href="https://www.npmjs.com/package/babel-plugin-transform-es2015-classes" target="_blank" rel="noopener">babel-plugin-transform-es2015-classes</a></li></ul><p>es6<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>{</span><br><span class="line">    <span class="keyword">constructor</span>(name) {</span><br><span class="line">        <span class="keyword">this</span>.name=name;</span><br><span class="line">    }</span><br><span class="line">    getName() {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="http://b.zhangyapeng.club/classast-2019115112715.png" alt="classast-2019115112715"><br>es5<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name</span>) </span>{</span><br><span class="line">    <span class="keyword">this</span>.name=name;</span><br><span class="line">}</span><br><span class="line">Person.prototype.getName=<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="http://b.zhangyapeng.club/es5class1-2019115112759.png" alt="es5class1-2019115112759"><br>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>);</span><br><span class="line"><span class="keyword">let</span> t=<span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"><span class="keyword">let</span> source=<span class="string">`</span></span><br><span class="line"><span class="string">    class Person {</span></span><br><span class="line"><span class="string">        constructor(name) {</span></span><br><span class="line"><span class="string">            this.name=name;</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        getName() {</span></span><br><span class="line"><span class="string">            return this.name;</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">let</span> ClassPlugin={</span><br><span class="line">    visitor: {</span><br><span class="line">        ClassDeclaration(path) {</span><br><span class="line">            <span class="keyword">let</span> node=path.node;</span><br><span class="line">            <span class="keyword">let</span> id=node.id;</span><br><span class="line">            <span class="keyword">let</span> constructorFunction = t.functionDeclaration(id,[],t.blockStatement([]),<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">let</span> methods=node.body.body;</span><br><span class="line">            <span class="keyword">let</span> functions = [];</span><br><span class="line">            methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> {</span><br><span class="line">                <span class="keyword">if</span> (method.kind == <span class="string">'constructor'</span>) {</span><br><span class="line">                    constructorFunction = t.functionDeclaration(id,method.params,method.body,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">                    functions.push(constructorFunction);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="keyword">let</span> memberObj=t.memberExpression(t.memberExpression(id,t.identifier(<span class="string">'prototype'</span>)),method.key);</span><br><span class="line">                    <span class="keyword">let</span> memberFunction = t.functionExpression(id,method.params,method.body,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">let</span> assignment = t.assignmentExpression(<span class="string">'='</span>,memberObj,memberFunction);</span><br><span class="line">                    functions.push(assignment);</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">            <span class="keyword">if</span> (functions.length ==<span class="number">1</span>) {</span><br><span class="line">                path.replaceWith(functions[<span class="number">0</span>]);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                path.replaceWithMultiple(functions);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = babel.transform(source,{</span><br><span class="line">    plugins:[</span><br><span class="line">        ClassPlugin</span><br><span class="line">    ]</span><br><span class="line">});</span><br><span class="line"><span class="built_in">console</span>.log(result.code);</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="webpack-babel插件"><a href="#webpack-babel插件" class="headerlink" title="webpack babel插件"></a>webpack babel插件</h2><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> babel = <span class="built_in">require</span>(<span class="string">"@babel/core"</span>);</span><br><span class="line"><span class="keyword">let</span> { transform } = <span class="built_in">require</span>(<span class="string">"@babel/core"</span>);</span><br></pre></td></tr></tbody></table></figure><h3 id="实现按需加载"><a href="#实现按需加载" class="headerlink" title="实现按需加载"></a>实现按需加载</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { flatten,concat } <span class="keyword">from</span> <span class="string">"lodash"</span></span><br></pre></td></tr></tbody></table></figure><p><img src="http://b.zhangyapeng.club/treeshakingleft-2019115112955.png" alt="treeshakingleft-2019115112955"><br>转换为<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flatten <span class="keyword">from</span> <span class="string">"lodash/flatten"</span>;</span><br><span class="line"><span class="keyword">import</span> concat <span class="keyword">from</span> <span class="string">"lodash/flatten"</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="http://b.zhangyapeng.club/treeshakingright-2019115113021.png" alt="treeshakingright-2019115113021"></p><h3 id="webpack配置"><a href="#webpack配置" class="headerlink" title="webpack配置"></a>webpack配置</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i webpack webpack-cli -D</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports={</span><br><span class="line">    mode:<span class="string">'development'</span>,</span><br><span class="line">    entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    output: {</span><br><span class="line">        path: path.resolve(<span class="string">'dist'</span>),</span><br><span class="line">        filename:<span class="string">'bundle.js'</span></span><br><span class="line">    },</span><br><span class="line">    <span class="built_in">module</span>: {</span><br><span class="line">        rules: [</span><br><span class="line">            {</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                use: {</span><br><span class="line">                    loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">                    options: {</span><br><span class="line">                        plugins:[[<span class="string">'import'</span>,{<span class="attr">library</span>:<span class="string">'lodash'</span>}]]</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>编译顺序为首先<code>plugins</code>从左往右,然后<code>presets</code>从右往左</p><h3 id="babel插件"><a href="#babel插件" class="headerlink" title="babel插件"></a>babel插件</h3><p><code>babel-plugin-import.js</code>放置在<code>node_modules</code>目录下<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>);</span><br><span class="line"><span class="keyword">let</span> types = <span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"><span class="keyword">const</span> visitor = {</span><br><span class="line">    ImportDeclaration:{</span><br><span class="line">        enter(path,state={opts}){</span><br><span class="line">            <span class="keyword">const</span> specifiers = path.node.specifiers;</span><br><span class="line">            <span class="keyword">const</span> source = path.node.source;</span><br><span class="line">            <span class="keyword">if</span>(state.opts.library == source.value &amp;&amp; !types.isImportDefaultSpecifier(specifiers[<span class="number">0</span>])){</span><br><span class="line">                <span class="keyword">const</span> declarations = specifiers.map(<span class="function">(<span class="params">specifier,index</span>)=&gt;</span>{</span><br><span class="line">                    <span class="keyword">return</span> types.ImportDeclaration(</span><br><span class="line">                        [types.importDefaultSpecifier(specifier.local)],</span><br><span class="line">                        types.stringLiteral(<span class="string">`<span class="subst">${source.value}</span>/<span class="subst">${specifier.local.name}</span>`</span>)</span><br><span class="line">                    )</span><br><span class="line">                });</span><br><span class="line">                path.replaceWithMultiple(declarations);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">babel</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        visitor</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><hr><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://juejin.im/post/5bff941e5188254e3b31b424" target="_blank" rel="noopener">AST抽象语法树</a></li><li><a href="https://github.com/brigand/babel-plugin-handbook/blob/master/translations/zh-Hans/README.md#asts" target="_blank" rel="noopener">Babel 插件手册</a></li><li><a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener">babel-types</a></li><li><a href="https://astexplorer.net/" target="_blank" rel="noopener">不同的parser解析js代码后得到的AST</a></li><li><a href="http://resources.jointjs.com/demos/javascript-ast" target="_blank" rel="noopener">在线可视化的看到AST</a></li><li><a href="https://zhuanlan.zhihu.com/p/28143410" target="_blank" rel="noopener">babel从入门到入门的知识归纳</a></li><li><a href="https://octman.com/blog/2016-08-27-babel-notes/" target="_blank" rel="noopener">Babel 内部原理分析</a></li><li><a href="https://github.com/chikara-chan/babel-plugin-react-scope-binding" target="_blank" rel="noopener">babel-plugin-react-scope-binding</a></li><li><a href="https://www.npmjs.com/package/babel-plugin-transform-runtime" target="_blank" rel="noopener">transform-runtime</a> Babel 默认只转换新的 JavaScript 语法，而不转换新的 API。例如，Iterator、Generator、Set、Maps、Proxy、Reflect、Symbol、Promise 等全局对象，以及一些定义在全局对象上的方法（比如 Object.assign）都不会转译,启用插件 babel-plugin-transform-runtime 后，Babel 就会使用 babel-runtime 下的工具函数</li><li><a href="https://github.com/babel/babylon/blob/master/ast/spec.md" target="_blank" rel="noopener">ast-spec</a></li><li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/README.md" target="_blank" rel="noopener">babel-handbook</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/14/webpack-tapable/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/14/webpack-tapable/" itemprop="url">webpack-tapable</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-14T14:50:58+08:00">2019-01-14 </time></span><span id="/2019/01/14/webpack-tapable/" class="leancloud_visitors" data-flag-title="webpack-tapable"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">3,190 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">18</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="webpack的插件机制"><a href="#webpack的插件机制" class="headerlink" title="webpack的插件机制"></a>webpack的插件机制</h2><p>webpack实现插件机制的大体方式是:</p><ul><li><strong>创建</strong> - webpack在其内部对象上创建各种钩子；</li><li><strong>注册</strong> - 插件将自己的方法注册到对应钩子上，交给webpack；</li><li><strong>调用</strong> - webpack编译过程中，会适时地触发相应钩子，因此也就触发了插件的方法</li></ul><h2 id="tapable"><a href="#tapable" class="headerlink" title="tapable"></a>tapable</h2><p><strong>Webpack</strong>本质上是一种<code>事件流</code>的机制，它的工作流程就是将各个插件串联起来，而实现这一切的核心就是<strong>Tapable</strong>，<strong>webpack</strong>中最核心的负责<code>编译</code>的<strong>Compiler</strong>和负责<code>创建</code><strong>bundle</strong>的<strong>Compilation</strong>都是Tapable的实例</p><h2 id="tapable用法"><a href="#tapable用法" class="headerlink" title="tapable用法"></a>tapable用法</h2><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> {</span><br><span class="line">    SyncHook,</span><br><span class="line">    SyncBailHook,</span><br><span class="line">    SyncWaterfallHook,</span><br><span class="line">    SyncLoopHook,</span><br><span class="line">    AsyncParallelHook,</span><br><span class="line">    AsyncParallelBailHook,</span><br><span class="line">    AsyncSeriesHook,</span><br><span class="line">    AsyncSeriesBailHook,</span><br><span class="line">    AsyncSeriesWaterfallHook</span><br><span class="line"> } = <span class="built_in">require</span>(<span class="string">"tapable"</span>);</span><br></pre></td></tr></tbody></table></figure><p><img src="http://b.zhangyapeng.club/tapable%20(1" alt="tapable (1)-2019114145412">-2019114145412.png)</p><p>看起来起来功能和 <code>EventEmit</code> 类似，先注册事件，然后触发事件。不过 <code>Tapable</code> 的功能要比 <code>EventEmit</code> 强大。从官方介绍中，可以看到 <code>Tapable</code> 提供了很多类型的 <code>Hook</code>，分为<code>同步</code>和<code>异步</code>两个大类(异步中又区分异步<code>并行</code>和异步<code>串行</code>)，而根据事件执行的终止条件的不同，由衍生出 <code>Bail</code>/<code>Waterfall</code>/<code>Loop</code> 类型。</p><p><img src="http://b.zhangyapeng.club/167f458ac2b1e527-2019114145946.webp" alt="167f458ac2b1e527-2019114145946"></p><h2 id=""><a href="#" class="headerlink" title=""></a><img src="http://b.zhangyapeng.club/167f458d6ff8424f-201911415344.webp" alt="167f458d6ff8424f-201911415344"></h2><ul><li><strong>BasicHook</strong>: 执行每一个，不关心函数的返回值，有 SyncHook、AsyncParallelHook、AsyncSeriesHook。</li><li><strong>BailHook</strong>: 顺序执行 Hook，遇到第一个结果 <code>result !== undefined</code> 则返回，不再继续执行。有：SyncBailHook、AsyncSeriseBailHook, AsyncParallelBailHook。</li><li><strong>WaterfallHook</strong>: 类似于 reduce，如果前一个 Hook 函数的结果 <code>result !== undefined</code>，则 result 会作为后一个 Hook 函数的第一个参数。既然是顺序执行，那么就只有 Sync 和 AsyncSeries 类中提供这个Hook：SyncWaterfallHook，AsyncSeriesWaterfallHook</li><li><strong>LoopHook</strong>: 不停的循环执行 Hook，直到所有函数结果 <code>result === undefined</code>。同样的，由于对串行性有依赖，所以只有 SyncLoopHook 和 AsyncSeriseLoopHook （PS：暂时没看到具体使用 Case）</li></ul><h2 id="SyncHook"><a href="#SyncHook" class="headerlink" title="SyncHook"></a>SyncHook</h2><hr><p>串行同步执行,不关心返回值<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {SyncHook}=<span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="comment">// 创建一个同步 Hook，指定参数</span></span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> SyncHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(name,<span class="number">1</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(name,<span class="number">2</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(name,<span class="number">3</span>);</span><br><span class="line">});</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">queue.call(<span class="string">'zfpx'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(){</span><br><span class="line">        <span class="keyword">this</span>.tasks=[]</span><br><span class="line">    }</span><br><span class="line">    tap(name,task){</span><br><span class="line">    <span class="keyword">this</span>.tasks.push(task)</span><br><span class="line">    }</span><br><span class="line">    call(...args){</span><br><span class="line">          <span class="keyword">this</span>.tasks.forEach(<span class="function"><span class="params">val</span>=&gt;</span>val(...args))</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="SyncBailHook"><a href="#SyncBailHook" class="headerlink" title="SyncBailHook"></a>SyncBailHook</h2><hr><p>串行同步执行，有一个返回值不为<code>null</code>则跳过剩下的逻辑</p><ul><li><p><strong>break</strong>是跳出当前循环就是最近的一次循环，继续执行外循环，</p></li><li><p><strong>continue</strong>是指结束本次循环，这次循环后边的不执行了，继续最内层循环的循环</p></li><li><p><strong>break</strong>是跳到了外层循环，</p></li><li><p><strong>return</strong>则终止该方法，后边的都不执行了。</p></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {SyncBailHook}=<span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> SyncBailHook([<span class="string">'name'</span>]);</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(name,<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Wrong'</span>;</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(name,<span class="number">2</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(name,<span class="number">3</span>);</span><br><span class="line">});</span><br><span class="line">queue.call(<span class="string">'zfpx'</span>);</span><br></pre></td></tr></tbody></table></figure><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncBailHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(){</span><br><span class="line">        <span class="keyword">this</span>.tasks=[]</span><br><span class="line">    }</span><br><span class="line">    tap(name,task){</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task)</span><br><span class="line">    }</span><br><span class="line">    call(...args){</span><br><span class="line">        <span class="comment">//   for(var val of this.tasks){</span></span><br><span class="line">        <span class="comment">//       let ret= val(...args)</span></span><br><span class="line">        <span class="comment">//       if(ret) break;</span></span><br><span class="line">        <span class="comment">//   }</span></span><br><span class="line">        <span class="keyword">let</span> i=<span class="number">0</span>,ret=<span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">do</span>{</span><br><span class="line">            ret=<span class="keyword">this</span>.tasks[i++](...args)</span><br><span class="line">          }<span class="keyword">while</span>(!ret)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="SyncWaterfallHook"><a href="#SyncWaterfallHook" class="headerlink" title="SyncWaterfallHook"></a>SyncWaterfallHook</h2><hr><p>串行同步执行,瀑布流,类似于<code>reduce</code>，将前一个结果当值 <code>result !== undefined</code>复制给下一个参数<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {SyncWaterfallHook}=<span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> SyncWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,age</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(name,age,<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(data,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">  <span class="built_in">console</span>.log(data,<span class="number">3</span>);</span><br><span class="line">});</span><br><span class="line">queue.call(<span class="string">'zfpx'</span>,<span class="number">9</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncBailHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(){</span><br><span class="line">        <span class="keyword">this</span>.tasks=[]</span><br><span class="line">    }</span><br><span class="line">    tap(name,task){</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task)</span><br><span class="line">    }</span><br><span class="line">    call(...args){</span><br><span class="line">    <span class="keyword">const</span> [first,...tasks]=<span class="keyword">this</span>.tasks</span><br><span class="line">        <span class="keyword">let</span> firstarg=args</span><br><span class="line">      tasks.reduce(<span class="function">(<span class="params">prev,next</span>)=&gt;</span>{</span><br><span class="line">          <span class="keyword">if</span>(prev){</span><br><span class="line">              firstarg=prev</span><br><span class="line">            <span class="keyword">return</span> next(prev)</span><br><span class="line">          }<span class="keyword">else</span>{</span><br><span class="line">            <span class="keyword">return</span> next(...firstarg)</span><br><span class="line">          }</span><br><span class="line">         </span><br><span class="line">      },first(...args))</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="SyncLoopHook"><a href="#SyncLoopHook" class="headerlink" title="SyncLoopHook"></a>SyncLoopHook</h2><hr><p>监听函数返回<code>true</code>表示继续循环，返回<code>undefine</code>表示结束循环<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {SyncLoopHook}=<span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> SyncLoopHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(count++);</span><br><span class="line">    <span class="keyword">if</span>(count==<span class="number">3</span>){</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line">queue.call(<span class="string">'zfpx'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncLoopHook</span></span>{</span><br><span class="line">     <span class="keyword">constructor</span>(){</span><br><span class="line">        <span class="keyword">this</span>.tasks=[]</span><br><span class="line">    }</span><br><span class="line">    tap(name,task){</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task)</span><br><span class="line">    }</span><br><span class="line">    call(...args){</span><br><span class="line">        <span class="keyword">this</span>.tasks.forEach(<span class="function">(<span class="params">val,index</span>)=&gt;</span>{</span><br><span class="line">            <span class="keyword">let</span> ind=<span class="number">0</span>,ret=<span class="literal">true</span>;</span><br><span class="line">             <span class="keyword">do</span>{</span><br><span class="line">                 ret=<span class="keyword">this</span>.tasks[ind++](...args)</span><br><span class="line">             }<span class="keyword">while</span>(ret &amp;&amp; ind&lt;=index)</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><hr><h2 id="AsyncParallelHook"><a href="#AsyncParallelHook" class="headerlink" title="AsyncParallelHook"></a>AsyncParallelHook</h2><hr><p>异步并行执行钩子</p><h3 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncParallelHook}=<span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncParallelHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(){</span><br><span class="line">        <span class="keyword">this</span>.tasks=[]</span><br><span class="line">    }</span><br><span class="line">    tap(name,task){</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task)</span><br><span class="line">    }</span><br><span class="line">    callAsync(...args){</span><br><span class="line">         <span class="keyword">let</span> callback=args.pop();</span><br><span class="line">        <span class="keyword">this</span>.tasks.forEach(<span class="function"><span class="params">task</span>=&gt;</span>task(...args))</span><br><span class="line">         callback();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="tapAsync"><a href="#tapAsync" class="headerlink" title="tapAsync"></a>tapAsync</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncParallelHook}=<span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapAsync(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">        callback();</span><br><span class="line">    },<span class="number">1000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">        callback();</span><br><span class="line">    },<span class="number">2000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">        callback();</span><br><span class="line">    },<span class="number">3000</span>)</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncParallelHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>(){</span><br><span class="line">        <span class="keyword">this</span>.tasks=[]</span><br><span class="line">    }</span><br><span class="line">    tapAsync(name,task){</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task)</span><br><span class="line">    }</span><br><span class="line">    callAsync(...args){</span><br><span class="line">         <span class="keyword">let</span> callback=args.pop();</span><br><span class="line">         <span class="keyword">let</span> i=<span class="number">0</span>,length = <span class="keyword">this</span>.tasks.length;</span><br><span class="line">        <span class="keyword">this</span>.tasks.forEach(<span class="function"><span class="params">task</span>=&gt;</span>task(...args,done))</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>)</span>{</span><br><span class="line">            <span class="keyword">if</span>(++i==length){</span><br><span class="line">                callback(err)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="tapPromise"><a href="#tapPromise" class="headerlink" title="tapPromise"></a>tapPromise</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncParallelHook}=<span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapPromise(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">1000</span>)</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">2000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">3000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.promise(<span class="string">'zfpx'</span>).then(<span class="function"><span class="params">()</span>=&gt;</span>{</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncParallelHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tapPromise(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    promise(...args) {</span><br><span class="line">     <span class="keyword">let</span> promises = <span class="keyword">this</span>.tasks.map(<span class="function"><span class="params">task</span> =&gt;</span> task(...args));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">            <span class="keyword">let</span> result=[]</span><br><span class="line">            <span class="keyword">let</span> count=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;promises.length;i++){</span><br><span class="line">                promises[i].then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">                    result[i]=data;</span><br><span class="line">                    <span class="keyword">if</span>(++count===promise.length){</span><br><span class="line">                        resolve(result)</span><br><span class="line">                    }</span><br><span class="line">                },<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>{</span><br><span class="line">        reject(err);</span><br><span class="line">      })</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="AsyncParallelBailHook"><a href="#AsyncParallelBailHook" class="headerlink" title="AsyncParallelBailHook"></a>AsyncParallelBailHook</h2><p>带保险的异步并行执行钩子</p><h3 id="tap-1"><a href="#tap-1" class="headerlink" title="tap"></a>tap</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//let {AsyncParallelBailHook} = require('tapable');</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncParallelBailHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tap(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    callAsync() {</span><br><span class="line">        <span class="keyword">let</span> args=<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">let</span> callback=args.pop();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="keyword">this</span>.tasks.length;i++){</span><br><span class="line">            <span class="keyword">let</span> ret=<span class="keyword">this</span>.tasks[i](...args);</span><br><span class="line">            <span class="keyword">if</span> (ret) {</span><br><span class="line">                <span class="keyword">return</span> callback(ret);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue=<span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Wrong"</span>;</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="tapAsync-1"><a href="#tapAsync-1" class="headerlink" title="tapAsync"></a>tapAsync</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//let {AsyncParallelBailHook} = require('tapable');</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncParallelBailHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tapAsync(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    callAsync() {</span><br><span class="line">        <span class="keyword">let</span> args=<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">let</span> finalCallback=args.pop();</span><br><span class="line">        <span class="keyword">let</span> count=<span class="number">0</span>,total=<span class="keyword">this</span>.tasks.length;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params">err</span>) </span>{</span><br><span class="line">            <span class="keyword">if</span> (err) {</span><br><span class="line">                <span class="keyword">return</span> finalCallback(err);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">if</span> (++count == total) {</span><br><span class="line">                    <span class="keyword">return</span> finalCallback();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;total;i++){</span><br><span class="line">            <span class="keyword">let</span> task=<span class="keyword">this</span>.tasks[i];</span><br><span class="line">            task(...args,done);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue=<span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapAsync(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">    callback(<span class="string">'Wrong'</span>);</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    callback();</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">    callback();</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="tapPromise-1"><a href="#tapPromise-1" class="headerlink" title="tapPromise"></a>tapPromise</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//let {AsyncParallelBailHook} = require('tapable');</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncParallelBailHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tapPromise(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    promise() {</span><br><span class="line">        <span class="keyword">let</span> args=<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">let</span> promises = <span class="keyword">this</span>.tasks.map(<span class="function"><span class="params">task</span> =&gt;</span> task(...arguments));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.all(promises);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapPromise(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">1000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">            reject();</span><br><span class="line">        },<span class="number">2000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">queue.tapPromise(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">3000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">queue.promise(<span class="string">'zfpx'</span>).then(<span class="function"><span class="params">()</span>=&gt;</span>{</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">},err =&gt; {</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h2 id="AsyncSeriesHook"><a href="#AsyncSeriesHook" class="headerlink" title="AsyncSeriesHook"></a>AsyncSeriesHook</h2><hr><p>异步串行钩子</p><h3 id="tap-2"><a href="#tap-2" class="headerlink" title="tap"></a>tap</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncSeriesHook} = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p>实现<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tap(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    callAsync(...args) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;total;i++){</span><br><span class="line">            <span class="keyword">let</span> task=<span class="keyword">this</span>.tasks[i];</span><br><span class="line">            task(...args);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="tapAsync-2"><a href="#tapAsync-2" class="headerlink" title="tapAsync"></a>tapAsync</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesBailHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tapAsync(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    callAsync() {</span><br><span class="line">        <span class="keyword">let</span> args = <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">let</span> finalCallback = args.pop();</span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">0</span>, length = <span class="keyword">this</span>.tasks.length;</span><br><span class="line">        <span class="keyword">let</span> next = <span class="function"><span class="params">()</span> =&gt;</span> {</span><br><span class="line">            <span class="keyword">let</span> task = <span class="keyword">this</span>.tasks[index++];</span><br><span class="line">            <span class="keyword">if</span> (task) {</span><br><span class="line">                task(...args, next);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                finalCallback();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        next();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapAsync(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">   setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">   },<span class="number">1000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">        callback();</span><br><span class="line">    },<span class="number">2000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">        callback();</span><br><span class="line">    },<span class="number">3000</span>)</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="tapPromise-2"><a href="#tapPromise-2" class="headerlink" title="tapPromise"></a>tapPromise</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tapPromise(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    promise() {</span><br><span class="line">         <span class="comment">//first是第一个函数， tasks是剩下的函数</span></span><br><span class="line">        <span class="keyword">let</span> [first, ...tasks] = <span class="keyword">this</span>.tasks;</span><br><span class="line">        <span class="keyword">return</span> tasks.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">return</span> a.then(<span class="function"><span class="params">()</span> =&gt;</span> b());</span><br><span class="line">        }, first(...args));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue=<span class="keyword">new</span> AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapPromise(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>{</span><br><span class="line">       setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">           resolve();</span><br><span class="line">       },<span class="number">1000</span>)</span><br><span class="line">   });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">2000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">3000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.promise(<span class="string">'zfpx'</span>).then(<span class="function"><span class="params">data</span>=&gt;</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h2 id="AsyncSeriesBailHook"><a href="#AsyncSeriesBailHook" class="headerlink" title="AsyncSeriesBailHook"></a>AsyncSeriesBailHook</h2><h3 id="tap-3"><a href="#tap-3" class="headerlink" title="tap"></a>tap</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncSeriesBailHook} = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Wrong"</span>;</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="tabAsync"><a href="#tabAsync" class="headerlink" title="tabAsync"></a>tabAsync</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//let {AsyncSeriesBailHook}=require('tapable');</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesBailHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tapAsync(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    callAsync() {</span><br><span class="line">        <span class="keyword">let</span> args=<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">let</span> callback=args.pop();</span><br><span class="line">        <span class="keyword">let</span> i=<span class="number">0</span>,size = <span class="keyword">this</span>.tasks.length;</span><br><span class="line">        <span class="keyword">let</span> next=<span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span>  callback(err);</span><br><span class="line">            <span class="keyword">let</span> task=<span class="keyword">this</span>.tasks[i++];</span><br><span class="line">            task?task(...args,next):callback();</span><br><span class="line">        }</span><br><span class="line">        next();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapAsync(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">   setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">       callback(<span class="string">'wrong'</span>);</span><br><span class="line">   },<span class="number">1000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">        callback();</span><br><span class="line">    },<span class="number">2000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">        callback();</span><br><span class="line">    },<span class="number">3000</span>)</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="tapPromise-3"><a href="#tapPromise-3" class="headerlink" title="tapPromise"></a>tapPromise</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncSeriesBailHook} = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapPromise(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>{</span><br><span class="line">       setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">           <span class="comment">//resolve();</span></span><br><span class="line">           reject();</span><br><span class="line">       },<span class="number">1000</span>)</span><br><span class="line">   });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">2000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        },<span class="number">3000</span>)</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.promise(<span class="string">'zfpx'</span>).then(<span class="function"><span class="params">err</span>=&gt;</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">},err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><hr><h2 id="AsyncSeriesWaterfallHook"><a href="#AsyncSeriesWaterfallHook" class="headerlink" title="AsyncSeriesWaterfallHook"></a>AsyncSeriesWaterfallHook</h2><h3 id="tap-4"><a href="#tap-4" class="headerlink" title="tap"></a>tap</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncSeriesWaterfallHook} = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tap(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>,data);</span><br><span class="line">});</span><br><span class="line">queue.tap(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>,data);</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,err=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd</span><br></pre></td></tr></tbody></table></figure><h3 id="tapAsync-3"><a href="#tapAsync-3" class="headerlink" title="tapAsync"></a>tapAsync</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//let {AsyncSeriesBailHook}=require('tapable');</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesWaterfallHook</span></span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks=[];</span><br><span class="line">    }</span><br><span class="line">    tapAsync(name,task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    callAsync() {</span><br><span class="line">        <span class="keyword">let</span> args=<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">let</span> callback=args.pop();</span><br><span class="line">        <span class="keyword">let</span> i=<span class="number">0</span>,size = <span class="keyword">this</span>.tasks.length;</span><br><span class="line">        <span class="keyword">let</span> next=<span class="function">(<span class="params">err,data</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span>  callback(err);</span><br><span class="line">            <span class="keyword">let</span> task=<span class="keyword">this</span>.tasks[i++];</span><br><span class="line">            <span class="keyword">if</span> (task) {</span><br><span class="line">                <span class="keyword">if</span> (i==<span class="number">0</span>) {</span><br><span class="line">                    task(...args,next);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    task(data,next);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                callback(err,data);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        next();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapAsync(<span class="string">'1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">name,callback</span>)</span>{</span><br><span class="line">   setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">       callback(<span class="literal">null</span>,<span class="number">1</span>);</span><br><span class="line">   },<span class="number">1000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'2'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">        callback(<span class="literal">null</span>,<span class="number">2</span>);</span><br><span class="line">    },<span class="number">2000</span>)</span><br><span class="line">});</span><br><span class="line">queue.tapAsync(<span class="string">'3'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data,callback</span>)</span>{</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">        callback(<span class="literal">null</span>,<span class="number">3</span>);</span><br><span class="line">    },<span class="number">3000</span>)</span><br><span class="line">});</span><br><span class="line">queue.callAsync(<span class="string">'zfpx'</span>,(err,data)=&gt;{</span><br><span class="line">    <span class="built_in">console</span>.log(err,data);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="tapPromise-4"><a href="#tapPromise-4" class="headerlink" title="tapPromise"></a>tapPromise</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> {AsyncSeriesWaterfallHook} = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesWaterfallHook</span> </span>{</span><br><span class="line">    <span class="keyword">constructor</span>() {</span><br><span class="line">        <span class="keyword">this</span>.tasks = [];</span><br><span class="line">    }</span><br><span class="line">    tapPromise(name, task) {</span><br><span class="line">        <span class="keyword">this</span>.tasks.push(task);</span><br><span class="line">    }</span><br><span class="line">    promise(...args) {</span><br><span class="line">        <span class="comment">//first是第一个函数， tasks是剩下的函数</span></span><br><span class="line">        <span class="keyword">let</span> [first, ...tasks] = <span class="keyword">this</span>.tasks;</span><br><span class="line">        <span class="keyword">return</span> tasks.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">return</span> a.then(<span class="function">(<span class="params">data</span>) =&gt;</span> b(data));</span><br><span class="line">        }, first(...args));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">            <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">            resolve(<span class="number">1</span>);</span><br><span class="line">        }, <span class="number">1000</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">            <span class="built_in">console</span>.log(data, <span class="number">2</span>);</span><br><span class="line">            resolve(<span class="number">2</span>);</span><br><span class="line">        }, <span class="number">2000</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.tapPromise(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">            <span class="built_in">console</span>.log(data, <span class="number">3</span>);</span><br><span class="line">            resolve(<span class="number">3</span>);</span><br><span class="line">        }, <span class="number">3000</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line">queue.promise(<span class="string">'zfpx'</span>).then(<span class="function"><span class="params">err</span> =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h2 id="tapable-1"><a href="#tapable-1" class="headerlink" title="tapable"></a>tapable</h2><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> {Tapable,SyncHook} = <span class="built_in">require</span>(<span class="string">"tapable"</span>);</span><br><span class="line"><span class="keyword">const</span> t = <span class="keyword">new</span> Tapable();</span><br><span class="line">t.hooks = {</span><br><span class="line">    myHook: <span class="keyword">new</span> SyncHook()</span><br><span class="line">};</span><br><span class="line"><span class="keyword">let</span> called = <span class="number">0</span>;</span><br><span class="line">t.plugin(<span class="string">"my-hook"</span>, () =&gt; called++);</span><br><span class="line">t.hooks.myHook.call();</span><br><span class="line">t.plugin(<span class="string">"my-hook"</span>, () =&gt; called += <span class="number">10</span>);</span><br><span class="line">t.hooks.myHook.call();</span><br><span class="line"><span class="built_in">console</span>.log(called);</span><br></pre></td></tr></tbody></table></figure><hr><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://github.com/alienzhou/webpack-internal-plugin-relation" target="_blank" rel="noopener">webpack-internal-plugin-relation</a></li><li><a href="https://juejin.im/post/5c25f920e51d45593b4bc719" target="_blank" rel="noopener">webpack系列之二Tapable</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/11/webpack-bundle-源码/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/11/webpack-bundle-源码/" itemprop="url">webpack-bundle-源码</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-11T15:49:58+08:00">2019-01-11 </time></span><span id="/2019/01/11/webpack-bundle-源码/" class="leancloud_visitors" data-flag-title="webpack-bundle-源码"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">2,772 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">13</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="webpack打包基础源码"><a href="#webpack打包基础源码" class="headerlink" title="webpack打包基础源码"></a>webpack打包基础源码</h2><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>{ <span class="comment">// webpack 启动函数</span></span><br><span class="line"> 	<span class="comment">//  模块的缓存</span></span><br><span class="line"> 	<span class="keyword">var</span> installedModules = {};</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// webpack自己实现的在浏览器里能够执行的require方法</span></span><br><span class="line"> 	<span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>{</span><br><span class="line"></span><br><span class="line"> 		<span class="comment">// 看看此模块是否在缓存中</span></span><br><span class="line"> 		<span class="keyword">if</span>(installedModules[moduleId]) {</span><br><span class="line">            <span class="comment">// 如果缓存有的话，则取它缓存的模块的对象的exports属性并返回</span></span><br><span class="line"> 			<span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line"> 		}</span><br><span class="line"> 		<span class="comment">// 创建一个新的模块，并且放置到缓存</span></span><br><span class="line"> 		<span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = {</span><br><span class="line"> 			i: moduleId,</span><br><span class="line"> 			l: <span class="literal">false</span>,</span><br><span class="line"> 			exports: {}</span><br><span class="line"> 		};</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 执行模块函数,传入参数 </span></span><br><span class="line">        <span class="comment">//  1 module.exports=this 2.module 模块对象  3.module.exports 模块的导出对象 4.require方法</span></span><br><span class="line"> 		modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</span><br><span class="line"></span><br><span class="line"> 		<span class="comment">// 把模块标识 为已加载 loaded=true</span></span><br><span class="line"> 		<span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"> 		<span class="comment">// 返回模块的导出对象</span></span><br><span class="line"> 		<span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line"> 	}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// 把modules挂载到require的m属性</span></span><br><span class="line"> 	__webpack_require__.m = modules;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// 把模块的缓存挂载到require的c属性上</span></span><br><span class="line"> 	__webpack_require__.c = installedModules;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// 定义(define)一个getter方法 1导出对象 2名称 3 getter</span></span><br><span class="line"> 	__webpack_require__.d = <span class="function"><span class="keyword">function</span>(<span class="params">exports, name, getter</span>) </span>{</span><br><span class="line">        <span class="comment">//  判断对象有没有某个属性 exports.hasOwnProperty(name)</span></span><br><span class="line"> 		<span class="keyword">if</span>(!__webpack_require__.o(exports, name)) {</span><br><span class="line">        <span class="comment">//给exports对象定义name属性，值是可枚举的，get</span></span><br><span class="line">             <span class="built_in">Object</span>.defineProperty(exports, name, { <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">get</span>: getter });</span><br><span class="line">         <span class="comment">//   exports[name]</span></span><br><span class="line"> 		}</span><br><span class="line"> 	};</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象的Symbol.toStringTag属性，指向一个方法</span></span><br><span class="line"><span class="comment">     * 在该对象上面调用Object.prototype.toString方法时，如果这个属性存在，它的返回值会出现在toString方法返回的字符串之中，表示对象的类型</span></span><br><span class="line"><span class="comment">     * 也就是说，这个属性可以用来定制[object Object]或[object Array]中object后面的那个字符串</span></span><br><span class="line"><span class="comment">     * ({[Symbol.toStringTag]: 'Foo'}.toString())  "[object Foo]"</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// 在导出对象上定义__esModule属性</span></span><br><span class="line">    <span class="comment">//如果此exports对象__esModule属性为true的话，表示这是一个es6的模块</span></span><br><span class="line"> 	__webpack_require__.r = <span class="function"><span class="keyword">function</span>(<span class="params">exports</span>) </span>{</span><br><span class="line"> 		<span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">Symbol</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">Symbol</span>.toStringTag) {</span><br><span class="line">            <span class="comment">// 如果是支持es6的Symbol属性的话，那么定义属性 exports[Symbol.toStringTag] ='Module'</span></span><br><span class="line">             <span class="built_in">Object</span>.defineProperty(exports, <span class="built_in">Symbol</span>.toStringTag, { <span class="attr">value</span>: <span class="string">'Module'</span> });</span><br><span class="line">            <span class="comment">//  exports.toString = "[object Module]"</span></span><br><span class="line">         }</span><br><span class="line">        <span class="comment">//  exports['__esModule'] = true;</span></span><br><span class="line"> 		<span class="built_in">Object</span>.defineProperty(exports, <span class="string">'__esModule'</span>, { <span class="attr">value</span>: <span class="literal">true</span> });</span><br><span class="line"> 	};</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// create a fake namespace object</span></span><br><span class="line"> 	<span class="comment">// mode &amp; 1: value is a module id, require it</span></span><br><span class="line"> 	<span class="comment">// mode &amp; 2: merge all properties of value into the ns</span></span><br><span class="line"> 	<span class="comment">// mode &amp; 4: return value when already ns object</span></span><br><span class="line"> 	<span class="comment">// mode &amp; 8|1: behave like require</span></span><br><span class="line"> 	__webpack_require__.t = <span class="function"><span class="keyword">function</span>(<span class="params">value, mode</span>) </span>{</span><br><span class="line"> 		<span class="keyword">if</span>(mode &amp; <span class="number">1</span>) value = __webpack_require__(value);</span><br><span class="line"> 		<span class="keyword">if</span>(mode &amp; <span class="number">8</span>) <span class="keyword">return</span> value;</span><br><span class="line"> 		<span class="keyword">if</span>((mode &amp; <span class="number">4</span>) &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; value &amp;&amp; value.__esModule) <span class="keyword">return</span> value;</span><br><span class="line"> 		<span class="keyword">var</span> ns = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"> 		__webpack_require__.r(ns);</span><br><span class="line"> 		<span class="built_in">Object</span>.defineProperty(ns, <span class="string">'default'</span>, { <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="attr">value</span>: value });</span><br><span class="line"> 		<span class="keyword">if</span>(mode &amp; <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> value != <span class="string">'string'</span>) <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> value) __webpack_require__.d(ns, key, <span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>{ <span class="keyword">return</span> value[key]; }.bind(<span class="literal">null</span>, key));</span><br><span class="line"> 		<span class="keyword">return</span> ns;</span><br><span class="line"> 	};</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// 获取默认导出函数为了兼容性 参数就是module对象</span></span><br><span class="line">     __webpack_require__.n = <span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>{ <span class="comment">//hello</span></span><br><span class="line">    <span class="comment">//先拿到一个getter,如果是es模块，返回模块的default,否则返回自身</span></span><br><span class="line"> 		<span class="keyword">var</span> getter = <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.__esModule ?</span><br><span class="line"> 			<span class="function"><span class="keyword">function</span> <span class="title">getDefault</span>(<span class="params"></span>) </span>{ <span class="keyword">return</span> <span class="built_in">module</span>[<span class="string">'default'</span>]; } :</span><br><span class="line">             <span class="function"><span class="keyword">function</span> <span class="title">getModuleExports</span>(<span class="params"></span>) </span>{ <span class="keyword">return</span> <span class="built_in">module</span>; };</span><br><span class="line">    <span class="comment">//var getter =function() { return 'hello'; };</span></span><br><span class="line">    <span class="comment">//给getter上定义一个a属性，值为getter</span></span><br><span class="line">    <span class="comment">//该模块的a属性 = 模块本身</span></span><br><span class="line">         __webpack_require__.d(getter, <span class="string">'a'</span>, getter);</span><br><span class="line">    <span class="comment">// get a(){return 'a'}   obj['a']</span></span><br><span class="line">    <span class="comment">// getter['a'] = getter;</span></span><br><span class="line">    <span class="comment">//(function() { return 'hello'; })['a'] =  (function() { return 'hello'; })</span></span><br><span class="line"> 		<span class="keyword">return</span> getter;</span><br><span class="line"> 	};</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// // Object.prototype.hasOwnProperty.call</span></span><br><span class="line">    <span class="comment">//判断对象有没有某个属性</span></span><br><span class="line"> 	__webpack_require__.o = <span class="function"><span class="keyword">function</span>(<span class="params">object, property</span>) </span>{ <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.hasOwnProperty.call(object, property); };</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">//webpack的公开路径  webpack publicPath</span></span><br><span class="line"> 	__webpack_require__.p = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// 加载入口模块并且返回导出对象 s就是入口标识符</span></span><br><span class="line"> 	<span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"./src/index.js"</span>);</span><br><span class="line"> })</span><br><span class="line"> <span class="comment">//modules是一个对象，有属性和值，属性就是此模块的ID，其实就是相对于根目录的相对路径</span></span><br><span class="line"> ({</span><br><span class="line"></span><br><span class="line"> <span class="string">"./src/index.js"</span>:</span><br><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">module, exports</span>) </span>{</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"console.log('1')"</span>);</span><br><span class="line"> })</span><br><span class="line"> });</span><br></pre></td></tr></tbody></table></figure><h3 id="webpack打包懒加载源码"><a href="#webpack打包懒加载源码" class="headerlink" title="webpack打包懒加载源码"></a>webpack打包懒加载源码</h3><p>./src/index.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">"#root"</span>).addEventListener(<span class="string">"click"</span>,()=&gt;{</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">"./a.js"</span>).then(<span class="function"><span class="params">res</span>=&gt;</span>res)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p></p><p>bundle.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"> (<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{ <span class="comment">//webpack的启动函数</span></span><br><span class="line">   <span class="comment">// 安装一个JSONP的回调为了加载chunk代码块</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">webpackJsonpCallback</span>(<span class="params">data</span>) </span>{<span class="comment">//data=[[0],additionalModules]</span></span><br><span class="line">     <span class="keyword">var</span> chunkIds = data[<span class="number">0</span>];<span class="comment">//第一个元素是chunkId的数组</span></span><br><span class="line">     <span class="keyword">var</span> moreModules = data[<span class="number">1</span>];<span class="comment">//这个chunk里包含的额外更多的模块</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 把这次取出来的更多的模块添加到modules对象中</span></span><br><span class="line">     <span class="comment">// 然后把所有的chunkIds标识为已加载，并且执行回调函数</span></span><br><span class="line">     <span class="keyword">var</span> moduleId, chunkId, i = <span class="number">0</span>,</span><br><span class="line">       resolves = [];</span><br><span class="line">     <span class="keyword">for</span> (; i &lt; chunkIds.length; i++) {<span class="comment">//循环本次取出来的chunkIds</span></span><br><span class="line">       chunkId = chunkIds[i];<span class="comment">//先取出一个chunkId</span></span><br><span class="line">       <span class="keyword">if</span> (installedChunks[chunkId]) {<span class="comment">//如果说有值的话</span></span><br><span class="line">         <span class="comment">//把这个installedChunks[chunkId]的0元素，promise resovle方法添加resolves数组中去</span></span><br><span class="line">         resolves.push(installedChunks[chunkId][<span class="number">0</span>]);</span><br><span class="line">       }</span><br><span class="line">       installedChunks[chunkId] = <span class="number">0</span>;<span class="comment">//加载完成</span></span><br><span class="line">     }</span><br><span class="line">     <span class="comment">//循环迭代新模块并且</span></span><br><span class="line">     <span class="keyword">for</span> (moduleId <span class="keyword">in</span> moreModules) {</span><br><span class="line">         <span class="comment">//把新的模块对象的上的属性全部合并或者说拷贝到老的modules对象上</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(moreModules, moduleId)) {</span><br><span class="line">         modules[moduleId] = moreModules[moduleId];</span><br><span class="line">       }</span><br><span class="line">     }</span><br><span class="line">     <span class="comment">//如果parentJsonpFunction有值的话，调用它,其实就是jsonArray.push方法</span></span><br><span class="line">    <span class="comment">//  如果没值说明先加载异步模块,window["webpackJsonp"]已经添加了该数组</span></span><br><span class="line">     <span class="keyword">if</span> (parentJsonpFunction) parentJsonpFunction(data);</span><br><span class="line">    <span class="comment">//依次调用resolve方法，让每个promise都成功</span></span><br><span class="line">     <span class="keyword">while</span> (resolves.length) {</span><br><span class="line">        <span class="comment">//缓存的异步模块直接提示成功  resolve()</span></span><br><span class="line">       resolves.shift()();</span><br><span class="line">     }</span><br><span class="line"></span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模块的缓存</span></span><br><span class="line">   <span class="keyword">var</span> installedModules = {};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这是一个对象，用来存放加载过的和加载中的代码</span></span><br><span class="line">    <span class="comment">//chunk=undefined 表示未加载</span></span><br><span class="line">    <span class="comment">// chunk=null 表示预加载或者预获取</span></span><br><span class="line">    <span class="comment">//chunk=promise 的话表示加载中</span></span><br><span class="line">    <span class="comment">//chunk=0 表示已加载或者说加载完成</span></span><br><span class="line">   <span class="keyword">var</span> installedChunks = {</span><br><span class="line">     <span class="string">"main"</span>: <span class="number">0</span></span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 用来生成脚本路径的函数</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">jsonpScriptSrc</span>(<span class="params">chunkId</span>) </span>{</span><br><span class="line">     <span class="keyword">return</span> __webpack_require__.p + <span class="string">""</span> + chunkId + <span class="string">".bundle.js"</span></span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// require方法</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>{</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 检查模块是否在缓存</span></span><br><span class="line">     <span class="keyword">if</span> (installedModules[moduleId]) {</span><br><span class="line">       <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">     }</span><br><span class="line">     <span class="comment">// 创建一个新模块并且放到缓存中</span></span><br><span class="line">     <span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = {</span><br><span class="line">       i: moduleId,</span><br><span class="line">       l: <span class="literal">false</span>,</span><br><span class="line">       exports: {}</span><br><span class="line">     };</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 执行模块函数，给module.exports赋值</span></span><br><span class="line">     modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 把模块设置为已加载</span></span><br><span class="line">     <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 返回模块的导出对象</span></span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个文件只包含入口chunk</span></span><br><span class="line">  <span class="comment">//这个代码块加载函数是为了加载额外的模块</span></span><br><span class="line"><span class="comment">//   chunkId=0</span></span><br><span class="line">   __webpack_require__.e = <span class="function"><span class="keyword">function</span> <span class="title">requireEnsure</span>(<span class="params">chunkId</span>) </span>{</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> promises = [];<span class="comment">//创建一个空的promise数组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 先取出此chunkID对应的值 ,第一次的肯定是没有值</span></span><br><span class="line">     <span class="keyword">var</span> installedChunkData = installedChunks[chunkId];</span><br><span class="line">     <span class="keyword">if</span> (installedChunkData !== <span class="number">0</span>) { <span class="comment">// 0 means "already installed".</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">// 如果返回值是一个promise表示正在加载</span></span><br><span class="line">       <span class="keyword">if</span> (installedChunkData) {</span><br><span class="line">         promises.push(installedChunkData[<span class="number">2</span>]);</span><br><span class="line">       } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//   在chunk缓存中创建一个promise</span></span><br><span class="line">         <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>{</span><br><span class="line">            <span class="comment">//  将chunkData的数据赋值为一个数组 1.promise.resolve 2.promise.reject</span></span><br><span class="line">           installedChunkData = installedChunks[chunkId] = [resolve, reject];</span><br><span class="line">         });</span><br><span class="line">        <span class="comment">//  把installedChunkData[2]赋值为整个promise并且添加到promise数组中去</span></span><br><span class="line">         promises.push(installedChunkData[<span class="number">2</span>] = promise);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 开始代码块的加载</span></span><br><span class="line">         <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>); <span class="comment">//创建一个script脚本</span></span><br><span class="line">         <span class="keyword">var</span> onScriptComplete; <span class="comment">//当脚本完成后</span></span><br><span class="line"></span><br><span class="line">         script.charset = <span class="string">'utf-8'</span>;<span class="comment">//设置脚本的编码</span></span><br><span class="line">         script.timeout = <span class="number">120</span>;<span class="comment">//设置脚本的超时时间</span></span><br><span class="line">         <span class="keyword">if</span> (__webpack_require__.nc) { <span class="comment">//用来安全处理的 nonce</span></span><br><span class="line">           script.setAttribute(<span class="string">"nonce"</span>, __webpack_require__.nc);</span><br><span class="line">         }</span><br><span class="line">        <span class="comment">//  拼出一个URL路径度且赋给script.src</span></span><br><span class="line">         script.src = jsonpScriptSrc(chunkId);</span><br><span class="line">        <span class="comment">// 定义加载后的回调函数</span></span><br><span class="line">         onScriptComplete = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>{</span><br><span class="line">           <span class="comment">//  防止IE下面的内存泄露</span></span><br><span class="line">           script.onerror = script.onload = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 清除定时器.如果是提前执行此函数，则需要先清除定时器</span></span><br><span class="line">           clearTimeout(timeout);</span><br><span class="line">            <span class="comment">//  取得已安装的代码块中的chunk</span></span><br><span class="line">           <span class="keyword">var</span> chunk = installedChunks[chunkId];</span><br><span class="line">           <span class="keyword">if</span> (chunk !== <span class="number">0</span>) {<span class="comment">//如果不等0表示加载失败</span></span><br><span class="line">             <span class="keyword">if</span> (chunk) {</span><br><span class="line">               <span class="keyword">var</span> errorType = event &amp;&amp; (event.type === <span class="string">'load'</span> ? <span class="string">'missing'</span> : event.type);</span><br><span class="line">               <span class="keyword">var</span> realSrc = event &amp;&amp; event.target &amp;&amp; event.target.src;</span><br><span class="line">               <span class="keyword">var</span> error = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Loading chunk '</span> + chunkId + <span class="string">' failed.\n('</span> + errorType + <span class="string">': '</span> + realSrc + <span class="string">')'</span>);</span><br><span class="line">               error.type = errorType;</span><br><span class="line">               error.request = realSrc;</span><br><span class="line">               chunk[<span class="number">1</span>](error);<span class="comment">//直接调用chunk[1],把error作为参数传进去，调用promise的reject方法，让promise失败</span></span><br><span class="line">             }</span><br><span class="line">             <span class="comment">//把对应的值置为undefine</span></span><br><span class="line">             installedChunks[chunkId] = <span class="literal">undefined</span>;</span><br><span class="line">           }</span><br><span class="line">         };</span><br><span class="line">          <span class="comment">//开启了一个定时器，如果说到了120秒之后请求还没有回来，我们就认为超时了，直接执行回调</span></span><br><span class="line">         <span class="keyword">var</span> timeout = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">           onScriptComplete({</span><br><span class="line">             type: <span class="string">'timeout'</span>,</span><br><span class="line">             target: script</span><br><span class="line">           });</span><br><span class="line">         }, <span class="number">120000</span>);</span><br><span class="line">         script.onerror = script.onload = onScriptComplete;</span><br><span class="line">         <span class="comment">//把JSONP脚本添加到head标签</span></span><br><span class="line">         <span class="built_in">document</span>.head.appendChild(script);</span><br><span class="line">       }</span><br><span class="line">     }</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">Promise</span>.all(promises); <span class="comment">//返回一个promise</span></span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   <span class="comment">// expose the modules object (__webpack_modules__)</span></span><br><span class="line">   __webpack_require__.m = modules;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// expose the module cache</span></span><br><span class="line">   __webpack_require__.c = installedModules;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// define getter function for harmony exports</span></span><br><span class="line">   __webpack_require__.d = <span class="function"><span class="keyword">function</span> (<span class="params">exports, name, getter</span>) </span>{</span><br><span class="line">     <span class="keyword">if</span> (!__webpack_require__.o(exports, name)) {</span><br><span class="line">       <span class="built_in">Object</span>.defineProperty(exports, name, {</span><br><span class="line">         enumerable: <span class="literal">true</span>,</span><br><span class="line">         get: getter</span><br><span class="line">       });</span><br><span class="line">     }</span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   <span class="comment">// define __esModule on exports</span></span><br><span class="line">   __webpack_require__.r = <span class="function"><span class="keyword">function</span> (<span class="params">exports</span>) </span>{</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Symbol</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">Symbol</span>.toStringTag) {</span><br><span class="line">       <span class="built_in">Object</span>.defineProperty(exports, <span class="built_in">Symbol</span>.toStringTag, {</span><br><span class="line">         value: <span class="string">'Module'</span></span><br><span class="line">       });</span><br><span class="line">     }</span><br><span class="line">     <span class="built_in">Object</span>.defineProperty(exports, <span class="string">'__esModule'</span>, {</span><br><span class="line">       value: <span class="literal">true</span></span><br><span class="line">     });</span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   <span class="comment">// create a fake namespace object 创建一个模拟的命名空间</span></span><br><span class="line">   <span class="comment">// mode &amp; 1: value is a module id, require it 模块是一个模块标识符</span></span><br><span class="line">   <span class="comment">// mode &amp; 2: merge all properties of value into the ns 把所有的属性合并到ns上</span></span><br><span class="line">   <span class="comment">// mode &amp; 4: return value when already ns object 当ns对象OK后返回value</span></span><br><span class="line">   <span class="comment">// mode &amp; 8|1: behave like require 和require表现一样</span></span><br><span class="line">   __webpack_require__.t = <span class="function"><span class="keyword">function</span> (<span class="params">value, mode</span>) </span>{</span><br><span class="line">       <span class="comment">//如果说mode是1的话，则用require去加载这个模块</span></span><br><span class="line">     <span class="keyword">if</span> (mode &amp; <span class="number">1</span>) value = __webpack_require__(value);</span><br><span class="line">      <span class="comment">//如果mode是8的话，则直接返回</span></span><br><span class="line">     <span class="keyword">if</span> (mode &amp; <span class="number">8</span>) <span class="keyword">return</span> value;</span><br><span class="line">     <span class="comment">//如果是mode是4的话 直接返回value</span></span><br><span class="line">     <span class="keyword">if</span> ((mode &amp; <span class="number">4</span>) &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; value &amp;&amp; value.__esModule) <span class="keyword">return</span> value;</span><br><span class="line">      <span class="comment">//创建一个空的对象</span></span><br><span class="line">     <span class="keyword">var</span> ns = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">      <span class="comment">//r就是在对象上定义__esModule= true</span></span><br><span class="line">     __webpack_require__.r(ns);<span class="comment">//ns是一个es模块  es.__esModule= true</span></span><br><span class="line">       <span class="comment">//ns的default属性为value</span></span><br><span class="line">     <span class="built_in">Object</span>.defineProperty(ns, <span class="string">'default'</span>, {</span><br><span class="line">       enumerable: <span class="literal">true</span>,</span><br><span class="line">       value: value</span><br><span class="line">     });</span><br><span class="line">      <span class="comment">// ns['default'] = value;</span></span><br><span class="line">       <span class="comment">//如果mode值是2的话，把value上的所有属性全部拷贝到ns上</span></span><br><span class="line">     <span class="keyword">if</span> (mode &amp; <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> value != <span class="string">'string'</span>)</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> value) __webpack_require__.d(ns, key, <span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>{</span><br><span class="line">         <span class="keyword">return</span> value[key];</span><br><span class="line">       }.bind(<span class="literal">null</span>, key));</span><br><span class="line">     <span class="keyword">return</span> ns;<span class="comment">//ns = {__esModule:true,default:'video'}</span></span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   <span class="comment">// getDefaultExport function for compatibility with non-harmony modules</span></span><br><span class="line">   __webpack_require__.n = <span class="function"><span class="keyword">function</span> (<span class="params">module</span>) </span>{</span><br><span class="line">     <span class="keyword">var</span> getter = <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.__esModule ?</span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">getDefault</span>(<span class="params"></span>) </span>{</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">module</span>[<span class="string">'default'</span>];</span><br><span class="line">       } :</span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">getModuleExports</span>(<span class="params"></span>) </span>{</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">       };</span><br><span class="line">     __webpack_require__.d(getter, <span class="string">'a'</span>, getter);</span><br><span class="line">     <span class="keyword">return</span> getter;</span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Object.prototype.hasOwnProperty.call</span></span><br><span class="line">   __webpack_require__.o = <span class="function"><span class="keyword">function</span> (<span class="params">object, property</span>) </span>{</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.hasOwnProperty.call(object, property);</span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   <span class="comment">// __webpack_public_path__</span></span><br><span class="line">   __webpack_require__.p = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// on error function for async loading</span></span><br><span class="line">   __webpack_require__.oe = <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>{</span><br><span class="line">     <span class="built_in">console</span>.error(err);</span><br><span class="line">     <span class="keyword">throw</span> err;</span><br><span class="line">   };</span><br><span class="line">    <span class="comment">// 刚开始的时候webpackJsonp是undefined,那么就给他一个空数组</span></span><br><span class="line">   <span class="keyword">var</span> jsonpArray = <span class="built_in">window</span>[<span class="string">"webpackJsonp"</span>] = <span class="built_in">window</span>[<span class="string">"webpackJsonp"</span>] || [];</span><br><span class="line">    <span class="comment">//  给数组的push方法绑定数组本身,如果以后有人再调用oldJsonpFunction,就相当于调用jsonpArray.push</span></span><br><span class="line">   <span class="keyword">var</span> oldJsonpFunction = jsonpArray.push.bind(jsonpArray);</span><br><span class="line">    <span class="comment">//让新数组的push方法指向另外一个函数webpackJsonpCallback</span></span><br><span class="line">   jsonpArray.push = webpackJsonpCallback;</span><br><span class="line">   <span class="comment">//拷贝出来一个新的数组 </span></span><br><span class="line">   jsonpArray = jsonpArray.slice();</span><br><span class="line">    <span class="comment">//如果异步函数先加载完成执行的话， window["webpackJsonp"]为一个数组,寻韩执行这个函数 </span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);</span><br><span class="line">    <span class="comment">//   window["webpackJsonp"]的push方法赋值给parentJsonpFunction</span></span><br><span class="line">   <span class="keyword">var</span> parentJsonpFunction = oldJsonpFunction;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 加载入口模块并且返回导出对象 s就是入口标识符</span></span><br><span class="line">   <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">"./src/index.js"</span>);</span><br><span class="line"> })</span><br><span class="line"></span><br><span class="line"> ({</span><br><span class="line">   <span class="string">"./src/index.js"</span>:</span><br><span class="line">     (<span class="function"><span class="keyword">function</span> (<span class="params">module, exports, __webpack_require__</span>) </span>{</span><br><span class="line">       <span class="built_in">eval</span>(<span class="string">`document.querySelector("#root").addEventListener("click",()=&gt;{</span></span><br><span class="line"><span class="string">      __webpack_require__.e(0).then(__webpack_require__.t.bind(null,"./src/a.js", 7)).then(res=&gt;res)</span></span><br><span class="line"><span class="string">  })`</span>);</span><br><span class="line">     })</span><br><span class="line"> });</span><br></pre></td></tr></tbody></table></figure><p></p><p>0.bundle<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">window</span>[<span class="string">"webpackJsonp"</span>] = <span class="built_in">window</span>[<span class="string">"webpackJsonp"</span>] || []).push([[<span class="number">0</span>],{</span><br><span class="line"></span><br><span class="line"><span class="string">"./src/a.js"</span>:</span><br><span class="line"></span><br><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">module, exports</span>) </span>{</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"console.log('1')"</span>);</span><br><span class="line"></span><br><span class="line"> })</span><br><span class="line"></span><br><span class="line">}]);</span><br></pre></td></tr></tbody></table></figure><p></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/11/webpack优化/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/11/webpack优化/" itemprop="url">webpack优化</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-11T14:42:35+08:00">2019-01-11 </time></span><span id="/2019/01/11/webpack优化/" class="leancloud_visitors" data-flag-title="webpack优化"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">3,315 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">14</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="libraryTarget-和-library"><a href="#libraryTarget-和-library" class="headerlink" title="libraryTarget 和 library"></a>libraryTarget 和 library</h2><p>当用 <strong>Webpack</strong> 去构建一个可以被其他模块导入使用的库时需要用到它们</p><ul><li><strong>output.libraryTarget</strong> 配置以何种方式导出库</li><li><strong>output.library</strong> 配置导出库的名称</li></ul><p><strong>output.libraryTarget</strong> 是字符串的枚举类型，支持以下配置</p><h3 id="var-默认"><a href="#var-默认" class="headerlink" title="var (默认)"></a>var (默认)</h3><p>编写的库将通过<code>var</code>被赋值给通过<code>library</code>指定名称的变量</p><h4 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports =  {</span><br><span class="line">    add(a,b) {</span><br><span class="line">        <span class="keyword">return</span> a+b;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="bundle-js"><a href="#bundle-js" class="headerlink" title="bundle.js"></a>bundle.js</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> calculator=(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{}({})</span><br></pre></td></tr></tbody></table></figure><h4 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h4><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> ret = calculator.add(<span class="number">1</span>,<span class="number">2</span>);</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(ret);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="commonjs"><a href="#commonjs" class="headerlink" title="commonjs"></a>commonjs</h3><p>编写的库将通过 <strong>CommonJS</strong> 规范导出。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出方式</span></span><br><span class="line">exports[<span class="string">"calculator"</span>] = (<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{}({})</span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'npm-name'</span>)[<span class="string">'calculator'</span>].add(<span class="number">1</span>,<span class="number">2</span>); <span class="comment">//npm-name是指模块发布到 Npm 代码仓库时的名称</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="commonjs2"><a href="#commonjs2" class="headerlink" title="commonjs2"></a>commonjs2</h3><p>编写的库将通过 <strong>CommonJS</strong> 规范导出。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出方式</span></span><br><span class="line"><span class="built_in">module</span>.exports = (<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{}({})</span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'npm-name'</span>).add(); <span class="comment">//在 output.libraryTarget 为 commonjs2 时，配置 output.library 将没有意义</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="this"><a href="#this" class="headerlink" title="this"></a>this</h3><p>编写的库将通过 <strong>this</strong> 被赋值给通过 <strong>library</strong> 指定的名称，输出和使用的代码如下：<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出方式</span></span><br><span class="line"><span class="keyword">this</span>[<span class="string">"calculator"</span>]= (<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{}({})</span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line"><span class="keyword">this</span>.calculator.add();</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="window"><a href="#window" class="headerlink" title="window"></a>window</h3><p>编写的库将通过 <strong>window</strong> 被赋值给通过 <strong>library</strong> 指定的名称，即把库挂载到 <strong>window</strong> 上，输出和使用的代码如下：<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出方式</span></span><br><span class="line"><span class="built_in">window</span>[<span class="string">"calculator"</span>]= (<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{}({})</span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line"><span class="built_in">window</span>.calculator.add();</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="global"><a href="#global" class="headerlink" title="global"></a>global</h3><p>编写的库将通过 <strong>global</strong> 被赋值给通过 <strong>library</strong> 指定的名称，即把库挂载到 <strong>global</strong> 上，输出和使用的代码如下：<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出方式</span></span><br><span class="line">global[<span class="string">"calculator"</span>]= (<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>{}({})</span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line">global.calculator.add();</span><br></pre></td></tr></tbody></table></figure><p></p><hr><h2 id="动态链接库DLL"><a href="#动态链接库DLL" class="headerlink" title="动态链接库DLL"></a>动态链接库DLL</h2><p>即把基础模块的代码打包进入<strong>动态链接库</strong>里，比如常用的<strong>react</strong>，<strong>vue</strong>等，当需要导入的模块在动态连接库里的时候，模块不能再次被打包，而是去动态连接库里获取</p><p><code>.dll</code>为后缀的文件称为动态链接库，在一个动态链接库中可以包含给<strong>其他模块调用</strong>的函数和数据</p><ul><li>把基础模块独立出来打包到<strong>单独</strong>的动态连接库里</li><li>当需要<strong>导入</strong>的模块在动态连接库里的时候，模块不能再次被<strong>打包</strong>，而是去动态连接库里<strong>获取</strong></li><li><a href="https://webpack.js.org/plugins/dll-plugin/" target="_blank" rel="noopener">dll-plugin</a></li></ul><h3 id="定义Dll"><a href="#定义Dll" class="headerlink" title="定义Dll"></a>定义Dll</h3><ul><li><strong>DllPlugin插件</strong>： 用于<strong>打包</strong>出一个个动态连接库</li><li><strong>DllReferencePlugin</strong>: 在配置文件中<strong>引入DllPlugin插件</strong>打包好的动态连接库</li></ul><p>创建一个<code>webpack.dll.config.js</code>文件打包常用类库到<code>dll</code>中<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> DllPlugin=<span class="built_in">require</span>(<span class="string">'webpack/lib/DllPlugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports={</span><br><span class="line">    entry: {</span><br><span class="line">        react:[<span class="string">'react'</span>,<span class="string">'react-dom'</span>]</span><br><span class="line">    },<span class="comment">// 把 React 相关模块的放到一个单独的动态链接库</span></span><br><span class="line">    output: {</span><br><span class="line">        path: path.resolve(__dirname,<span class="string">'dist'</span>),<span class="comment">// 输出的文件都放到 dist 目录下</span></span><br><span class="line">        filename: <span class="string">'[name].dll.js'</span>,<span class="comment">//输出的动态链接库的文件名称，[name] 代表当前动态链接库的名称</span></span><br><span class="line">        library: <span class="string">'_dll_[name]'</span>,<span class="comment">//存放动态链接库的全局变量名称,例如对应 react 来说就是 _dll_react</span></span><br><span class="line">    },</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> DllPlugin({</span><br><span class="line">            <span class="comment">// 动态链接库的全局变量名称，需要和 output.library 中保持一致</span></span><br><span class="line">            <span class="comment">// 该字段的值也就是输出的 manifest.json 文件 中 name 字段的值</span></span><br><span class="line">            <span class="comment">// 例如 react.manifest.json 中就有 "name": "_dll_react"</span></span><br><span class="line">            name: <span class="string">'_dll_[name]'</span>,</span><br><span class="line">            <span class="comment">// 描述动态链接库的 manifest.json 文件输出时的文件名称</span></span><br><span class="line">            path: path.join(__dirname, <span class="string">'dist'</span>, <span class="string">'[name].manifest.json'</span>)</span><br><span class="line">        })</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack --config webpack.dll.config.js --mode development</span><br></pre></td></tr></tbody></table></figure><p>在往配置文件 <code>webpack.config.js</code>中加入以下代码<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DllReferencePlugin = <span class="built_in">require</span>(<span class="string">'webpack/lib/DllReferencePlugin'</span>)</span><br><span class="line">plugins: [</span><br><span class="line">  <span class="keyword">new</span> DllReferencePlugin({</span><br><span class="line">    manifest:<span class="built_in">require</span>(<span class="string">'./dist/react.manifest.json'</span>)</span><br><span class="line">  })</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack --config webpack.config.js --mode development</span><br></pre></td></tr></tbody></table></figure><p>这样会从<code>dll</code>中获取<code>React</code>，而且不用再次打包<code>React</code>了。可以在<code>HTML</code>中这样使用<br></p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"react.dll.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="多进程之HappyPack"><a href="#多进程之HappyPack" class="headerlink" title="多进程之HappyPack"></a>多进程之HappyPack</h3><ul><li>构建需要解析和处理文件,<code>文件读写</code>和<code>计算密集型</code>的操作太多后速度会很慢</li><li><strong>Node.js</strong> 之上的 <strong>Webpack</strong> 是单线程模型</li><li><strong>happypack</strong> 就能让<strong>Webpack</strong>把任务分解给多个子进程去并发的执行，子进程处理完后再把结果发送给主进程。</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i happypack@next -D</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HappyPack = <span class="built_in">require</span>(<span class="string">'happypack'</span>);</span><br><span class="line">    rules: [</span><br><span class="line">    {</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="comment">// 把对 .js 文件的处理转交给 id 为 babel 的 HappyPack 实例</span></span><br><span class="line">        use: [<span class="string">'happypack/loader?id=babel'</span>],</span><br><span class="line">        exclude: path.resolve(__dirname, <span class="string">'node_modules'</span>),</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="comment">// 把对 .css 文件的处理转交给 id 为 css 的 HappyPack 实例</span></span><br><span class="line">        use: [<span class="string">'happypack/loader?id=css'</span>]</span><br><span class="line">    }</span><br><span class="line">]</span><br><span class="line"><span class="keyword">new</span> Happypack({</span><br><span class="line">            <span class="comment">//ID是标识符的意思，ID用来代理当前的happypack是用来处理一类特定的文件的</span></span><br><span class="line">            id: <span class="string">'js'</span>,</span><br><span class="line">            use: [{</span><br><span class="line">                loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">                <span class="comment">//options=query都是向插件传递参数的</span></span><br><span class="line">                options: {</span><br><span class="line">                    presets: [[<span class="string">"@babel/preset-env"</span>, { <span class="attr">modules</span>: <span class="literal">false</span> }], <span class="string">"@babel/preset-react"</span>],</span><br><span class="line">                    plugins: [</span><br><span class="line">                        [<span class="string">"@babel/plugin-proposal-decorators"</span>, { <span class="string">"legacy"</span>: <span class="literal">true</span> }],</span><br><span class="line">                        [<span class="string">"@babel/plugin-proposal-class-properties"</span>, { <span class="string">"loose"</span>: <span class="literal">true</span> }],</span><br><span class="line">                    ]</span><br><span class="line">                }</span><br><span class="line">            }]</span><br><span class="line">        }),</span><br><span class="line"><span class="keyword">new</span> Happypack({</span><br><span class="line">    <span class="comment">//ID是标识符的意思，ID用来代理当前的happypack是用来处理一类特定的文件的</span></span><br><span class="line">    id: <span class="string">'css'</span>,</span><br><span class="line">    use: [MiniCssExtractPlugin.loader, <span class="string">'css-loader'</span>, <span class="string">'postcss-loader'</span>],</span><br><span class="line">    threads: <span class="number">4</span>,<span class="comment">//你要开启多少个子进程去处理这一类型的文件</span></span><br><span class="line">    verbose: <span class="literal">true</span><span class="comment">//是否要输出详细的日志 verbose</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><hr><h2 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h2><p><strong>CDN</strong> 又叫内容分发网络，通过把资源部署到世界各地，用户在访问时按照就近原则从离用户最近的服务器获取资源，从而加速资源的获取速度</p><p><img src="http://b.zhangyapeng.club/cnd-2019111151424.gif" alt="cnd-2019111151424"></p><ul><li>HTML文件不缓存，放在自己的服务器上，关闭自己服务器的缓存，静态资源的URL变成指向CDN服务器的地址</li><li>静态的<code>JavaScript</code>、<code>CSS</code>、<code>图片</code>等文件开启CDN和缓存，并且文件名带上<code>HASH值</code></li><li>为了<code>并行加载不阻塞</code>，把不同的静态资源分配到不同的<code>CDN服务器</code>上</li></ul><h3 id="使用缓存"><a href="#使用缓存" class="headerlink" title="使用缓存"></a>使用缓存</h3><p>由于 <code>CDN</code> 服务一般都会给资源开启很长时间的缓存，例如用户从 <code>CDN</code> 上获取到了 <code>index.html</code> 这个文件后， 即使之后的发布操作把 <code>index.html</code> 文件给重新覆盖了，但是用户在很长一段时间内还是运行的之前的版本，这会新的导致发布不能立即生效</p><h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><ul><li>针对 <code>HTML</code> 文件：不开启缓存，把 <code>HTML</code> 放到自己的服务器上，而不是 <code>CDN</code> 服务上，同时关闭自己服务器上的缓存。自己的服务器只提供 <code>HTML</code> 文件和数据接口。</li><li>针对静态的 <code>JavaScript</code>、<code>CSS</code>、<code>图片</code>等文件：开启 <code>CDN</code> 和<code>缓存</code>，上传到 <code>CDN</code> 服务上去，同时给每个文件名带上由文件内容算出的 <code>Hash</code> 值</li><li>带上 <code>Hash</code> 值的原因是文件名会随着文件内容而变化，只要文件发生变化其对应的 <code>URL</code> 就会变化，它就会被<code>重新下载</code>，无论缓存时间有多长。</li><li>启用<code>CDN</code>之后 相对路径，都变成了绝对的指向 <code>CDN</code> 服务的 <code>URL</code> 地址</li></ul><h3 id="域名限制"><a href="#域名限制" class="headerlink" title="域名限制"></a>域名限制</h3><ul><li>同一时刻针对同一个域名的资源并行请求是有<code>限制</code></li><li>可以把这些静态资源分散到不同的 <code>CDN</code> 服务上去</li><li>多个域名后会增加域名解析时间</li><li>可以通过在 <code>HTML head</code> 标签中 加入<code>&lt;link rel="dns-prefetch" href=""&gt;</code>去预解析域名，以降低域名解析带来的延迟</li></ul><h3 id="接入CDN"><a href="#接入CDN" class="headerlink" title="接入CDN"></a>接入CDN</h3><p>要给网站接入 <code>CDN</code>，需要把网页的静态资源上传到 <code>CDN</code> 服务上去，在服务这些静态资源的时候需要通过<code>CDN</code> 服务提供的 <code>URL</code> 地址去访问<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output: {</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'[name]_[hash:8].js'</span>,</span><br><span class="line">        publicPath: <span class="string">'http://img.zhufengpeixun.cn'</span></span><br><span class="line">    },</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree Shaking"></a>Tree Shaking</h2><p><code>tree shaking</code> 是一个术语，通常用于描述移除 <code>JavaScript</code> 上下文中的未引用代码。这个术语和概念实际上是兴起于 <code>ES2015</code> 模块打包工具 <code>rollup</code>。你可以将应用程序想象成一棵树。绿色表示实际用到的<code>源码</code>和 <code>library</code>，是树上活的树叶。灰色表示无用的代码，是秋天树上枯萎的树叶。为了除去死去的树叶，你必须摇动这棵树，使它们落下。但是<code>webpack</code>的<code>Tree Shaking</code>依赖静态的<code>ES6</code>模块化语法即通过<code>import</code>和<code>export</code>导入导出的代码，而且需要引入一个能够删除未引用代码(<code>dead code</code>)的压缩工具(<code>minifier</code>)（例如 <code>UglifyJSPlugin</code>）或者在运行命令的时候用<code>webpack --display-used-exports --optimize-minimize --mode production</code></p><h3 id="不要编译ES6模块"><a href="#不要编译ES6模块" class="headerlink" title="不要编译ES6模块"></a>不要编译ES6模块</h3><ul><li>要让 <code>Tree Shaking</code> 正常工作的前提是交给<code>Webpack</code> 的 <code>JavaScript</code> 代码必须是采用 <code>ES6</code> 模块化语法的</li><li>对于 <code>module.export</code> <code>Webpack</code> 无法分析出哪些代码可以剔除</li><li><code>"modules": false</code> 的含义是关闭 <code>Babel</code> 的模块转换功能，保留原本的 <code>ES6</code> 模块化语法。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use:[{</span><br><span class="line">      loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">          options: {</span><br><span class="line">              presets:[[<span class="string">'@babel/preset-env'</span>,{<span class="attr">modules</span>: <span class="literal">false</span> }],<span class="string">'@babel/preset-react'</span>]</span><br><span class="line">      }</span><br><span class="line">  }]</span><br></pre></td></tr></tbody></table></figure><h3 id="显示未使用的导出实例"><a href="#显示未使用的导出实例" class="headerlink" title="显示未使用的导出实例"></a>显示未使用的导出实例</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx webpack --display-used-exports</span><br></pre></td></tr></tbody></table></figure><h3 id="剔除用不上的代码"><a href="#剔除用不上的代码" class="headerlink" title="剔除用不上的代码"></a>剔除用不上的代码</h3><p><strong>Webpack</strong>只是分析出了哪些函数用上了哪些没用上，要剔除用不上的代码还得经过<code>UglifyJS</code>去处理<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack --display-used-exports --optimize-minimize</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="启用压缩"><a href="#启用压缩" class="headerlink" title="启用压缩"></a>启用压缩</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">optimization: {</span><br><span class="line">    minimizer: [</span><br><span class="line">            <span class="keyword">new</span> UglifyJsPlugin({</span><br><span class="line">                cache: <span class="literal">true</span>,<span class="comment">//启动缓存</span></span><br><span class="line">                parallel: <span class="literal">true</span>,<span class="comment">//启动并行压缩</span></span><br><span class="line">                <span class="comment">//如果为true的话，可以获得sourcemap</span></span><br><span class="line">                sourceMap: <span class="literal">true</span> <span class="comment">// set to true if you want JS source maps</span></span><br><span class="line">            }),</span><br><span class="line">            <span class="comment">//压缩css资源的</span></span><br><span class="line">            <span class="keyword">new</span> OptimizeCSSAssetsPlugin({})</span><br><span class="line">        ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="深度分析"><a href="#深度分析" class="headerlink" title="深度分析"></a>深度分析</h3><p><a href="https://github.com/vincentdchan/webpack-deep-scope-analysis-plugin" target="_blank" rel="noopener">webpack-deep-scope-analysis-plugin</a><br><img src="http://b.zhangyapeng.club/webpack-deep-scope-analysis-plugin-2019111152823.jpeg" alt="webpack-deep-scope-analysis-plugin-2019111152823"><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash-es'</span>;</span><br><span class="line"><span class="comment">//加法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isArray</span>(<span class="params">value</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> _.isArray(value);</span><br><span class="line">}</span><br><span class="line"><span class="comment">//减法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> a + b + _.isArray([]);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> {</span><br><span class="line">    isArray,</span><br><span class="line">    add</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebpackDeepScopeAnalysisPlugin = <span class="built_in">require</span>(<span class="string">'webpack-deep-scope-plugin'</span>).default;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.export = {</span><br><span class="line">  plugins: [</span><br><span class="line">    ...,</span><br><span class="line">    <span class="keyword">new</span> WebpackDeepScopeAnalysisPlugin(),</span><br><span class="line">  ],</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="提取公共代码"><a href="#提取公共代码" class="headerlink" title="提取公共代码"></a>提取公共代码</h2><h3 id="为什么需要提取公共代码？"><a href="#为什么需要提取公共代码？" class="headerlink" title="为什么需要提取公共代码？"></a>为什么需要提取公共代码？</h3><p>大网站有多个页面，每个页面由于采用相同技术栈和样式代码，会包含很多公共代码，如果都包含进来会有问题</p><ul><li>相同的资源被重复的加载，浪费用户的流量和服务器的成本；</li><li>每个页面需要加载的资源太大，导致网页首屏加载缓慢，影响用户体验。 如果能把公共代码抽离成单独文件进行加载能进行优化，可以减少网络传输流量，降低服务器成本</li></ul><h3 id="如何提取"><a href="#如何提取" class="headerlink" title="如何提取"></a>如何提取</h3><ul><li>基础类库，方便长期缓存</li><li>页面之间的公用代码</li><li>各个页面单独生成文件</li><li>webpack版本用的都是<code>commonchunkplugin</code>,webpack4开始使用<a href="https://github.com/webpack/webpack/tree/master/examples/common-chunk-and-vendor-chunk" target="_blank" rel="noopener">common-chunk-and-vendor-chunk</a></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">entry: {</span><br><span class="line">       pageA: <span class="string">'./src/pageA'</span>,</span><br><span class="line">       pageB: <span class="string">'./src/pageB'</span>,</span><br><span class="line">       pageC: <span class="string">'./src/pageC'</span></span><br><span class="line">   },</span><br><span class="line">   output: {</span><br><span class="line">       path: path.resolve(__dirname,<span class="string">'dist'</span>),</span><br><span class="line">       filename: <span class="string">'[name].js'</span></span><br><span class="line">   },</span><br><span class="line">   optimization: {</span><br><span class="line">       splitChunks: {</span><br><span class="line">           cacheGroups: {</span><br><span class="line">               commons: {</span><br><span class="line">                   chunks: <span class="string">"initial"</span>,</span><br><span class="line">                             minChunks: <span class="number">2</span>,<span class="comment">//最小重复的次数</span></span><br><span class="line">                             minSize: <span class="number">0</span><span class="comment">//最小提取字节数</span></span><br><span class="line">               },</span><br><span class="line">               vendor: {</span><br><span class="line">                   test: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                   chunks: <span class="string">"initial"</span>,</span><br><span class="line">                   name: <span class="string">"vendor"</span>,</span><br><span class="line">               }</span><br><span class="line">           }</span><br><span class="line">       }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   plugins:[</span><br><span class="line">      <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">           template: <span class="string">'./src/index.html'</span>,</span><br><span class="line">           filename: <span class="string">'pageA.html'</span>,</span><br><span class="line">           chunks: [<span class="string">'pageA'</span>],</span><br><span class="line">           minify: {</span><br><span class="line">               removeAttributeQuotes: <span class="literal">true</span></span><br><span class="line">           }</span><br><span class="line">       }),</span><br><span class="line">       <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">           template: <span class="string">'./src/index.html'</span>,</span><br><span class="line">           filename: <span class="string">'pageB.html'</span>,</span><br><span class="line">           chunks: [<span class="string">'pageB'</span>],</span><br><span class="line">           minify: {</span><br><span class="line">               removeAttributeQuotes: <span class="literal">true</span></span><br><span class="line">           }</span><br><span class="line">       }),</span><br><span class="line">       <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">           template: <span class="string">'./src/index.html'</span>,</span><br><span class="line">           filename: <span class="string">'pageC.html'</span>,</span><br><span class="line">           chunks: [<span class="string">'pageC'</span>],</span><br><span class="line">           minify: {</span><br><span class="line">               removeAttributeQuotes: <span class="literal">true</span></span><br><span class="line">           }</span><br><span class="line">       })</span><br><span class="line">   ]</span><br></pre></td></tr></tbody></table></figure><h2 id="开启-Scope-Hoisting"><a href="#开启-Scope-Hoisting" class="headerlink" title="开启 Scope Hoisting"></a>开启 Scope Hoisting</h2><p><code>Scope Hoisting</code> 可以让 <code>Webpack</code> 打包出来的代码文件更小、运行的更快， 它又译作 <strong>“作用域提升”</strong>，是在 Webpack3 中新推出的功能。</p><ul><li>代码体积更小，因为函数申明语句会产生大量代码</li><li>代码在运行时因为创建的函数作用域更少了，内存开销也随之变小</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ModuleConcatenationPlugin = <span class="built_in">require</span>(<span class="string">'webpack/lib/optimize/ModuleConcatenationPlugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">  resolve: {</span><br><span class="line">    <span class="comment">// 针对 Npm 中的第三方模块优先采用 jsnext:main 中指向的 ES6 模块化语法的文件</span></span><br><span class="line">    mainFields: [<span class="string">'jsnext:main'</span>, <span class="string">'browser'</span>, <span class="string">'main'</span>]</span><br><span class="line">  },</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 开启 Scope Hoisting</span></span><br><span class="line">    <span class="keyword">new</span> ModuleConcatenationPlugin(),</span><br><span class="line">  ],</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>hello.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="string">'Hello'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>index.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> str <span class="keyword">from</span> <span class="string">'./hello.js'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(str);</span><br></pre></td></tr></tbody></table></figure><p></p><p>输出的结果<code>main.js</code><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = name = <span class="string">"zfpx"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(n)</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">函数由两个变成了一个，`</span>hello.js<span class="string">` 中定义的内容被直接注入到了 `</span>main.js<span class="string">` 中</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 动态导入和懒加载</span></span><br><span class="line"><span class="string">用户当前需要用什么功能就只加载这个功能对应的代码，也就是所谓的按需加载 在给单页应用做按需加载优化时，一般采用以下原则：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- 对网站功能进行划分，每一类一个`</span>chunk<span class="string">`</span></span><br><span class="line"><span class="string">- 对于首次打开页面需要的功能直接加载，尽快展示给用户</span></span><br><span class="line"><span class="string">- 某些依赖大量代码的功能点可以按需加载</span></span><br><span class="line"><span class="string">- 被分割出去的代码需要一个按需加载的时机</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">handler.js</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="built_in">module</span>.exports=<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    alert(<span class="string">'你点我啦!'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>index.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'#clickBtn'</span>).addEventListener(<span class="string">'mouseover'</span>,() =&gt; {</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">'./handler'</span>).then(<span class="function"><span class="params">clickMe</span> =&gt;</span> {</span><br><span class="line">        <span class="built_in">window</span>.clickMe=clickMe.default;</span><br><span class="line">    });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>html<br></p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"clickBtn"</span> <span class="attr">onclick</span>=<span class="string">"clickMe()"</span>&gt;</span>弹框<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="react-router4-路由懒加载"><a href="#react-router4-路由懒加载" class="headerlink" title="react-router4 路由懒加载"></a>react-router4 路由懒加载</h3><p>index.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> {HashRouter <span class="keyword">as</span> Router,Route} <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> Bundle <span class="keyword">from</span> <span class="string">'./Bundle'</span>;</span><br><span class="line"><span class="keyword">let</span> LazyAbout=<span class="function">(<span class="params">props</span>) =&gt;</span> (<span class="xml"><span class="tag">&lt;<span class="name">Bundle</span> {<span class="attr">...props</span>} <span class="attr">load</span>=<span class="string">{()</span>=&gt;</span>import('./About')}/&gt;)</span></span><br><span class="line"><span class="xml">let Home=() =&gt; <span class="tag">&lt;<span class="name">div</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">ReactDOM.render(</span></span><br><span class="line">&lt;Router&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Route path="/" component={Home} /&gt;</span><br><span class="line">      &lt;Route path="/about" component={LazyAbout}/&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/Router&gt;,document.getElementById('root'));</span><br></pre></td></tr></tbody></table></figure><p></p><p>Bundle<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Bundle</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>{</span><br><span class="line">    state={<span class="attr">Mod</span>: <span class="literal">null</span>}</span><br><span class="line">    componentWillMount() {</span><br><span class="line">        <span class="keyword">this</span>.props.load().then(<span class="function"><span class="params">mod</span>=&gt;</span><span class="keyword">this</span>.setState({<span class="attr">Mod</span>: mod.default? mod.default:mod}));</span><br><span class="line">    }</span><br><span class="line">    render() {</span><br><span class="line">        <span class="keyword">let</span> Mod=<span class="keyword">this</span>.state.Mod;</span><br><span class="line">        <span class="keyword">return</span> Mod&amp;&amp;<span class="xml"><span class="tag">&lt;<span class="name">Mod</span>  {<span class="attr">...this.props</span>}/&gt;</span>;</span></span><br><span class="line"><span class="xml">    }</span></span><br><span class="line"><span class="xml">}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>About<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> props =&gt; <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>About<span class="tag">&lt;/<span class="name">div</span></span></span></span><br></pre></td></tr></tbody></table></figure><p></p><hr><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://www.zhufengpeixun.cn/plan/html/26.webpack-2-optimize.html" target="_blank" rel="noopener">webpack demo</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2019/01/08/webpack-1/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/01/08/webpack-1/" itemprop="url">webpack-1</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-08T09:34:56+08:00">2019-01-08 </time></span><span id="/2019/01/08/webpack-1/" class="leancloud_visitors" data-flag-title="webpack-1"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">5,768 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">25</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="什么是webpack"><a href="#什么是webpack" class="headerlink" title="什么是webpack"></a>什么是webpack</h2><p><strong>Webpack</strong>是一个打包模块化 <strong>JavaScript</strong> 的工具，在 <strong>Webpack</strong> 里一切文件皆<strong>模块</strong>，通过 <strong>Loader</strong> 转换文件，通过 <strong>Plugin</strong> 注入钩子，最后输出由多个模块组合成的文件。<strong>Webpack</strong> 专注于构建模块化项目。</p><p>一切文件：<strong>JavaScript</strong>、<strong>CSS</strong>、<strong>SCSS</strong>、<strong>图片</strong>、<strong>模板</strong>，在 <strong>Webpack</strong> 眼中都是一个个模块，这样的好处是能清晰的描述出各个模块之间的<strong>依赖关系</strong>，以方便 <strong>Webpack</strong> 对模块进行组合和打包。 经过 <strong>Webpack</strong> 的处理，最终会输出浏览器能使用的静态资源。</p><p><img src="http://b.zhangyapeng.club/webpack-201919161945.jpeg" alt="webpack-201919161945"></p><h2 id="自动化构建"><a href="#自动化构建" class="headerlink" title="自动化构建"></a>自动化构建</h2><p>构建就是把源代码转换成发布到线上的可执行 <strong>JavaScrip</strong>、<strong>CSS</strong>、<strong>HTML</strong> 代码，包括如下内容。</p><ul><li><strong>代码转换</strong>：TypeScript 编译成 JavaScript、SCSS 编译成 CSS 等。</li><li><strong>文件优化</strong>：压缩 JavaScript、CSS、HTML 代码，压缩合并图片等。</li><li><strong>代码分割</strong>：提取多个页面的公共代码、提取首屏不需要执行部分的代码让其异步加载。</li><li><strong>模块合并</strong>：在采用模块化的项目里会有很多个模块和文件，需要构建功能把模块分类合并成一个文件。</li><li><strong>自动刷新</strong>：监听本地源代码的变化，自动重新构建、刷新浏览器。</li><li><strong>代码校验</strong>：在代码被提交到仓库前需要校验代码是否符合规范，以及单元测试是否通过。</li><li><strong>自动发布</strong>：更新完代码后，自动构建出线上发布代码并传输给发布系统。</li></ul><h2 id="webpack核心概念"><a href="#webpack核心概念" class="headerlink" title="webpack核心概念"></a>webpack核心概念</h2><ul><li><strong>Entry</strong>：入口，Webpack 执行构建的第一步将从 Entry 开始，可抽象成输入。</li><li><strong>Module</strong>：模块，在 Webpack 里一切皆模块，一个模块对应着一个文件。Webpack 会从配置的 Entry 开始递归找出所有依赖的模块。</li><li><strong>Chunk</strong>：代码块，一个 Chunk 由多个模块组合而成，用于代码合并与分割。</li><li><strong>Loader</strong>：模块转换器，用于把模块原内容按照需求转换成新内容。</li><li><strong>Plugin</strong>：扩展插件，在 Webpack 构建流程中的特定时机注入扩展逻辑来改变构建结果或做你想要的事情。</li><li><strong>Output</strong>：输出结果，在 Webpack 经过一系列处理并得出最终想要的代码后输出结果。</li></ul><h2 id="webpack执行流程"><a href="#webpack执行流程" class="headerlink" title="webpack执行流程"></a>webpack执行流程</h2><p><strong>Webpack</strong> 启动后会从<strong>Entry</strong>里配置的 <strong>Module</strong> 开始<strong>递归</strong>解析 <strong>Entry</strong> 依赖的所有 <strong>Module</strong>。 每找到一个 <strong>Module</strong>， 就会根据配置的<strong>Loader</strong>去找出对应的转换规则，对 <strong>Module</strong> 进行转换后，再解析出当前 <strong>Module</strong> 依赖的 <strong>Module</strong>。 这些模块会以 <strong>Entry</strong> 为单位进行分组，一个 <strong>Entry</strong> 和其所有依赖的 <strong>Module</strong> 被分到一个组也就是一个 <strong>Chunk</strong>。最后 <strong>Webpack</strong> 会把所有 <strong>Chunk</strong> 转换成文件输出。 在整个流程中 <strong>Webpack</strong> 会在恰当的时机执行 <strong>Plugin</strong> 里定义的逻辑。</p><h2 id="配置webpack"><a href="#配置webpack" class="headerlink" title="配置webpack"></a>配置webpack</h2><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack webpack-cli -D</span><br></pre></td></tr></tbody></table></figure><h3 id="基本配置文件"><a href="#基本配置文件" class="headerlink" title="基本配置文件"></a>基本配置文件</h3><ul><li>配置文件<code>webpack.config.js</code><ul><li><strong>entry</strong>：配置入口文件的地址</li><li><strong>output</strong>：配置出口文件的地址</li><li><strong>module</strong>：配置模块,主要用来配置不同文件的加载器</li><li><strong>plugins</strong>：配置插件</li><li><strong>devServer</strong>：配置开发服务器</li></ul></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports={</span><br><span class="line">    entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    output: {</span><br><span class="line">        path: path.resolve(__dirname,<span class="string">'dist'</span>), <span class="comment">//绝对路径</span></span><br><span class="line">        filename:<span class="string">'[name].[hash:8].js'</span></span><br><span class="line">    },</span><br><span class="line">    <span class="built_in">module</span>: {},</span><br><span class="line">    plugins: [],</span><br><span class="line">    devServer: {}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="1-配置开发服务器"><a href="#1-配置开发服务器" class="headerlink" title="1. 配置开发服务器"></a>1. 配置开发服务器</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i webpack-dev-server –D</span><br></pre></td></tr></tbody></table></figure><ul><li><strong>contentBase</strong>: 配置开发服务运行时的文件根目录</li><li><strong>host</strong>：开发服务器监听的主机地址</li><li><strong>compress</strong>: 开发服务器是否启动gzip等压缩</li><li><strong>port</strong>：开发服务器监听的端口</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">devServer: {</span><br><span class="line">    contentBase: path.join(__dirname, <span class="string">"dist"</span>), <span class="comment">//静态文件根目录</span></span><br><span class="line">    port: <span class="number">9090</span>, <span class="comment">// 端口</span></span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    overlay: <span class="literal">true</span>,</span><br><span class="line">    compress: <span class="literal">true</span> <span class="comment">// 服务器返回浏览器的时候是否启动gzip压缩</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>配置文件<code>package.json</code></li></ul><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"scripts": {</span><br><span class="line">    "build": "webpack --mode development",</span><br><span class="line">    "dev": "webpack-dev-server --open --mode development "</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="什么是Loader"><a href="#什么是Loader" class="headerlink" title="什么是Loader"></a>什么是Loader</h3><p>通过使用不同的<strong>Loader</strong>，<strong>Webpack</strong>可以要把不同的文件都转成<strong>JS</strong>文件,比如<strong>CSS</strong>、<strong>ES6/7</strong>、<strong>JSX</strong>等</p><ul><li><strong>test</strong>：匹配处理文件的扩展名的正则表达式</li><li><strong>use</strong>：loader名称，就是你要使用模块的名称</li><li><strong>include/exclude</strong>:手动指定必须处理的文件夹或屏蔽不需要处理的文件夹</li><li><strong>query</strong>：为loaders提供额外的设置选项</li></ul><h4 id="loader有3种写法"><a href="#loader有3种写法" class="headerlink" title="loader有3种写法"></a>loader有3种写法</h4><h5 id="1-1-loader"><a href="#1-1-loader" class="headerlink" title="1.1 loader"></a>1.1 loader</h5><p>加载CSS文件，CSS文件有可能在node_modules里，比如bootstrap和antd<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: {</span><br><span class="line">        rules: [</span><br><span class="line">            {</span><br><span class="line">                test: <span class="regexp">/\.css/</span>,</span><br><span class="line">               loader:[<span class="string">'style-loader'</span>,<span class="string">'css-loader'</span>]</span><br><span class="line">            }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="1-2-use"><a href="#1-2-use" class="headerlink" title="1.2 use"></a>1.2 use</h5><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: {</span><br><span class="line">        rules: [</span><br><span class="line">            {</span><br><span class="line">                test: <span class="regexp">/\.css/</span>,</span><br><span class="line">                use:[<span class="string">'style-loader'</span>,<span class="string">'css-loader'</span>]</span><br><span class="line">            }</span><br><span class="line">        ]</span><br><span class="line">    },</span><br></pre></td></tr></tbody></table></figure><h5 id="1-3-useloader"><a href="#1-3-useloader" class="headerlink" title="1.3 useloader"></a>1.3 useloader</h5><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// css-loader用来处理css中url的路径</span></span><br><span class="line"><span class="comment">// style-loader可以把css文件变成style标签插入head中</span></span><br><span class="line"><span class="comment">// 多个loader是有顺序要求的，从右往左写，因为转换的时候是从右往左转换的</span></span><br><span class="line"> <span class="built_in">module</span>: {</span><br><span class="line">        rules: [</span><br><span class="line">            {</span><br><span class="line">                test: <span class="regexp">/\.css/</span>,</span><br><span class="line">                include: path.resolve(__dirname,<span class="string">'src'</span>),<span class="comment">//限制范围，提高打包速度</span></span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use: [{</span><br><span class="line">                    loader: <span class="string">'style-loader'</span>,</span><br><span class="line">                    options: {</span><br><span class="line">                        insertAt:<span class="string">'top'</span> <span class="comment">//插入head的最前面</span></span><br><span class="line">                    }</span><br><span class="line">                },<span class="string">'css-loader'</span>]</span><br><span class="line">            }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h4 id="支持加载css文件"><a href="#支持加载css文件" class="headerlink" title="支持加载css文件"></a>支持加载css文件</h4><ul><li><a href="https://www.npmjs.com/package/css-loader" target="_blank" rel="noopener">css-loader</a></li><li><a href="https://www.npmjs.com/package/style-loader" target="_blank" rel="noopener">style-loader</a></li></ul><h4 id="支持图片"><a href="#支持图片" class="headerlink" title="支持图片"></a>支持图片</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i file-loader url-loader -D</span><br></pre></td></tr></tbody></table></figure><ul><li><a href="http://npmjs.com/package/file-loader" target="_blank" rel="noopener">file-loader</a> 解决CSS等文件中的引入图片路径问题</li><li><a href="https://www.npmjs.com/package/url-loader" target="_blank" rel="noopener">url-loader</a> 当图片小于limit的时候会把图片BASE64编码，大于limit参数的时候还是使用file-loader 进行拷贝</li></ul><h5 id="js中引入图片"><a href="#js中引入图片" class="headerlink" title="js中引入图片"></a>js中引入图片</h5><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> logo=<span class="built_in">require</span>(<span class="string">'./images/logo.png'</span>);</span><br><span class="line"><span class="keyword">let</span> img=<span class="keyword">new</span> Image();</span><br><span class="line">img.src=logo;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(img)</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  test:<span class="regexp">/\.(jpg|png|bmp|gif|svg|ttf|woff|woff2|eot)/</span>,</span><br><span class="line">    use:[</span><br><span class="line">    {</span><br><span class="line">       loader:<span class="string">'url-loader'</span>,</span><br><span class="line">       options:{<span class="attr">limit</span>:<span class="number">4096</span>}</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="在CSS中引入图片"><a href="#在CSS中引入图片" class="headerlink" title="在CSS中引入图片"></a>在CSS中引入图片</h5><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.logo</span>{</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">355px</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">133px</span>;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(./images/logo.png);</span><br><span class="line">    <span class="attribute">background-size</span>: cover;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h5><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"logo"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="分离CSS"><a href="#分离CSS" class="headerlink" title="分离CSS"></a>分离CSS</h4><p>因为CSS的下载和JS可以<strong>并行</strong>,当一个HTML文件很大的时候，我们可以把CSS单独提取出来加载</p><ul><li><a href="https://github.com/webpack-contrib/mini-css-extract-plugin" target="_blank" rel="noopener">mini-css-extract-plugin</a></li><li>filename 打包入口文件</li><li>chunkFilename 用来打包<code>import('module')</code>方法中引入的模块</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev mini-css-extract-plugin</span><br></pre></td></tr></tbody></table></figure><p>配置webpack.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">       <span class="comment">//参数类似于webpackOptions.output</span></span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin({</span><br><span class="line">            filename: <span class="string">'[name].css'</span>,</span><br><span class="line">            chunkFilename:<span class="string">'[id].css'</span></span><br><span class="line">        }),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">                test: <span class="regexp">/\.css/</span>,</span><br><span class="line">                include: path.resolve(__dirname,<span class="string">'src'</span>),</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use: [{</span><br><span class="line">                    loader: MiniCssExtractPlugin.loader</span><br><span class="line">                },<span class="string">'css-loader'</span>]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="压缩JS和CSS"><a href="#压缩JS和CSS" class="headerlink" title="压缩JS和CSS"></a>压缩JS和CSS</h5><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i uglifyjs-webpack-plugin optimize-css-assets-webpack-plugin -D</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UglifyJsPlugin = <span class="built_in">require</span>(<span class="string">"uglifyjs-webpack-plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> OptimizeCSSAssetsPlugin = <span class="built_in">require</span>(<span class="string">"optimize-css-assets-webpack-plugin"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">    mode: <span class="string">'development'</span>,</span><br><span class="line">    optimization: {</span><br><span class="line">        minimizer: [</span><br><span class="line">            <span class="keyword">new</span> UglifyJsPlugin({</span><br><span class="line">                cache: <span class="literal">true</span>,<span class="comment">//启动缓存</span></span><br><span class="line">                parallel: <span class="literal">true</span>,<span class="comment">//启动并行压缩</span></span><br><span class="line">                <span class="comment">//如果为true的话，可以获得sourcemap</span></span><br><span class="line">                sourceMap: <span class="literal">true</span> <span class="comment">// set to true if you want JS source maps</span></span><br><span class="line">            }),</span><br><span class="line">            <span class="comment">//压缩css资源的</span></span><br><span class="line">            <span class="keyword">new</span> OptimizeCSSAssetsPlugin({})</span><br><span class="line">        ]</span><br><span class="line">    },</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="css和image存放单独目录"><a href="#css和image存放单独目录" class="headerlink" title="css和image存放单独目录"></a>css和image存放单独目录</h5><ul><li><strong>outputPath</strong> 输出路径</li><li><strong>publicPath</strong>指定的是构建后在html里的路径</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">output: {</span><br><span class="line">        path: path.resolve(__dirname,<span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'bundle.js'</span>,</span><br><span class="line">        publicPath:<span class="string">'/'</span></span><br><span class="line">    },</span><br><span class="line">{</span><br><span class="line">  test:<span class="regexp">/\.(jpg|jpeg|png|bmp|gif|svg|ttf|woff|woff2|eot)/</span>,</span><br><span class="line">  use:[</span><br><span class="line">        {</span><br><span class="line">          loader:<span class="string">'url-loader'</span>,</span><br><span class="line">          options:{</span><br><span class="line">              limit: <span class="number">4096</span>,</span><br><span class="line">              outputPath: <span class="string">'images'</span>,</span><br><span class="line">              publicPath:<span class="string">'/images'</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">     ]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">plugins: [</span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin({</span><br><span class="line">           filename: <span class="string">'css/[name].css'</span>,</span><br><span class="line">            chunkFilename:<span class="string">'css/[id].css'</span></span><br><span class="line">        }),</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure><h5 id="在HTML中使用图片"><a href="#在HTML中使用图片" class="headerlink" title="在HTML中使用图片"></a>在HTML中使用图片</h5><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i html-withimg-loader -D</span><br></pre></td></tr></tbody></table></figure><p>index.html<br></p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"./images/logo.png"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    test: <span class="regexp">/\.(html|htm)$/</span>,</span><br><span class="line">    use: <span class="string">'html-withimg-loader'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="编译less-和-sass"><a href="#编译less-和-sass" class="headerlink" title="编译less 和 sass"></a>编译less 和 sass</h4><p>安装less和sass<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i less less-loader -D</span><br><span class="line">npm i node-sass sass-loader -D</span><br></pre></td></tr></tbody></table></figure><p></p><h5 id="编写样式"><a href="#编写样式" class="headerlink" title="编写样式"></a>编写样式</h5><p><strong>less</strong><br></p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@color:</span>orange;</span><br><span class="line"><span class="selector-class">.less-container</span>{</span><br><span class="line">    <span class="attribute">color</span>:<span class="variable">@color</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>sass</strong><br></p><figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$color</span>:green;</span><br><span class="line"><span class="selector-class">.sass-container</span>{</span><br><span class="line">    <span class="attribute">color</span>:green;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>webpack.config.js</strong><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">        test: <span class="regexp">/\.less/</span>,</span><br><span class="line">        include: path.resolve(__dirname,<span class="string">'src'</span>),</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        use: [{</span><br><span class="line">            loader: MiniCssExtractPlugin.loader,</span><br><span class="line">        },<span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">        test: <span class="regexp">/\.scss/</span>,</span><br><span class="line">        include: path.resolve(__dirname,<span class="string">'src'</span>),</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        use: [{</span><br><span class="line">            loader: MiniCssExtractPlugin.loader,</span><br><span class="line">        },<span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]</span><br><span class="line">    },</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="处理CSS3属性前缀"><a href="#处理CSS3属性前缀" class="headerlink" title="处理CSS3属性前缀"></a>处理CSS3属性前缀</h4><p>为了浏览器的兼容性，有时候我们必须加入<code>-webkit</code>,<code>-ms</code>,<code>-o</code>,<code>-moz</code>这些前缀</p><ul><li><strong>Trident</strong>内核：主要代表为IE浏览器, 前缀为<code>-ms</code></li><li><strong>Gecko</strong>内核：主要代表为Firefox, 前缀为<code>-moz</code></li><li><strong>Presto</strong>内核：主要代表为Opera, 前缀为<code>-o</code></li><li><strong>Webkit</strong>内核：产要代表为Chrome和Safari, 前缀为<code>-webkit</code></li></ul><p>安装<a href="https://github.com/postcss/postcss-loader" target="_blank" rel="noopener">postcss-loader</a><br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i postcss-loader autoprefixer -D</span><br></pre></td></tr></tbody></table></figure><p></p><p>postcss.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">  <span class="string">"plugins"</span>: {</span><br><span class="line">    <span class="comment">// to edit target browsers: use "browserslist" field in package.json</span></span><br><span class="line">    <span class="string">"autoprefixer"</span>: {</span><br><span class="line">      <span class="string">"browsers"</span>: [</span><br><span class="line">        <span class="string">"ie &gt;= 9"</span>,</span><br><span class="line">        <span class="string">"ff &gt;= 30"</span>,</span><br><span class="line">        <span class="string">"chrome &gt;= 34"</span>,</span><br><span class="line">        <span class="string">"safari &gt;= 7"</span>,</span><br><span class="line">        <span class="string">"opera &gt;= 23"</span></span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">   test:<span class="regexp">/\.css$/</span>,</span><br><span class="line">   use:[MiniCssExtractPlugin.loader,<span class="string">'css-loader'</span>,<span class="string">'postcss-loader'</span>],</span><br><span class="line">   include:path.join(__dirname,<span class="string">'./src'</span>),</span><br><span class="line">   exclude:<span class="regexp">/node_modules/</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="转义ES6-ES7-JSX"><a href="#转义ES6-ES7-JSX" class="headerlink" title="转义ES6/ES7/JSX"></a>转义ES6/ES7/JSX</h4><ul><li>Babel其实是一个编译JavaScript的平台,可以把ES6/ES7,React的JSX转义为ES5</li><li><a href="https://babeljs.io/docs/en/babel-plugin-proposal-decorators" target="_blank" rel="noopener">babel-plugin-proposal-decorators</a></li></ul><p>安装依赖包<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i babel-loader @babel/core @babel/preset-env  @babel/preset-react  -D</span><br><span class="line">npm i @babel/plugin-proposal-decorators @babel/plugin-proposal-class-properties -D</span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    test: <span class="regexp">/\.jsx?$/</span>,</span><br><span class="line">    use: {</span><br><span class="line">        loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">        options:{</span><br><span class="line">         <span class="string">"plugins"</span>: [</span><br><span class="line">            [<span class="string">"@babel/plugin-proposal-decorators"</span>, { <span class="string">"legacy"</span>: <span class="literal">true</span> }],</span><br><span class="line">            [<span class="string">"@babel/plugin-proposal-class-properties"</span>, { <span class="string">"loose"</span> : <span class="literal">true</span> }]</span><br><span class="line">         ]</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">    include: path.join(__dirname,<span class="string">'src'</span>),</span><br><span class="line">    exclude:<span class="regexp">/node_modules/</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="babel-runtime"><a href="#babel-runtime" class="headerlink" title="babel runtime"></a>babel runtime</h4><ul><li>babel 在每个文件都插入了辅助代码，使代码体积过大</li><li>babel 对一些公共方法使用了非常小的辅助代码，比如 <code>_extend</code></li><li>默认情况下会被添加到每一个需要它的文件中。你可以引入 <code>@babel/runtime</code> 作为一个独立模块，来避免重复引入</li><li><a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime" target="_blank" rel="noopener">babel-plugin-transform-runtime</a></li></ul><p>安装依赖包<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @babel/plugin-transform-runtime</span><br><span class="line">npm install --save @babel/runtime</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>.babelrc</strong><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="string">"presets"</span>: [<span class="string">"@babel/preset-env"</span>],</span><br><span class="line">  <span class="string">"plugins"</span>: [</span><br><span class="line">   [</span><br><span class="line">         <span class="string">"@babel/plugin-transform-runtime"</span>,</span><br><span class="line">         {</span><br><span class="line">            <span class="string">"corejs"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"helpers"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">"regenerator"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">"useESModules"</span>: <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack打包的时候，会自动优化重复引入公共方法的问题</p><h4 id="ESLint校验代码格式规范"><a href="#ESLint校验代码格式规范" class="headerlink" title="ESLint校验代码格式规范"></a>ESLint校验代码格式规范</h4><ul><li><a href="https://eslint.org/docs/developer-guide/nodejs-api#cliengine" target="_blank" rel="noopener">eslint</a></li><li><a href="https://www.npmjs.com/package/eslint-loader" target="_blank" rel="noopener">eslint-loader</a></li><li><a href="https://eslint.org/docs/user-guide/configuring" target="_blank" rel="noopener">configuring</a></li><li><a href="https://www.npmjs.com/package/babel-eslint" target="_blank" rel="noopener">babel-eslint</a></li><li><a href="https://cloud.tencent.com/developer/chapter/12618" target="_blank" rel="noopener">Rules</a></li><li><a href="https://segmentfault.com/a/1190000008742240" target="_blank" rel="noopener">ESlint 语法检测配置说明</a></li></ul><p>安装依赖包<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install eslint eslint-loader babel-eslint --D</span><br></pre></td></tr></tbody></table></figure><p></p><p>.eslintrc.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">    root: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">//指定解析器选项</span></span><br><span class="line">    parserOptions: {</span><br><span class="line">        sourceType: <span class="string">'module'</span></span><br><span class="line">    },</span><br><span class="line">    <span class="comment">//指定脚本的运行环境</span></span><br><span class="line">    env: {</span><br><span class="line">        browser: <span class="literal">true</span>,</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 启用的规则及其各自的错误级别</span></span><br><span class="line">    rules: {</span><br><span class="line">        <span class="string">"indent"</span>: [<span class="string">"error"</span>, <span class="number">4</span>],<span class="comment">//缩进风格</span></span><br><span class="line">        <span class="string">"quotes"</span>: [<span class="string">"error"</span>, <span class="string">"double"</span>],<span class="comment">//引号类型 </span></span><br><span class="line">        <span class="string">"semi"</span>: [<span class="string">"error"</span>, <span class="string">"always"</span>],<span class="comment">//关闭语句强制分号结尾</span></span><br><span class="line">        <span class="string">"no-console"</span>: <span class="string">"error"</span>,<span class="comment">//禁止使用console</span></span><br><span class="line">        <span class="string">"arrow-parens"</span>: <span class="number">0</span> <span class="comment">//箭头函数用小括号括起来</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>webpack.config.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: {</span><br><span class="line">        <span class="comment">//配置加载规则</span></span><br><span class="line">        rules: [</span><br><span class="line">            {</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                loader: <span class="string">'eslint-loader'</span>,</span><br><span class="line">                enforce: <span class="string">"pre"</span>, <span class="comment">//在所有loader执行之前执行</span></span><br><span class="line">                include: [path.resolve(__dirname, <span class="string">'src'</span>)], <span class="comment">// 指定检查的目录</span></span><br><span class="line">                options: { <span class="attr">fix</span>: <span class="literal">true</span> } <span class="comment">// 这里的配置项参数将会被传递到 eslint 的 CLIEngine   </span></span><br><span class="line">            },</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="对图片进行压缩和优化"><a href="#对图片进行压缩和优化" class="headerlink" title="对图片进行压缩和优化"></a>对图片进行压缩和优化</h4><p><a href="https://www.npmjs.com/package/image-webpack-loader" target="_blank" rel="noopener">image-webpack-loader</a>可以帮助我们对图片进行压缩和优化<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install image-webpack-loader --save-dev</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">          test: <span class="regexp">/\.(png|svg|jpg|gif|jpeg|ico)$/</span>,</span><br><span class="line">          use: [</span><br><span class="line">            <span class="string">'file-loader'</span>,</span><br><span class="line">           {</span><br><span class="line">             loader: <span class="string">'image-webpack-loader'</span>,</span><br><span class="line">             options: {</span><br><span class="line">               mozjpeg: {</span><br><span class="line">                 progressive: <span class="literal">true</span>,</span><br><span class="line">                 quality: <span class="number">65</span></span><br><span class="line">               },</span><br><span class="line">               optipng: {</span><br><span class="line">                 enabled: <span class="literal">false</span>,</span><br><span class="line">               },</span><br><span class="line">               pngquant: {</span><br><span class="line">                 quality: <span class="string">'65-90'</span>,</span><br><span class="line">                 speed: <span class="number">4</span></span><br><span class="line">               },</span><br><span class="line">               gifsicle: {</span><br><span class="line">                 interlaced: <span class="literal">false</span>,</span><br><span class="line">               },</span><br><span class="line">               webp: {</span><br><span class="line">                 quality: <span class="number">75</span></span><br><span class="line">               }</span><br><span class="line">             }</span><br><span class="line">           },</span><br><span class="line">          ]</span><br><span class="line">        }</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><ul><li>在 <strong>webpack</strong> 的构建流程中，<strong>plugin</strong> 用于处理更多其他的一些构建任务</li><li>模块代码转换的工作由 <strong>loader</strong> 来处理</li><li>除此之外的其他任何工作都可以交由 <strong>plugin</strong> 来完成</li></ul><h4 id="自动产出html"><a href="#自动产出html" class="headerlink" title="自动产出html"></a>自动产出html</h4><p>我们希望自动能产出<strong>HTML</strong>文件，并在里面引入产出后的资源<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i html-webpack-plugin -D</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li><strong>minify</strong>:是对html文件进行压缩，</li><li><strong>removeAttrubuteQuotes</strong>:是去掉属性的双引号</li><li><strong>hash</strong>:引入产出资源的时候加上查询参数，值为哈希避免缓存</li><li><strong>template</strong>:模版路径</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">         minify: {</span><br><span class="line">            removeAttributeQuotes:<span class="literal">true</span></span><br><span class="line">        },</span><br><span class="line">        hash: <span class="literal">true</span>,</span><br><span class="line">        template: <span class="string">'./src/index.html'</span>,</span><br><span class="line">        filename:<span class="string">'index.html'</span></span><br><span class="line">    })]</span><br></pre></td></tr></tbody></table></figure><h4 id="添加商标"><a href="#添加商标" class="headerlink" title="添加商标"></a>添加商标</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.BannerPlugin(<span class="string">'珠峰培训'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="拷贝静态文件"><a href="#拷贝静态文件" class="headerlink" title="拷贝静态文件"></a>拷贝静态文件</h4><p>有时项目中没有引用的文件也需要打包到目标目录<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i copy-webpack-plugin -D</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CopyWebpackPlugin([{</span><br><span class="line">  <span class="keyword">from</span>: path.resolve(__dirname,<span class="string">'src/assets'</span>),<span class="comment">//静态资源目录源地址</span></span><br><span class="line">  to:path.resolve(__dirname,<span class="string">'dist/assets'</span>) <span class="comment">//目标地址，相对于output的path目录</span></span><br><span class="line">}])</span><br></pre></td></tr></tbody></table></figure><h4 id="打包前先清空输出目录"><a href="#打包前先清空输出目录" class="headerlink" title="打包前先清空输出目录"></a>打包前先清空输出目录</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i  clean-webpack-plugin -D</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CleanWebpackPlugin([path.resolve(__dirname,<span class="string">'dist'</span>)])</span><br></pre></td></tr></tbody></table></figure><h4 id="DefinePlugin"><a href="#DefinePlugin" class="headerlink" title="DefinePlugin"></a>DefinePlugin</h4><p><strong>DefinePlugin</strong>创建一些在编译时可以配置的全局常量<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.DefinePlugin({</span><br><span class="line">    PRODUCTION: <span class="built_in">JSON</span>.stringify(<span class="literal">true</span>),</span><br><span class="line">    VERSION: <span class="string">"1"</span>,</span><br><span class="line">    EXPRESSION: <span class="string">"12"</span>,</span><br><span class="line">    COPYRIGHT: {</span><br><span class="line">        AUTHOR: <span class="built_in">JSON</span>.stringify(<span class="string">"珠峰培训"</span>)</span><br><span class="line">    }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(PRODUCTION);</span><br><span class="line"><span class="built_in">console</span>.log(VERSION);</span><br><span class="line"><span class="built_in">console</span>.log(EXPRESSION);</span><br><span class="line"><span class="built_in">console</span>.log(COPYRIGHT);</span><br></pre></td></tr></tbody></table></figure><ul><li>如果配置的值是<strong>字符串</strong>，那么整个字符串会被当成<strong>代码片段</strong>来执行，其结果作为最终变量的值，,类似<code>eval</code>执行的其值</li><li>如果配置的值<strong>不是字符串</strong>，也不是一个<strong>对象字面量</strong>，那么该值会被转为一个字符串，如 <strong>true</strong>，最后的结果是 <strong>‘true’</strong></li><li>如果配置的是一个<strong>对象字面量</strong>，那么该对象的所有 <strong>key</strong> 会以同样的方式去定义</li><li><strong>JSON.stringify(true)</strong> 的结果是 <strong>‘true’</strong></li></ul><h4 id="IgnorePlugin"><a href="#IgnorePlugin" class="headerlink" title="IgnorePlugin"></a>IgnorePlugin</h4><p><strong>IgnorePlugin</strong>用于忽略某些特定的模块，让 <strong>webpack</strong> 不把这些指定的模块打包进去<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span>  <span class="string">'moment'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(moment);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.IgnorePlugin(<span class="regexp">/^\.\/locale/</span>,/moment$/)</span><br></pre></td></tr></tbody></table></figure><ul><li>第一个是匹配引入<strong>模块路径</strong>的正则表达式</li><li>第二个是匹配模块的对应上下文，即所在<strong>目录名</strong></li></ul><hr><h3 id="如何调试打包后的代码"><a href="#如何调试打包后的代码" class="headerlink" title="如何调试打包后的代码"></a>如何调试打包后的代码</h3><p><strong>webpack</strong>通过配置可以自动给我们<strong>source maps</strong>文件,<strong>map</strong>文件是一种对应编译文件和源文件的方法</p><ul><li><strong>source-map</strong>: 在单独文件中生成，可以映射到列</li><li><strong>cheap-module-source-map</strong>: 在单独文件中生成，可以映射到列</li><li><strong>eval-source-map</strong>: 在同一个文件内生成source map，可以映射到列</li><li><strong>cheap-module-eval-source-map</strong>: 在同一个文件内生成source map，不可以映射到列</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devtool:<span class="string">'eval-source-map'</span></span><br></pre></td></tr></tbody></table></figure><h3 id="打包第三方类库"><a href="#打包第三方类库" class="headerlink" title="打包第三方类库"></a>打包第三方类库</h3><h4 id="直接引入"><a href="#直接引入" class="headerlink" title="直接引入"></a>直接引入</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line">alert(_.join([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>],<span class="string">'@'</span>));</span><br></pre></td></tr></tbody></table></figure><h4 id="插件引入"><a href="#插件引入" class="headerlink" title="插件引入"></a>插件引入</h4><ul><li>类似在每个模块下引用<code>import _ from 'lodash</code></li><li>函数会自动添加到当前模块的<code>上下文</code>，无需显示声明</li><li>执行上下文，这是一个局部变量</li><li>如果你有一个第三方的插件，依赖全局对象下的属性</li><li><code>jqueryui</code> 他会依赖<code>window.jquery</code>,所以不行<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.ProvidePlugin({</span><br><span class="line">    _:<span class="string">'lodash'</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="expose-loader"><a href="#expose-loader" class="headerlink" title="expose-loader"></a>expose-loader</h4><p>不需要任何其他的插件配合，只要将下面的代码添加到所有的loader之前<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"expose-loader?libraryName!./file.js"</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{ </span><br><span class="line">    test: <span class="built_in">require</span>.resolve(<span class="string">"jquery"</span>), </span><br><span class="line">    loader: <span class="string">"expose-loader?jQuery"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"expose-loader?$!jquery"</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id="externals"><a href="#externals" class="headerlink" title="externals"></a>externals</h4><p>如果我们想引用一个库，但是又不想<strong>让webpack打包</strong>，并且又不影响我们在程序中以<strong>CMD</strong>、<strong>AMD</strong>或者<strong>window/global</strong>全局等方式进行使用，那就可以通过配置<strong>externals</strong></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jQuery = <span class="built_in">require</span>(<span class="string">"jquery"</span>);</span><br><span class="line"><span class="keyword">import</span> jQuery <span class="keyword">from</span> <span class="string">'jquery'</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">externals: {</span><br><span class="line">   <span class="comment">//  key 模块名 ,value就是真正运行时从window的那个属性上取值</span></span><br><span class="line">   jquery: <span class="string">'jQuery'</span><span class="comment">//如果要在浏览器中运行，那么不用添加什么前缀，默认设置就是global</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="cross-env"><a href="#cross-env" class="headerlink" title="cross-env"></a>cross-env</h3><p><strong>process.env</strong>属性返回一个包含<strong>用户环境信息</strong>的对象</p><h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h4><h5 id="Windows配置"><a href="#Windows配置" class="headerlink" title="Windows配置"></a>Windows配置</h5><ul><li><p>临时配置(命令行)</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node中常用的到的环境变量是NODE_ENV，首先查看是否存在 </span></span><br><span class="line"><span class="built_in">set</span> NODE_ENV </span><br><span class="line"><span class="comment">#如果不存在则添加环境变量 </span></span><br><span class="line"><span class="built_in">set</span> NODE_ENV=production </span><br><span class="line"><span class="comment">#环境变量追加值 set 变量名=%变量名%;变量内容 </span></span><br><span class="line"><span class="built_in">set</span> path=%path%;C:\web;C:\Tools </span><br><span class="line"><span class="comment">#某些时候需要删除环境变量 </span></span><br><span class="line"><span class="built_in">set</span> NODE_ENV=</span><br></pre></td></tr></tbody></table></figure></li><li><p>永久配置</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">右键(此电脑) -&gt; 属性(R) -&gt; 高级系统设置 -&gt; 环境变量(N)...</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="Linux配置"><a href="#Linux配置" class="headerlink" title="Linux配置"></a>Linux配置</h4><ul><li><p>临时(命令行)</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node中常用的到的环境变量是NODE_ENV，首先查看是否存在</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$NODE_ENV</span></span><br><span class="line"><span class="comment">#如果不存在则添加环境变量</span></span><br><span class="line"><span class="built_in">export</span> NODE_ENV=production</span><br><span class="line"><span class="comment">#环境变量追加值</span></span><br><span class="line"><span class="built_in">export</span> path=<span class="variable">$path</span>:/home/download:/usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="comment">#某些时候需要删除环境变量</span></span><br><span class="line"><span class="built_in">unset</span> NODE_ENV</span><br><span class="line"><span class="comment">#某些时候需要显示所有的环境变量</span></span><br><span class="line">env</span><br></pre></td></tr></tbody></table></figure></li><li><p>永久(配置文件)</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有用户都生效</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="comment"># 当前用户生效</span></span><br><span class="line">vim ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在文件末尾添加如下格式的环境变量</span></span><br><span class="line"><span class="built_in">export</span> path=<span class="variable">$path</span>:/home/download:/usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="built_in">export</span> NODE_ENV = product</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改/etc/profile文件后</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment"># 修改~/.bash_profile文件后</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure></li></ul><p>因为windows不支持<strong>NODE_ENV=development</strong>的设置方式。</p><p>可以通过<strong>cross-env</strong>实现<br></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cross-env NODE_ENV=development webpack --mode=development</span><br></pre></td></tr></tbody></table></figure><p></p><hr><h3 id="服务器代理"><a href="#服务器代理" class="headerlink" title="服务器代理"></a>服务器代理</h3><p>如果你有单独的后端开发服务器 <strong>API</strong>，并且希望在同域名下发送 <strong>API</strong> 请求 ，那么代理某些 <strong>URL</strong> 会很有用。</p><h4 id="不修改路径"><a href="#不修改路径" class="headerlink" title="不修改路径"></a>不修改路径</h4><p>请求到 <strong>/api/users</strong> 现在会被代理到请求 <strong><a href="http://localhost:3000/api/users" target="_blank" rel="noopener">http://localhost:3000/api/users</a></strong>。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api开头的接口代理到3000端口</span></span><br><span class="line">proxy: {</span><br><span class="line">  <span class="string">"/api"</span>: <span class="string">'http://localhost:3000'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="修改路径"><a href="#修改路径" class="headerlink" title="修改路径"></a>修改路径</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api开头的接口代理到3000端口</span></span><br><span class="line"><span class="comment">// api/users===&gt;users</span></span><br><span class="line">proxy: {</span><br><span class="line">    <span class="string">"/api"</span>: {</span><br><span class="line">       target: <span class="string">'http://localhost:3000'</span>,</span><br><span class="line">       pathRewrite:{<span class="string">"^/api"</span>:<span class="string">""</span>}        </span><br><span class="line">    }            </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="before-after"><a href="#before-after" class="headerlink" title="before after"></a>before after</h4><p><strong>before</strong> 在 <strong>webpack-dev-server</strong> 静态资源中间件处理之前，可以用于拦截部分请求返回特定内容，或者实现简单的数据 <strong>mock</strong><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">before(app){</span><br><span class="line">  app.get(<span class="string">'/api/users'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>{ </span><br><span class="line">    res.json([{<span class="attr">id</span>:<span class="number">1</span>,<span class="attr">name</span>:<span class="string">'zfpx1'</span>}])</span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="webpack-dev-middleware"><a href="#webpack-dev-middleware" class="headerlink" title="webpack-dev-middleware"></a>webpack-dev-middleware</h4><p><a href="https://www.npmjs.com/package/" target="_blank" rel="noopener">webpack-dev-middleware</a>就是在 <strong>Express</strong> 中提供 <strong>webpack-dev-server</strong> 静态服务能力的一个中间件</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack-dev-middleware --save-dev</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> webpackDevMiddleware = <span class="built_in">require</span>(<span class="string">'webpack-dev-middleware'</span>);</span><br><span class="line"><span class="keyword">const</span> webpackOptions = <span class="built_in">require</span>(<span class="string">'./webpack.config'</span>);</span><br><span class="line">webpackOptions.mode = <span class="string">'development'</span>;</span><br><span class="line"><span class="keyword">const</span> compiler = webpack(webpackOptions);</span><br><span class="line">app.use(webpackDevMiddleware(compiler, {}));</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></tbody></table></figure><ul><li><strong>webpack-dev-server</strong> 的好处是相对简单，直接安装依赖后执行命令即可</li><li>而使用<strong>webpack-dev-middleware</strong>的好处是可以在既有的<strong>Express</strong> 代码基础上快速添加<strong>webpack-dev-server</strong> 的功能，同时利用 <strong>Express</strong> 来根据需要添加更多的功能，如 <strong>mock</strong> 服务、代理 <strong>API</strong> 请求等</li></ul><h3 id="resolve解析"><a href="#resolve解析" class="headerlink" title="resolve解析"></a>resolve解析</h3><h4 id="extensions"><a href="#extensions" class="headerlink" title="extensions"></a>extensions</h4><p>指定<strong>extension</strong>之后可以不用在<strong>require</strong>或是<strong>import</strong>的时候加<strong>文件扩展名</strong>,会依次尝试添加扩展名进行匹配<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolve: {</span><br><span class="line">  extensions: [<span class="string">".js"</span>,<span class="string">".jsx"</span>,<span class="string">".json"</span>,<span class="string">".css"</span>]</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h4><ul><li><strong>配置别名</strong>可以加快webpack查找模块的速度</li><li>每当引入<strong>bootstrap</strong>模块的时候，它会直接引入<strong>bootstrap</strong>,而不需要从<strong>node_modules</strong>文件夹中按模块的查找规则查找</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bootstrap = path.resolve(__dirname,<span class="string">'node_modules/_bootstrap@3.3.7@bootstrap/dist/css/bootstrap.css'</span>);</span><br><span class="line">resolve: {</span><br><span class="line">    alias:{</span><br><span class="line">       <span class="string">"bootstrap"</span>:bootstrap</span><br><span class="line">    }</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><h4 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h4><ul><li>对于直接声明依赖名的模块（如 <strong>react</strong> ），<strong>webpack</strong> 会类似 <strong>Node.js</strong> 一样进行路径搜索，搜索<strong>node_modules</strong>目录</li><li>这个目录就是使用<strong>resolve.modules</strong>字段进行配置的 默认配置</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolve: {</span><br><span class="line">modules: [<span class="string">'node_modules'</span>],</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如果可以确定项目内所有的第三方依赖模块都是在项目根目录下的 <strong>node_modules</strong> 中的话<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolve: {</span><br><span class="line">modules: [path.resolve(__dirname, <span class="string">'node_modules'</span>)],</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="mainFields"><a href="#mainFields" class="headerlink" title="mainFields"></a>mainFields</h4><p>默认情况下<strong>package.json</strong> 文件则按照文件中 <strong>main</strong> 字段的文件名来查找文件<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">resolve: {</span><br><span class="line">  <span class="comment">// 配置 target === "web" 或者 target === "webworker" 时 mainFields 默认值是：</span></span><br><span class="line">  mainFields: [<span class="string">'browser'</span>, <span class="string">'module'</span>, <span class="string">'main'</span>],</span><br><span class="line">  <span class="comment">// target 的值为其他时，mainFields 默认值为：</span></span><br><span class="line">  mainFields: [<span class="string">"module"</span>, <span class="string">"main"</span>],</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="mainFiles"><a href="#mainFiles" class="headerlink" title="mainFiles"></a>mainFiles</h4><p>当目录下没有 <strong>package.json</strong> 文件时，我们说会默认使用目录下的 <strong>index.js</strong> 这个文件，其实这个也是可以配置的<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolve: {</span><br><span class="line">  mainFiles: [<span class="string">'index'</span>], <span class="comment">// 你可以添加其他默认使用的文件名</span></span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="resolveLoader"><a href="#resolveLoader" class="headerlink" title="resolveLoader"></a>resolveLoader</h4><p><strong>resolve.resolveLoader</strong>用于配置解析 <strong>loader</strong> 时的 <strong>resolve</strong> 配置,默认的配置：<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">  resolveLoader: {</span><br><span class="line">    modules: [ <span class="string">'node_modules'</span> ],</span><br><span class="line">    extensions: [ <span class="string">'.js'</span>, <span class="string">'.json'</span> ],</span><br><span class="line">    mainFields: [ <span class="string">'loader'</span>, <span class="string">'main'</span> ]</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><hr><h3 id="noParse"><a href="#noParse" class="headerlink" title="noParse"></a>noParse</h3><ul><li><strong>module.noParse</strong> 字段，可以用于配置哪些模块文件的内容不需要被<strong>loaders</strong>解析</li><li>不需要解析依赖（即无依赖） 的第三方大型类库等，可以通过这个字段来配置，以提高整体的构建速度</li><li>使用 <strong>noParse</strong> 进行忽略的<strong>模块文件中</strong>不能使用 <strong>import</strong>、<strong>require</strong>、<strong>define</strong> 等导入机制,因为这些模块加载<strong>并不会被解析</strong>，所以就会报错</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">module</span>: {</span><br><span class="line">  noParse: <span class="regexp">/jquery|lodash/</span>, <span class="comment">// 正则表达式</span></span><br><span class="line">  <span class="comment">// 或者使用函数</span></span><br><span class="line">  noParse(content) {</span><br><span class="line">    <span class="keyword">return</span> <span class="regexp">/jquery|lodash/</span>.test(content)</span><br><span class="line">  },</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><p>当代码发生修改后可以自动<strong>重新编译</strong></p><ul><li>webpack定时获取文件的更新时间，并跟上次保存的时间进行比对，不一致就表示发生了变化,<strong>poll</strong>就用来配置每秒问多少次</li><li>当检测文件不再发生变化，会先缓存起来，等待一段时间后之后再通知监听者，这个等待时间通过<strong>aggregateTimeout</strong>配置</li><li><strong>webpack</strong>只会监听<strong>entry</strong>依赖的文件</li><li>我们需要尽可能减少需要监听的文件数量和检查频率，当然频率的降低会导致灵敏度下降<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">watch: <span class="literal">true</span>,</span><br><span class="line">watchOptions: {</span><br><span class="line">    ignored: <span class="regexp">/node_modules/</span>, <span class="comment">//忽略不用监听变更的目录</span></span><br><span class="line">    poll:<span class="number">1000</span>, <span class="comment">//每秒询问的文件变更的次数</span></span><br><span class="line">    aggregateTimeout: <span class="number">500</span>, <span class="comment">//防止重复保存频繁重新编译,500毫秒内重复保存不打包</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li></ul><hr><h3 id="区分环境变量"><a href="#区分环境变量" class="headerlink" title="区分环境变量"></a>区分环境变量</h3><ul><li>日常的前端开发工作中，一般都会有<strong>两套</strong>构建环境</li><li>一套开发时使用，构建结果用于本地开发调试，不进行<strong>代码压缩</strong>，打印 <strong>debug</strong> 信息，包含 <strong>sourcemap</strong> 文件</li><li>一套构建后的结果是直接应用于线上的，即代码都是压缩后，运行时不打印 <strong>debug</strong> 信息，静态文件不包括 <strong>sourcemap</strong></li><li>webpack 4.x 版本引入了 <strong>mode</strong> 的概念</li><li>当你指定使用 <strong>production mode</strong> 时，默认会启用各种性能优化的功能，包括<strong>构建结果优化</strong>以及 <strong>webpack 运行性能优化</strong></li><li>而如果是 <strong>development mode</strong> 的话，则会开启 <strong>debug</strong> 工具，运行时打印详细的错误信息，以及更加快速的增量编译构建</li></ul><h4 id="环境差异"><a href="#环境差异" class="headerlink" title="环境差异"></a>环境差异</h4><ul><li>生产环境<ul><li>可能需要分离 <strong>CSS</strong> 成单独的文件，以便多个页面共享同一个 <strong>CSS</strong> 文件</li><li>需要压缩<strong>HTML/CSS/JS</strong> 代码</li><li>需要<strong>压缩图片</strong></li></ul></li><li>开发环境<ul><li>需要生成 <strong>sourcemap</strong> 文件</li><li>需要打印 <strong>debug</strong> 信息</li><li>需要 <strong>live reload</strong> 或者 <strong>hot reload</strong> 的功能…</li></ul></li></ul><h4 id="获取mode参数"><a href="#获取mode参数" class="headerlink" title="获取mode参数"></a>获取mode参数</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev optimize-css-assets-webpack-plugin</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UglifyJSPlugin = <span class="built_in">require</span>(<span class="string">'webpack/lib/optimize/UglifyJsPlugin'</span>);</span><br><span class="line"><span class="keyword">const</span> OptimizeCssAssetsPlugin = <span class="built_in">require</span>(<span class="string">'optimize-css-assets-webpack-plugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports=<span class="function">(<span class="params">env,argv</span>) =&gt;</span> ({</span><br><span class="line">    optimization: {</span><br><span class="line">        minimizer: argv.mode == <span class="string">'production'</span>?[            </span><br><span class="line">            <span class="keyword">new</span> UglifyJSplugin({</span><br><span class="line">                  cache: <span class="literal">true</span>,<span class="comment">//启用缓存</span></span><br><span class="line">                  parallel: <span class="literal">true</span>,<span class="comment">// 使用多进程运行改进编译速度</span></span><br><span class="line">                  sourceMap:<span class="literal">true</span><span class="comment">//生成sourceMap映射文件</span></span><br><span class="line">            }),</span><br><span class="line">            <span class="keyword">new</span> OptimizeCssAssetsWebpackPlugin({})</span><br><span class="line">        ]:[]</span><br><span class="line">    }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h4 id="封装log方法"><a href="#封装log方法" class="headerlink" title="封装log方法"></a>封装log方法</h4><p><strong>webpack</strong>时传递的 <strong>mode</strong> 参数，是可以在我们的应用代码运行时，通过 <strong>process.env.NODE_ENV</strong> 这个变量获取<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">...args</span>) </span>{</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV == <span class="string">'development'</span>) {</span><br><span class="line">        <span class="built_in">console</span>.log.apply(<span class="built_in">console</span>,args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="拆分配置"><a href="#拆分配置" class="headerlink" title="拆分配置"></a>拆分配置</h4><p>可以把 <strong>webpack</strong> 的配置按照不同的环境拆分成多个文件，运行时直接根据环境变量加载对应的配置即可</p><ul><li>webpack.base.js：基础部分，即多个文件中共享的配置</li><li>webpack.development.js：开发环境使用的配置</li><li>webpack.production.js：生产环境使用的配置</li><li>webpack.test.js：测试环境使用的配置…</li><li><a href="https://github.com/survivejs/webpack-merge" target="_blank" rel="noopener">webpack-merge</a></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> { smart } = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> base = <span class="built_in">require</span>(<span class="string">'./webpack.base.js'</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = smart(base, {</span><br><span class="line">  <span class="built_in">module</span>: {</span><br><span class="line">    rules: [],</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h4 id="多入口"><a href="#多入口" class="headerlink" title="多入口"></a>多入口</h4><p>有时候我们的页面可以不止一个HTML页面，会有多个页面，所以就需要<strong>多入口</strong><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin=<span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports={</span><br><span class="line">    entry: {</span><br><span class="line">        index: <span class="string">'./src/index.js'</span>,</span><br><span class="line">        login: <span class="string">'./src/login.js'</span></span><br><span class="line">    },</span><br><span class="line">    output: {</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'[name].[hash].js'</span>,</span><br><span class="line">        publicPath: <span class="string">'/'</span></span><br><span class="line">    },</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">            minify: {</span><br><span class="line">                removeAttributeQuotes: <span class="literal">true</span></span><br><span class="line">            },</span><br><span class="line">            hash: <span class="literal">true</span>,</span><br><span class="line">            template: <span class="string">'./src/index.html'</span>,</span><br><span class="line">            chunks: [<span class="string">'index'</span>],</span><br><span class="line">            filename: <span class="string">'index.html'</span></span><br><span class="line">        }),</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin({</span><br><span class="line">            minify: {</span><br><span class="line">                removeAttributeQuotes: <span class="literal">true</span></span><br><span class="line">            },</span><br><span class="line">            hash: <span class="literal">true</span>,</span><br><span class="line">            chunks: [<span class="string">'login'</span>],</span><br><span class="line">            template: <span class="string">'./src/login.html'</span>,</span><br><span class="line">            filename: <span class="string">'login.html'</span></span><br><span class="line">        })</span><br><span class="line">    ],</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><hr><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul><li><a href="https://webpack.docschina.org/configuration/resolve/" target="_blank" rel="noopener">webpack</a></li><li><a href="http://www.zhufengpeixun.cn/plan/html/26.webpack-1-basic.html" target="_blank" rel="noopener">webpackdemo</a></li><li><a href="https://www.cnblogs.com/tugenhua0707/p/9780621.html" target="_blank" rel="noopener">理解webpack之process.env.NODE_ENV详解</a></li><li><a href="https://juejin.im/post/5ab79fa75188255582525400" target="_blank" rel="noopener">webpack4之基础篇</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://zhangyapeng0222.github.io/person_blogs/2018/12/12/跨域/"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="dapeng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="大鹏的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/12/12/跨域/" itemprop="url">跨域</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-12T16:36:52+08:00">2018-12-12 </time></span><span id="/2018/12/12/跨域/" class="leancloud_visitors" data-flag-title="跨域"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数:</span> <span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span title="字数统计">3,315 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 ≈</span> <span title="阅读时长">15</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="跨域总结"><a href="#跨域总结" class="headerlink" title="跨域总结"></a>跨域总结</h2><h3 id="为什么会出现跨域问题"><a href="#为什么会出现跨域问题" class="headerlink" title="为什么会出现跨域问题"></a>为什么会出现跨域问题</h3><p>出于浏览器的<strong>同源策略</strong>限制，浏览器会拒绝跨域请求。</p><p>严格的说，浏览器并不是<strong>拒绝所有的跨域请求</strong>，实际上拒绝的是跨域的<strong>读</strong>操作。</p><ul><li>通常浏览器允许进行跨域<strong>写</strong>操作（Cross-origin writes），如<code>链接</code>，<code>重定向</code>；</li><li>通常浏览器允许跨域资源<strong>嵌入</strong>（Cross-origin embedding），如 <code>img</code>、<code>script</code> 标签；</li><li>通常浏览器不允许跨域<strong>读</strong>操作（Cross-origin reads）。<code>*</code><ul><li><strong>cookie</strong> <strong>localStorage</strong></li><li><strong>DOM元素</strong>也有同源策略 <code>iframe</code></li><li><strong>ajax</strong>也不支持跨域</li></ul></li></ul><h3 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h3><p>如果两个页面拥有相同的<strong>协议</strong>（protocol），<strong>端口</strong>（port）和<strong>主机</strong>（host），那么这两个页面就属于同一个源（origin）。</p><p><img src="http://b.zhangyapeng.club/同源策略-20181217112324.jpg" alt="同源策略-20181217112324"></p><h3 id="实现跨域的方法"><a href="#实现跨域的方法" class="headerlink" title="实现跨域的方法"></a>实现跨域的方法</h3><ul><li><p><strong>jsonp</strong>只能发送<strong>GET</strong>请求,不支持<strong>post</strong>、<strong>put</strong>、<strong>delete</strong>。不安全,容易手<strong>xss</strong>攻击,不采用</p></li><li><p>利用<strong>script标签</strong>不受跨域限制而形成的一种方案。</p></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonp</span>(<span class="params">url,params,cb</span>)</span>{</span><br><span class="line">    <span class="keyword">const</span> script=<span class="built_in">document</span>.createElement(<span class="string">"script"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{</span><br><span class="line">        <span class="built_in">window</span>[cb]=<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">            resolve(data)</span><br><span class="line">            <span class="built_in">document</span>.body.removeChild(script)</span><br><span class="line">        }</span><br><span class="line">        params={...params,cb}</span><br><span class="line">        <span class="keyword">let</span> str=<span class="built_in">Object</span>.keys(params).map(<span class="function"><span class="params">item</span>=&gt;</span>{</span><br><span class="line">            <span class="keyword">return</span> item=params[item]</span><br><span class="line">        }).join(<span class="string">"&amp;"</span>)</span><br><span class="line">        script.src=<span class="string">`<span class="subst">${url}</span>?<span class="subst">${str}</span>`</span></span><br><span class="line">        <span class="built_in">document</span>.body.appendChild(script)</span><br><span class="line">    })</span><br><span class="line">}</span><br><span class="line">jsonp({</span><br><span class="line">url:<span class="string">'http://localhost:3000/say'</span>,</span><br><span class="line">parms:{</span><br><span class="line">                wd:<span class="string">'我爱你'</span></span><br><span class="line">    },</span><br><span class="line">cb:<span class="string">'show'</span></span><br><span class="line">}).then(<span class="function">(<span class="params">res</span>)=&gt;</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h3 id="cors"><a href="#cors" class="headerlink" title="cors"></a>cors</h3><p>跨域资源共享标准新增了一组<strong>HTTP</strong>首部字段，允许服务器声明哪些源站有权限访问哪些资源。</p><h4 id="两种请求"><a href="#两种请求" class="headerlink" title="两种请求"></a>两种请求</h4><hr><h5 id="简单请求（simple-request）"><a href="#简单请求（simple-request）" class="headerlink" title="简单请求（simple request）"></a>简单请求（simple request）</h5><ol><li><p>请求方法是以下三种方法之一：</p><ul><li>HEAD</li><li>GET</li><li>POST</li></ul></li><li><p>HTTP的头信息不超出以下几种字段：</p><ul><li>Accept</li><li>Accept-Language</li><li>Content-Language</li><li>Last-Event-ID</li><li>Content-Type：只限于三个值<ul><li>application/x-www-form-urlencoded</li><li>multipart/form-data</li><li>text/plain</li></ul></li></ul></li></ol><h5 id="非简单请求（not-so-simple-request）"><a href="#非简单请求（not-so-simple-request）" class="headerlink" title="非简单请求（not-so-simple request）"></a>非简单请求（not-so-simple request）</h5><p>凡是<strong>不同时满足</strong>上面两个条件，就属于非简单请求。</p><h4 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h4><p>简单请求只需要<strong>CORS服务端</strong>在接受到携带<strong>Origin</strong>字段的跨域请求后，在<strong>response header</strong>中添加<strong>Access-Control-Allow-Origin</strong>等字段给浏览器做同源判断。</p><p><img src="http://b.zhangyapeng.club/简单请求-20181217152038.png" alt="简单请求-20181217152038"></p><h4 id="非简单请求"><a href="#非简单请求" class="headerlink" title="非简单请求"></a>非简单请求</h4><p>请求方法是<strong>PUT</strong>或<strong>DELETE</strong>，或者<strong>Content-Type</strong>字段的类型是<strong>application/json</strong>,或者人为设置一些<strong>请求头</strong></p><ol><li><p>进行非简单请求时候,浏览器会首先发出类型为<strong>OPTIONS</strong>的<strong>预检请求</strong>，请求地址相同,</p></li><li><p>服务器收到”<strong>预检</strong>“请求以后，检查了<strong>Origin</strong>、<strong>Access-Control-Request-Method</strong>和<strong>Access-Control-Request-Headers</strong>字段以后，确认允许跨源请求，就可以做出回应。</p></li><li><p>关键的是<strong>Access-Control-Allow-Origin</strong>字段，表示<strong><a href="http://api.bob.com" target="_blank" rel="noopener">http://api.bob.com</a></strong>可以请求数据。该字段也可以设为<strong>星号</strong>，表示同意任意<strong>跨源请求</strong>。</p></li><li><p>如果浏览器否定了<strong>预检</strong>请求，会返回一个正常的HTTP回应，但是没有任何<strong>CORS相关的头信息</strong>字段。这时，浏览器就会<strong>认定</strong>，服务器<strong>不同意预检</strong>请求</p></li><li><p>一旦服务器通过了”<strong>预检</strong>“请求，以后每次浏览器正常的CORS请求，就都跟<strong>简单请求</strong>一样，会有一个<strong>Origin</strong>头信息字段。<strong>服务器的回应</strong>，也都会有一个<strong>Access-Control-Allow-Origin</strong>头信息字段。<strong>Access-Control-Allow-Origin</strong>字段是每次回应都必定包含的!</p></li></ol><p><img src="http://b.zhangyapeng.club/cors-20181217144424.jpg" alt="cors-20181217144424"></p><p>server.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 白名单</span></span><br><span class="line"><span class="keyword">let</span> whitList=[<span class="string">'http://localhost:3000'</span>]</span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>{</span><br><span class="line">    <span class="keyword">let</span> origin=req.headers.origin;</span><br><span class="line">    <span class="keyword">if</span>(whitList.includes(origin)){</span><br><span class="line">        <span class="comment">// 设置那个源可以访问我</span></span><br><span class="line">        res.setHeader(<span class="string">'Access-Control-Allow-Origin'</span>,origin) <span class="comment">//允许那个源访问我</span></span><br><span class="line">        res.setHeader(<span class="string">'Access-Control-Allow-Headers'</span>,<span class="string">'name,age'</span>) <span class="comment">//允许携带那个头访问我</span></span><br><span class="line">        res.setHeader(<span class="string">'Access-Control-Allow-Methods'</span>,<span class="string">'PUT'</span>)<span class="comment">//默认GET POST //允许那个方法访问我</span></span><br><span class="line">        res.setHeader(<span class="string">'Access-Control-Max-Age'</span>,<span class="number">6</span>)<span class="comment">//options没6s发送一次 //预检的存活时间</span></span><br><span class="line">        res.setHeader(<span class="string">'Access-Control-Allow-Credentials'</span>,<span class="literal">true</span>); <span class="comment">//cookie //允许携带cookie</span></span><br><span class="line">        res.setHeader(<span class="string">'Access-Control-Expose-Headers'</span>,<span class="string">'name,age'</span>) <span class="comment">//后台给前台发送的头'name'是安全的，前端可以获取到</span></span><br><span class="line">        <span class="keyword">if</span>(req.method===<span class="string">'OPTIONS'</span>){ <span class="comment">// 预检请求</span></span><br><span class="line">            res.end();<span class="comment">//options请求不做任何处理</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    next()</span><br><span class="line">})</span><br><span class="line">app.put(<span class="string">"/getData"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(req.headers) <span class="comment">//请求发过来了,浏览器屏蔽了</span></span><br><span class="line">    res.setHeader(<span class="string">'name'</span>,<span class="string">'zh'</span>)</span><br><span class="line">    res.end(<span class="string">'我不爱你'</span>)</span><br><span class="line">})</span><br><span class="line">app.listen(<span class="number">3001</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>client.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> xhr=<span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">       <span class="comment">// xhr.open("GET",'http://localhost:3001/getData?wd=1',true) //是否异步</span></span><br><span class="line">       <span class="built_in">document</span>.cookie=<span class="string">'name=zyp'</span> <span class="comment">//cookie不允许跨域</span></span><br><span class="line">       xhr.withCredentials=<span class="literal">true</span> ;<span class="comment">//携带凭证</span></span><br><span class="line">       xhr.open(<span class="string">"POST"</span>,<span class="string">'http://localhost:3001/getData'</span>,<span class="literal">true</span>)</span><br><span class="line">       <span class="comment">// xhr.setRequestHeader('name','zyp')</span></span><br><span class="line">       xhr.setRequestHeader(<span class="string">'Content-Type'</span>,<span class="string">'application/x-www-form-urlencoded'</span>)</span><br><span class="line">        xhr.setRequestHeader(<span class="string">'age'</span>,<span class="string">'1'</span>)</span><br><span class="line">       xhr.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">           <span class="keyword">if</span>(xhr.readyState===<span class="number">4</span> &amp;&amp; xhr.status&gt;=<span class="number">200</span> &amp;&amp; xhr.status&lt;=<span class="number">300</span> || xhr.status==<span class="number">304</span>){</span><br><span class="line">               <span class="built_in">console</span>.log(xhr.response)</span><br><span class="line">               <span class="built_in">console</span>.log(xhr.getResponseHeader(<span class="string">'name'</span>))</span><br><span class="line">           }</span><br><span class="line">       }</span><br><span class="line">       xhr.send()</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h3><p>如果两个网页<strong>不同源</strong>，就无法拿到<strong>对方的DOM</strong>。典型的例子是<strong>iframe窗口</strong>和window.open方法打开的窗口，它们与<strong>父窗口无法通信</strong>。</p><p>比如，父窗口运行下面的命令，如果<strong>iframe</strong>窗口不是同源，就会报错。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">"myIFrame"</span>).contentWindow.document</span><br><span class="line"><span class="comment">// Uncaught DOMException: Blocked a frame from accessing a cross-origin frame.</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>当你的页面处于最顶层，也就是外层没有<code>iframe</code>包裹你，求这时<code>window === window.parent</code>的返回值。</p><h3 id="document-domain"><a href="#document-domain" class="headerlink" title="document.domain"></a>document.domain</h3><p>如果两个窗口<strong>一级域名相同</strong>，只是<strong>二级域名不同</strong>，那么设置<strong>document.domain</strong>属性，就可以规避同源政策，拿到DOM。</p><p>A网页是<code>http://w1.example.com/a.html</code>，B网页是<code>http://w2.example.com/b.html</code>，那么只要设置相同的<code>document.domain</code>，两个网页就可以共享Cookie。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.domain = <span class="string">'example.com'</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>这种方法只适用于 <code>Cookie</code> 和 <code>iframe</code> 窗口，<code>LocalStorage</code> 和 <code>IndexDB</code> 无法通过这种方法，规避同源政策。</p><p>服务器也可以在设置Cookie的时候，指定Cookie的所属域名为一级域名，比如<code>.example.com</code><br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>-Cookie: key=value; domain=.example.com; path=<span class="regexp">/</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这样的话，二级域名和三级域名不用做任何设置，都可以读取这个Cookie</p><h3 id="PostMessage"><a href="#PostMessage" class="headerlink" title="PostMessage"></a>PostMessage</h3><p><strong>PostMessage</strong>是HTML5为了解决<strong>文档通信</strong>而引入了<strong>跨文档通信</strong> API（Cross-document messaging）这个API为window对象新增了一个<strong>window.postMessage</strong>方法，允许<strong>跨窗口通信</strong>，不论这两个窗口是否<strong>同源</strong>。</p><blockquote><p>它可用于解决以下方面的问题：</p></blockquote><ul><li>页面和其打开的新窗口的数据传递</li><li>多窗口之间消息传递</li><li>页面与嵌套的iframe消息传递</li><li>上面三个场景的跨域数据传递</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otherWindow.postMessage(message, targetOrigin, [transfer]);</span><br></pre></td></tr></tbody></table></figure><ul><li><p><strong>otherWindow</strong>:<strong>其他窗口</strong>的一个引用，比如<strong>iframe</strong>的<strong>contentWindow</strong>属性、执行<strong>window.open</strong>返回的窗口对象、或者是命名过或数值索引的<strong>window.frames</strong>。</p></li><li><p><strong>message</strong>:html5规范支持任意基本类型或可复制的对象，<code>但部分浏览器只支持字符串，所以传参时最好用JSON.stringify()序列化</code>。</p></li><li><p><strong>targetOrigin</strong>:接收消息的窗口的源（<strong>origin</strong>），即”<code>协议 + 域名 + 端口</code>“。也可以设为<code>*</code>，表示不限制域名，向所有窗口发送，<code>URL</code>会被忽略，所以可以不写，这个参数是为了安全考虑</p></li><li><p><strong>transfer[可选]</strong>：是一串和<strong>message</strong>同时传递的 <strong>Transferable</strong> 对象. 这些对象的所有权将被转移给消息的接收方，而发送一方将不再保有所有权</p></li></ul><p>子窗口向父窗口发送消息的写法类似。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.opener.postMessage(<span class="string">'Nice to see you'</span>, <span class="string">'http://aaa.com'</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>父窗口和子窗口都可以通过<strong>message</strong>事件，监听对方的消息。<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(e.data);</span><br><span class="line">},<span class="literal">false</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>message</strong>事件的事件对象<strong>event</strong>，提供以下三个属性</p><ul><li><strong>event.source</strong>：发送消息的窗口,子窗口可以通过它引用父窗口，然后发送消息</li><li><strong>event.origin</strong>: 消息发向的网址,可以过滤不是发给本窗口的消息</li><li><strong>event.data</strong>: 消息内容</li></ul><h4 id="读写其他窗口-gt-window-open"><a href="#读写其他窗口-gt-window-open" class="headerlink" title="读写其他窗口->window.open"></a>读写其他窗口-&gt;<a href="https://www.cnblogs.com/milo-xie/p/6569017.html" target="_blank" rel="noopener">window.open</a></h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//a.html</span></span><br><span class="line">    <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> popup = <span class="built_in">window</span>.open(<span class="string">'http://localhost:3001/b.html'</span>);</span><br><span class="line"></span><br><span class="line">        popup.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{  <span class="comment">//必须要有onload</span></span><br><span class="line">            <span class="comment">// 假设当前页面没有改变location，这条语句会成功添加message到发送队列中去（targetOrigin设置对了）</span></span><br><span class="line">            popup.postMessage(<span class="string">"hello there!"</span>, <span class="string">"http://localhost:3001"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">receiveMessage</span>(<span class="params">event</span>) </span>{</span><br><span class="line">                <span class="keyword">if</span> (event.origin !== <span class="string">"http://localhost:3000"</span>) {</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="built_in">console</span>.log(event.data);</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>, receiveMessage, <span class="literal">false</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//b.html</span></span><br><span class="line">    <span class="built_in">document</span>.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">document</span>.readyState)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">document</span>.readyState === <span class="string">'complete'</span>) {</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'message'</span>)</span><br><span class="line">            <span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, receiveMessage, <span class="literal">false</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">receiveMessage</span>(<span class="params">event</span>) </span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'in-&gt;message'</span>)</span><br><span class="line">        <span class="keyword">if</span> (event.origin !== <span class="string">"http://localhost:3000"</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'message'</span>, event.data);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'origin'</span>, event.source);</span><br><span class="line">        <span class="built_in">document</span>.write(event.data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 假设你已经验证了所受到信息的origin (任何时候你都应该这样做), 一个很方便的方式就是把enent.source</span></span><br><span class="line">        <span class="comment">// 作为回信的对象，并且把event.origin作为targetOrigin</span></span><br><span class="line">        event.source.postMessage(<span class="string">"hi there yourself!  the secret response "</span> + <span class="string">"is: rheeeeet!"</span>, event.origin);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h4 id="读写其他窗口-gt-iframe"><a href="#读写其他窗口-gt-iframe" class="headerlink" title="读写其他窗口->iframe"></a>读写其他窗口-&gt;iframe</h4><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- a.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://localhost:3001/b.html"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span> <span class="attr">id</span>=<span class="string">"frame"</span> <span class="attr">onload</span>=<span class="string">"load()"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"></span>)</span>{</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> frame=<span class="built_in">document</span>.getElementById(<span class="string">"frame"</span>)</span></span><br><span class="line"><span class="javascript">            frame.contentWindow.postMessage(<span class="string">'我爱你'</span>,<span class="string">'http://localhost:3001'</span>)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">window</span>.onmessage=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>{</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(e.data)</span></span><br><span class="line"><span class="undefined">            }</span></span><br><span class="line"><span class="undefined">        }</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- b.html --&gt;</span><br><span class="line"><span class="built_in">window</span>.onmessage=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>{</span><br><span class="line">            <span class="built_in">console</span>.log(e.data)</span><br><span class="line">            e.source.postMessage(<span class="string">'我不爱你'</span>,e.origin)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="window-name"><a href="#window-name" class="headerlink" title="window.name"></a>window.name</h3><p>浏览器窗口有<strong>window.name</strong>属性。这个属性的最大特点是，无论是否<strong>同源</strong>，只要在<strong>同一个窗口</strong>里，前一个网页设置了这个属性，后一个网页可以<strong>读取它</strong>。</p><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><p>这种方法的优点是，<strong>window.name</strong>容量很大，可以放置非常长的字符串；缺点是必须监听子窗口<strong>window.name</strong>属性的变化，影响网页性能。</p><h4 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h4><ul><li>a和b是同域 <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a></li><li>c是独立的 <a href="http://localhost:3001" target="_blank" rel="noopener">http://localhost:3001</a></li><li>a获取c的数据</li><li>a先引用c,c把值放到window.name上把a引用的地址改到b</li></ul><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- a.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://localhost:3001/c.html"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span> <span class="attr">onload</span>=<span class="string">"load()"</span> <span class="attr">id</span>=<span class="string">"iframe"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> first=<span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"></span>)</span>{</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> iframe=<span class="built_in">document</span>.getElementById(<span class="string">"iframe"</span>)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span>(first){</span></span><br><span class="line"><span class="javascript">                iframe.src=<span class="string">'http://localhost:3000/b.html'</span></span></span><br><span class="line"><span class="javascript">                first=<span class="literal">false</span></span></span><br><span class="line"><span class="javascript">            }<span class="keyword">else</span>{</span></span><br><span class="line"><span class="javascript">               <span class="built_in">console</span>.log(iframe.contentWindow.name) </span></span><br><span class="line"><span class="undefined">            }</span></span><br><span class="line"><span class="undefined">            </span></span><br><span class="line"><span class="undefined">        }</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- c.html --&gt;</span><br><span class="line"><span class="built_in">window</span>.name=<span class="string">'我爱你'</span></span><br></pre></td></tr></tbody></table></figure><h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><p><strong>片段标识符</strong>（fragment identifier）指的是，<code>URL</code>的<code>#</code>号后面的部分，比如<code>http://example.com/x.html#fragment的#fragment</code>。如果只是改变片段标识符，页面不会重新刷新</p><ul><li>a,b同源,c不同源</li><li>目的<code>a</code>想访问<code>c</code></li><li><code>a</code>给<code>c</code>穿一个<code>hash</code>值,<code>c</code>收到<code>hash</code>值后,<code>c</code>把<code>hash</code>值传递给<code>b</code>, <code>b</code>将结果放到<code>a</code>的<code>hash</code>值中</li></ul><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- a.html --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://localhost:3001/c.html#iloveyou"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">       <span class="built_in">window</span>.onhashchange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span></span><br><span class="line"><span class="javascript">           <span class="built_in">console</span>.log(location.hash)</span></span><br><span class="line"><span class="undefined">       }</span></span><br><span class="line"><span class="undefined">   </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>b.html<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.parent.parent.location.hash=location.hash</span><br></pre></td></tr></tbody></table></figure><p></p><p>c.html<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(location.hash)</span><br><span class="line">  <span class="keyword">let</span> iframe=<span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>)</span><br><span class="line">  iframe.src=<span class="string">'http://localhost:3000/b.html'</span>+location.hash+<span class="string">'1'</span></span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(iframe)</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h3><p>WebSocket对象提供了用于创建和管理 <code>WebSocket</code> 连接，以及可以通过该连接发送和接收数据的 API。它是基于TCP的全双工通信,即服务端和客户端可以双向进行通讯，并且允许跨域通讯。基本协议有<code>ws://</code>(非加密)和<code>wss://</code>(加密)</p><p>socket.html<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">'ws://localhost:3000'</span>);</span><br><span class="line"><span class="comment">// 给服务器发消息</span></span><br><span class="line">socket.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    socket.send(<span class="string">'hello server'</span>)</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 接收服务器回复的消息</span></span><br><span class="line">socket.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(e.data)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>server.js<br></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">let</span> app = express();</span><br><span class="line"><span class="keyword">let</span> WebSocket = <span class="built_in">require</span>(<span class="string">'ws'</span>);<span class="comment">//npm i ws</span></span><br><span class="line"><span class="comment">// 设置服务器域为3000端口</span></span><br><span class="line"><span class="keyword">let</span> wss = <span class="keyword">new</span> WebSocket.Server({<span class="attr">port</span>:<span class="number">3000</span>});</span><br><span class="line"><span class="comment">//连接</span></span><br><span class="line">wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ws</span>)</span>{</span><br><span class="line">    <span class="comment">// 接收客户端传来的消息</span></span><br><span class="line">    ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">        <span class="comment">// 服务端回复消息</span></span><br><span class="line">        ws.send(<span class="string">'hello client'</span>)</span><br><span class="line">    })</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p><a href="https://link.juejin.im/?target=https%3A%2F%2Fwww.nginx.com%2Fresources%2Fwiki%2F" target="_blank" rel="noopener">Nginx (engine x)</a> 是一个高性能的<a href="https://link.juejin.im/?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2FHTTP" target="_blank" rel="noopener">HTTP</a>和<a href="https://link.juejin.im/?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%25E5%258F%258D%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%2F7793488" target="_blank" rel="noopener">反向代理</a>服务器，也是一个<code>IMAP/POP3/SMTP</code>服务器。</p><p>案例：在<code>nginx</code>根目录下创建<code>json/a.json</code>，里面随便放些内容<br></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 代表输入/时默认去打开root目录下的html文件夹</span><br><span class="line">location / {</span><br><span class="line">    root html;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">}</span><br><span class="line"># 代表输入任意.json后去打开json文件夹</span><br><span class="line"># location 目的地 去哪里找</span><br><span class="line"># ~ 忽略大小写 .匹配所有 * 0-任意字符</span><br><span class="line">location ~.*\.json{</span><br><span class="line">    root json;</span><br><span class="line">    add_header "Access-Control-Allow-Origin" "*";</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="http-proxy-middleware"><a href="#http-proxy-middleware" class="headerlink" title="http-proxy-middleware"></a>http-proxy-middleware</h3><p>NodeJS 中间件 <strong>http-proxy-middleware</strong> 实现跨域代理，原理大致与 <code>nginx</code> 相同，都是通过启一个代理服务器，实现数据的转发，也可以通过设置 <code>cookieDomainRewrite</code> 参数修改响应头中 <code>cookie</code> 中的域名，实现当前域的 <code>cookie</code> 写入，方便接口登录认证</p><ul><li><p>webpack.config.js</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports={</span><br><span class="line">devServer: {</span><br><span class="line">        historyApiFallback: <span class="literal">true</span>,</span><br><span class="line">        proxy: [{</span><br><span class="line">            context: <span class="string">'/login'</span>,</span><br><span class="line">            target: <span class="string">'http://www.proxy2.com:8080'</span>,  <span class="comment">// 代理跨域目标接口</span></span><br><span class="line">            changeOrigin: <span class="literal">true</span>,</span><br><span class="line">            secure: <span class="literal">false</span>,  <span class="comment">// 当代理某些 https 服务报错时用</span></span><br><span class="line">            cookieDomainRewrite: <span class="string">'www.domain1.com'</span>  <span class="comment">// 可以为 false，表示不修改</span></span><br><span class="line">        }],</span><br><span class="line">        noInfo: <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p>node.js</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> proxy = <span class="built_in">require</span>(<span class="string">"http-proxy-middleware"</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(</span><br><span class="line">    <span class="string">"/"</span>,</span><br><span class="line">    proxy({</span><br><span class="line">        <span class="comment">// 代理跨域目标接口</span></span><br><span class="line">        target: <span class="string">"http://www.proxy2.com:8080"</span>,</span><br><span class="line">        changeOrigin: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改响应头信息，实现跨域并允许带 cookie</span></span><br><span class="line">        onProxyRes: <span class="function"><span class="keyword">function</span>(<span class="params">proxyRes, req, res</span>) </span>{</span><br><span class="line">            res.header(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"http://www.proxy1.com"</span>);</span><br><span class="line">            res.header(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">        },</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改响应信息中的 cookie 域名</span></span><br><span class="line">        cookieDomainRewrite: <span class="string">"www.proxy1.com"</span> <span class="comment">// 可以为 false，表示不修改</span></span><br><span class="line">    })</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></tbody></table></figure></li><li><p>server.js</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer();</span><br><span class="line"><span class="keyword">var</span> qs = <span class="built_in">require</span>(<span class="string">"querystring"</span>);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">"request"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> params = qs.parse(req.url.substring(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向前台写 cookie</span></span><br><span class="line">    res.writeHead(<span class="number">200</span>, {</span><br><span class="line">        <span class="string">"Set-Cookie"</span>: <span class="string">"l=a123456;Path=/;Domain=www.proxy2.com;HttpOnly"</span> <span class="comment">// HttpOnly：脚本无法读取</span></span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    res.write(<span class="built_in">JSON</span>.stringify(params));</span><br><span class="line">    res.end();</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">server.listen(<span class="string">"8080"</span>);</span><br></pre></td></tr></tbody></table></figure></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.cnblogs.com/milo-xie/p/6569017.html" target="_blank" rel="noopener">window.open之postMessage传参数</a></li><li><a href="https://juejin.im/post/5b5ff1dfe51d4519610e26ec" target="_blank" rel="noopener">跨域总结</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">…</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="dapeng"><p class="site-author-name" itemprop="name">dapeng</p><p class="site-description motion-element" itemprop="description">人生不止眼前的苟且，还有诗和远方的田野</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">61</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">62</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zhangyapeng0222" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:48283450@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">© <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">dapeng</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 — <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script type="text/javascript" src="/bundle.js"></script><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  ;
AV.initialize("xb0CD6LXpsiWakv1vqqGvArr-gzGzoHsz", "QY6l9v7TBktnoVFXmbUGUvkW");;

    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  ;

    
    
      flOptions = {};
      
          flOptions.iconStyle = "defalut";
      
          flOptions.boxForm = "vertical";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  ;
L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"left","width":150,"height":500},"mobile":{"show":false},"log":false});</script><script async>window.onload=function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src="/sw-register.js?v="+Date.now(),t.parentNode.insertBefore(e,t)}</script></body></html>